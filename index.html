<!DOCTYPE html>
<html>
<head>

<title>WineBOX: Cognitive Stimulation System</title>

<meta name="description" content="WineBOX is a global and free cognitive stimulation environment using retro games to improve attention, planning, and executive functions in neurodivergent users.">
<meta name="keywords" content="cognitive stimulation, autism, ADHD, executive functions, neurodiversity, retro games, low visual fidelity, wine, dosbox, wasm">

<meta property="og:title" content="WineBOX ‚Äì Cognitive Stimulation System">
<meta property="og:description" content="A free and accessible cognitive stimulation platform using legal retro games to improve attention and mental autonomy.">
<meta property="og:image" content="logo.png">
<meta property="og:url" content="/">
<meta property="og:type" content="website">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="WineBOX ‚Äì Cognitive Stimulation System">
<meta name="twitter:image" content="http://winebox.cloud/logo.png">

<link rel="alternate" href="https://winebox.cloud" hreflang="en" />
<link rel="alternate" href="https://winebox.cloud?lang=es" hreflang="es" />
<link rel="canonical" href="https://winebox.cloud"/>

<link rel="shortcut icon" href="logo.png" sizes="152x152">
<link rel="apple-touch-icon" href="logo.png">

<meta name="theme-color" content="#000"/>
<link rel="manifest" href="manifest.json" />


<script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js');
            });
        }
</script>

<script>
    // PWA Installation Handler
    let deferredPrompt;
    let isPWAInstalled = false;

    // Check if app is already installed
    function isRunningAsPWA() {
        return (window.matchMedia('(display-mode: standalone)').matches) || 
               (window.navigator.standalone) || 
               (document.referrer.includes('android-app://'));
    }

    // Handle beforeinstallprompt event
    window.addEventListener('beforeinstallprompt', (e) => {
        console.log('‚úÖ beforeinstallprompt event fired');
        e.preventDefault();
        deferredPrompt = e;
        showInstallButton();
    });

    // Check on page load
    window.addEventListener('load', () => {
        isPWAInstalled = isRunningAsPWA();
        
        if (isPWAInstalled) {
            console.log('‚úÖ App is running as PWA');
            hideInstallButton();
        } else {
            console.log('‚ÑπÔ∏è App is not installed as PWA');
            checkInstallability();
        }
    });

    // Check if install is possible
    function checkInstallability() {
        if (deferredPrompt) {
            showInstallButton();
        } else {
            // Check after a delay
            setTimeout(() => {
                if (deferredPrompt) {
                    showInstallButton();
                }
            }, 3000);
        }
    }

    // Show install button in header
    function showInstallButton() {
        // Create or get install button
        let installBtn = document.getElementById('installPWA');
        
        if (!installBtn) {
            const headerSystemInfo = document.querySelector('.header-system-info');
            if (!headerSystemInfo) return;
            
            installBtn = document.createElement('button');
            installBtn.id = 'installPWA';
            installBtn.className = 'install-pwa-button';
            installBtn.title = 'Install WineBOX as App';
            installBtn.innerHTML = `
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: currentColor;">
                    <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                </svg>
                <span>Install</span>
            `;
            
            // Insert before battery info
            const batteryInfo = document.getElementById('batteryInfo');
            if (batteryInfo) {
                headerSystemInfo.insertBefore(installBtn, batteryInfo);
            } else {
                headerSystemInfo.appendChild(installBtn);
            }
            
            // Add click event
            installBtn.addEventListener('click', installPWA);
        }
        
        installBtn.style.display = 'flex';
        installBtn.style.alignItems = 'center';
        installBtn.style.gap = '5px';
        installBtn.style.padding = '8px 12px';
        installBtn.style.background = '#0078d4';
        installBtn.style.color = 'white';
        installBtn.style.border = 'none';
        installBtn.style.borderRadius = '4px';
        installBtn.style.cursor = 'pointer';
        installBtn.style.fontSize = '14px';
        installBtn.style.transition = 'background 0.3s';
        
        installBtn.addEventListener('mouseenter', () => {
            installBtn.style.background = '#106ebe';
        });
        
        installBtn.addEventListener('mouseleave', () => {
            installBtn.style.background = '#0078d4';
        });
    }

    // Hide install button
    function hideInstallButton() {
        const installBtn = document.getElementById('installPWA');
        if (installBtn) {
            installBtn.style.display = 'none';
        }
    }

    // Install PWA function
    async function installPWA() {
        console.log('üéØ installPWA called');
        
        if (!deferredPrompt) {
            console.log('‚ùå No deferred prompt available');
            showStatusMessage('Installation not available. Try using Chrome/Edge browser menu.', 'warning');
            return;
        }
        
        try {
            // Show the install prompt
            deferredPrompt.prompt();
            
            // Wait for the user to respond to the prompt
            const choiceResult = await deferredPrompt.userChoice;
            
            if (choiceResult.outcome === 'accepted') {
                console.log('‚úÖ User accepted PWA installation');
                showStatusMessage('WineBOX installed successfully!', 'success');
                isPWAInstalled = true;
                hideInstallButton();
                
                // Close any open modals or menus
                if (isModalOpen) {
                    const modal = document.getElementById('appModal');
                    if (modal) modal.style.display = 'none';
                    isModalOpen = false;
                }
                
                if (isMenuOpen) {
                    toggleMenu();
                }
            } else {
                console.log('‚ùå User dismissed PWA installation');
                showStatusMessage('Installation cancelled', 'warning');
            }
            
            // Clear the deferredPrompt variable
            deferredPrompt = null;
            
        } catch (error) {
            console.error('‚ùå Error installing PWA:', error);
            showStatusMessage('Installation failed. Please try manual installation.', 'error');
        }
    }

    // Manual install instructions
    function showManualInstallInstructions() {
        const instructions = `
            <div style="padding: 20px; max-width: 500px;">
                <h3>Manual Installation</h3>
                <p>To install WineBOX as an app:</p>
                <ul style="text-align: left; padding-left: 20px;">
                    <li><strong>Chrome/Edge:</strong> Click ‚ãÆ (menu) ‚Üí "Install WineBOX"</li>
                    <li><strong>Firefox:</strong> Click ‚â° (menu) ‚Üí "Install WineBOX"</li>
                    <li><strong>Safari:</strong> Click Share ‚Üí "Add to Home Screen"</li>
                    <li><strong>Android Chrome:</strong> ‚ãÆ ‚Üí "Add to Home screen"</li>
                    <li><strong>iOS Safari:</strong> Share ‚Üí "Add to Home Screen"</li>
                </ul>
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="margin-top: 15px; padding: 8px 16px; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Close
                </button>
            </div>
        `;
        
        showStatusMessage('Check browser menu for install option', 'info');
        
        // Show more detailed instructions after delay
        setTimeout(() => {
            const existingModal = document.querySelector('.manual-install-modal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.className = 'manual-install-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #181818;
                color: white;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                border: 1px solid #333;
            `;
            modal.innerHTML = instructions;
            
            document.body.appendChild(modal);
            
            // Close when clicking outside
            setTimeout(() => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }, 100);
        }, 2000);
    }

    // Update showStatusMessage function if needed
    function showStatusMessage(message, type = 'success') {
        const statusMessage = document.getElementById('statusMessage');
        if (!statusMessage) return;
        
        statusMessage.textContent = message;
        statusMessage.className = 'status-message';
        
        if (type === 'warning') {
            statusMessage.style.backgroundColor = '#ff9800';
        } else if (type === 'error') {
            statusMessage.style.backgroundColor = '#f44336';
        } else if (type === 'info') {
            statusMessage.style.backgroundColor = '#2196f3';
        } else {
            statusMessage.style.backgroundColor = '#0078d4';
        }
        
        statusMessage.classList.add('show');
        
        setTimeout(() => {
            statusMessage.classList.remove('show');
        }, 3000);
    }

    // Add to window for global access
    window.installPWA = installPWA;
    window.showManualInstallInstructions = showManualInstallInstructions;
</script>

<style>
 /* ESTILOS PRINCIPALES (manteniendo los existentes) */
 body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #141414; color: #ffffff; }
 .header { background-color: #000000; padding: 15px 0; position: sticky; top: 0; z-index: 100; }
 .header-content { display: flex; align-items: center; max-width: 100%; margin: 0 auto; padding: 0 20px; }
 .logo-container { display: flex; align-items: center; gap: 15px; flex: 1; }
 .logo { font-size: 24px; font-weight: bold; color: #a0a0a0; }
 .menu-button { background-color: #333; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; }
 .menu-button:hover { background-color: #666; }
 .menu-button svg { width: 20px; height: 20px; fill: white; }
 
 .search-container {
     display: flex;
     align-items: center;
     gap: 10px;
     margin-left: auto;
     transition: all 0.3s ease;
 }
 
 .search-toggle {
     background: none;
     border: none;
     color: white;
     cursor: pointer;
     padding: 8px;
     border-radius: 50%;
     transition: all 0.3s ease;
     display: flex;
     align-items: center;
     justify-content: center;
 }
 
 .search-toggle:hover {
     background-color: rgba(255, 255, 255, 0.1);
 }
 
 .search-toggle svg {
     width: 20px;
     height: 20px;
     fill: currentColor;
 }
 
 .search-input {
     padding: 10px 15px;
     border: none;
     border-radius: 20px;
     width: 0;
     background-color: #333;
     color: white;
     opacity: 0;
     transition: all 0.3s ease;
     font-size: 14px;
 }
 
 .search-input.active {
     width: 300px;
     opacity: 1;
 }
 
 .header-system-info {
     display: flex;
     align-items: center;
     gap: 15px;
     margin-left: 20px;
     font-size: 14px;
 }
 
 .battery-info {
     display: flex;
     align-items: center;
     gap: 5px;
     padding: 5px 10px;
     background: rgba(255, 255, 255, 0.1);
     border-radius: 4px;
 }
 
 .battery-icon {
     width: 20px;
     height: 12px;
     border: 1px solid rgba(255, 255, 255, 0.7);
     border-radius: 2px;
     position: relative;
 }
 
 .battery-level {
     height: 10px;
     background: #4CAF50;
     border-radius: 1px;
     margin: 1px;
     transition: width 0.3s ease;
 }
 
 .battery-level.low {
     background: #f44336;
 }
 
 .battery-level.medium {
     background: #ff9800;
 }
 
 .battery-percentage {
     font-size: 12px;
     color: rgba(255, 255, 255, 0.9);
 }
 
 .header-time {
     padding: 5px 10px;
     background: rgba(255, 255, 255, 0.1);
     border-radius: 4px;
     font-weight: 500;
 }
 
 .container { max-width: 100%; margin: 0 auto; padding: 20px; }
 .recent-section { position: relative; margin: 20px 0 40px; }
 .recent-title { font-size: 24px; font-weight: bold; margin-bottom: 15px; }
 .recent-apps-container { position: relative; padding-bottom: 30px; }
 .selected-app-info { position: absolute; bottom: 0; left: 0; width: 100%; background: #4a4a4a; color: white; padding: 8px 15px; border-radius: 4px; font-size: 14px; font-weight: bold; opacity: 0; transition: opacity 0.3s ease; box-shadow: 0 2px 10px rgba(0,0,0,0.5); pointer-events: none; }
 .recent-app.selected ~ .selected-app-info { opacity: 1; }
 .recent-apps { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; }
 .recent-apps::-webkit-scrollbar { display: none; }
 .recent-app { width: 160px; height: 160px; border-radius: 8px; object-fit: cover; cursor: pointer; transition: transform 0.2s; border: 2px solid transparent; flex-shrink: 0; }
 .recent-app:hover { transform: scale(1.1); }
 .recent-app.selected { border: 2px solid #4a4a4a; transform: scale(1.1); }
 .scroll-indicator { position: absolute; right: 0; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.7); color: white; font-size: 24px; width: 30px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 4px; cursor: pointer; opacity: 0; transition: opacity 0.3s; z-index: 10; }
 .recent-apps-container:hover .scroll-indicator { opacity: 1; }
 .categories { display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
 .category-button { background-color: #333; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; transition: background-color 0.3s ease; }
 .category-button:hover, .category-button.active, .category-button.selected { background-color: #666666; }
 .app-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 25px; margin-top: 30px; }
 .app-card { background-color: #2f2f2f; border-radius: 8px; overflow: hidden; transition: transform 0.3s ease; cursor: pointer; position: relative; }
 .app-card:hover { transform: scale(1.05); }
 .app-card.selected { outline: 3px solid #0078d4; transform: scale(1.05); }
 .app-thumbnail { width: 100%; height: 200px; object-fit: cover; }
 .app-info { padding: 15px; }
 .app-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
 .app-category { color: #ccc; margin-bottom: 5px; font-size: 12px; }
 .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); }
 .modal-content { background-color: #181818; margin: 5% auto; padding: 20px; border-radius: 8px; max-width: 800px; width: 90%; position: relative; }
 .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 10px; right: 15px; z-index: 1002; }
 .close:hover, .close:focus { color: #fff; }
 .app-details { margin-top: 20px; }
 .action-button { background-color: #4a4a4a; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; margin-right: 10px; }
 .action-button:hover { background-color: #666666; }
 .install-button { background-color: #0078d4; }
 .install-button:hover { background-color: #106ebe; }
 .uninstall-button { background-color: #d32f2f; }
 .uninstall-button:hover { background-color: #b71c1c; }
 
 /* ========== CORRECCI√ìN DEL MEN√ö LATERAL ========== */
 .side-menu { 
     position: fixed; 
     left: -300px; 
     top: 0; 
     width: 250px; 
     height: 100vh; 
     background-color: #000; 
     z-index: 9999;
     transition: left 0.3s ease; 
     padding: 20px 0; 
     box-shadow: 2px 0 10px rgba(0,0,0,0.5); 
 }
 .side-menu.open { left: 0; }
 .menu-item { display: flex; align-items: center; padding: 12px 20px; color: white; cursor: pointer; transition: background-color 0.3s; }
 .menu-item:hover { background-color: #333; }
 .menu-item.selected { background-color: #444; }
 .menu-item svg { width: 20px; height: 20px; margin-right: 15px; fill: currentColor; }
 .menu-item span { font-size: 14px; }
 .menu-overlay { 
     display: none; 
     position: fixed; 
     top: 0; 
     left: 0; 
     right: 0; 
     bottom: 0; 
     background-color: rgba(0,0,0,0.5); 
     z-index: 9998;
 }
 .menu-overlay.open { display: block; }
 
 .status-message {
     position: fixed;
     top: 20px;
     right: 20px;
     background-color: #0078d4;
     color: white;
     padding: 10px 20px;
     border-radius: 4px;
     z-index: 1001;
     box-shadow: 0 2px 10px rgba(0,0,0,0.3);
     opacity: 0;
     transition: opacity 0.3s;
 }
 .status-message.show {
     opacity: 1;
 }
 
 .app-frame-container {
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: calc(100% - 40px);
     background-color: rgba(0,0,0,0.8);
     display: none;
     z-index: 2000;
 }
 
 .app-frame-container iframe {
     width: 100%;
     height: 100%;
     border: none;
     background-color: white;
 }
 
 .window-controls {
     position: absolute;
     top: 10px;
     right: 10px;
     z-index: 2001;
     display: flex;
     gap: 5px;
 }
 
 .window-control-btn {
     width: 30px;
     height: 30px;
     background: rgba(255, 255, 255, 0.8);
     border: none;
     border-radius: 50%;
     cursor: pointer;
     display: flex;
     align-items: center;
     justify-content: center;
     font-size: 16px;
     font-weight: bold;
     color: #333;
     transition: background-color 0.2s;
 }
 
 .window-control-btn:hover {
     background: rgba(255, 255, 255, 1);
 }
 
 /* ========== CORRECCI√ìN DE LA DOCKBAR ========== */
 .dockbar {
     position: fixed;
     bottom: 0;
     left: 0;
     width: 100%;
     height: 40px;
     background: rgba(30, 30, 30, 0.95);
     backdrop-filter: blur(15px);
     display: flex;
     align-items: center;
     padding: 0 15px;
     gap: 8px;
     z-index: 2500;
     border-top: 1px solid rgba(255, 255, 255, 0.1);
     box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
 }
 
 .dockbar-home {
     width: 32px;
     height: 32px;
     background: rgba(255, 255, 255, 0.1);
     border-radius: 6px;
     display: flex;
     align-items: center;
     justify-content: center;
     cursor: pointer;
     margin-right: 10px;
     transition: all 0.2s ease;
 }
 
 .dockbar-home:hover {
     background: rgba(255, 255, 255, 0.15);
     transform: scale(1.05);
 }
 
 .dockbar-home svg {
     width: 18px;
     height: 18px;
     fill: rgba(255, 255, 255, 0.9);
 }
 
 .dockbar-controls {
     display: flex;
     align-items: center;
     gap: 6px;
 }
 
 .dockbar-icon {
     width: 34px;
     height: 34px;
     cursor: pointer;
     border-radius: 6px;
     padding: 3px;
     transition: all 0.2s ease;
     display: flex;
     align-items: center;
     justify-content: center;
     position: relative;
     background: rgba(255, 255, 255, 0.05);
     border: 1px solid transparent;
     flex-shrink: 0;
 }
 
 .dockbar-app-icon {
     width: 34px;
     height: 34px;
     cursor: pointer;
     border-radius: 6px;
     padding: 2px;
     transition: all 0.2s ease;
     display: flex;
     align-items: center;
     justify-content: center;
     position: relative;
     background: rgba(255, 255, 255, 0.05);
     border: 1px solid transparent;
     flex-shrink: 0;
     overflow: hidden;
 }
 
 .dockbar-app-icon img {
     width: 100%;
     height: 100%;
     object-fit: cover;
     border-radius: 4px;
 }
 
 .dockbar-app-icon.active {
     background: rgba(255, 255, 255, 0.15);
     border: 1px solid rgba(255, 255, 255, 0.2);
     transform: translateY(-1px);
 }
 
 .dockbar-app-icon.active::after {
     content: '';
     position: absolute;
     bottom: -6px;
     left: 50%;
     transform: translateX(-50%);
     width: 3px;
     height: 3px;
     background: #0078d4;
     border-radius: 50%;
 }
 
 .dockbar-app-icon:hover {
     background: rgba(255, 255, 255, 0.1);
     transform: scale(1.05);
 }
 
 .dockbar-app-icon:hover::before {
     content: attr(data-title);
     position: absolute;
     bottom: 100%;
     left: 50%;
     transform: translateX(-50%);
     background: rgba(0, 0, 0, 0.9);
     color: white;
     padding: 6px 12px;
     border-radius: 6px;
     font-size: 12px;
     white-space: nowrap;
     margin-bottom: 8px;
     z-index: 2501;
     pointer-events: none;
     box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
     border: 1px solid rgba(255, 255, 255, 0.1);
 }
 
 .dockbar-app-icon:hover::after {
     content: '';
     position: absolute;
     bottom: 100%;
     left: 50%;
     transform: translateX(-50%);
     width: 0;
     height: 0;
     border-left: 5px solid transparent;
     border-right: 5px solid transparent;
     border-top: 5px solid rgba(0, 0, 0, 0.9);
     margin-bottom: 3px;
     z-index: 2502;
     pointer-events: none;
 }
 
 .dockbar-icon svg {
     width: 22px;
     height: 22px;
     fill: rgba(255, 255, 255, 0.9);
 }
 
 .dockbar-icon.active {
     background: rgba(255, 255, 255, 0.15);
     border: 1px solid rgba(255, 255, 255, 0.2);
     transform: translateY(-1px);
 }
 
 .dockbar-icon.active::after {
     content: '';
     position: absolute;
     bottom: -6px;
     left: 50%;
     transform: translateX(-50%);
     width: 3px;
     height: 3px;
     background: #0078d4;
     border-radius: 50%;
 }
 
 .dockbar-icon:hover {
     background: rgba(255, 255, 255, 0.1);
     transform: scale(1.05);
 }
 
 .dockbar-icon:hover::before {
     content: attr(data-title);
     position: absolute;
     bottom: 100%;
     left: 50%;
     transform: translateX(-50%);
     background: rgba(0, 0, 0, 0.9);
     color: white;
     padding: 6px 12px;
     border-radius: 6px;
     font-size: 12px;
     white-space: nowrap;
     margin-bottom: 8px;
     z-index: 2501;
     pointer-events: none;
     box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
     border: 1px solid rgba(255, 255, 255, 0.1);
 }
 
 .dockbar-icon:hover::after {
     content: '';
     position: absolute;
     bottom: 100%;
     left: 50%;
     transform: translateX(-50%);
     width: 0;
     height: 0;
     border-left: 5px solid transparent;
     border-right: 5px solid transparent;
     border-top: 5px solid rgba(0, 0, 0, 0.9);
     margin-bottom: 3px;
     z-index: 2502;
     pointer-events: none;
 }
 
 .dockbar-separator {
     width: 1px;
     height: 20px;
     background: rgba(255, 255, 255, 0.2);
     margin: 0 10px;
 }
 
 .dockbar-apps {
     display: flex;
     align-items: center;
     gap: 6px;
     flex: 1;
     overflow-x: auto;
     padding: 0 10px;
 }
 
 .dockbar-apps::-webkit-scrollbar {
     height: 0px;
     width: 0px;
     background: transparent;
 }
 
 .dockbar-apps {
     scrollbar-width: none;
     -ms-overflow-style: none;
 }
 
 .dockbar-system {
     display: flex;
     align-items: center;
     gap: 10px;
     margin-left: auto;
 }
 
 .launcher {
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background: rgba(10, 10, 10, 0.98);
     backdrop-filter: blur(20px);
     z-index: 3000;
     display: none;
     flex-direction: column;
     border: none;
     border-radius: 0;
 }
 
 .launcher.open {
     display: flex;
 }
 
 .launcher-header {
     padding: 30px 40px 20px;
     border-bottom: 1px solid rgba(255, 255, 255, 0.1);
     flex-shrink: 0;
 }
 
 .launcher-search {
     width: 100%;
     max-width: 800px;
     margin: 0 auto;
 }
 
 .launcher-search input {
     width: 100%;
     padding: 20px 25px;
     background: rgba(255, 255, 255, 0.1);
     border: 2px solid rgba(255, 255, 255, 0.2);
     border-radius: 15px;
     color: white;
     font-size: 24px;
     text-align: center;
     transition: all 0.3s ease;
 }
 
 .launcher-search input:focus {
     border-color: #0078d4;
     background: rgba(255, 255, 255, 0.15);
     outline: none;
 }
 
 .launcher-search input::placeholder {
     color: rgba(255, 255, 255, 0.5);
     font-size: 24px;
 }
 
 .launcher-apps-container {
     flex: 1;
     overflow: hidden;
     padding: 20px 40px 40px;
 }
 
 .launcher-apps {
     display: grid;
     grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
     gap: 20px;
     max-width: 1200px;
     margin: 0 auto;
     height: 100%;
     overflow-y: auto;
     padding: 10px;
 }
 
 .launcher-apps::-webkit-scrollbar {
     width: 0px;
     height: 0px;
     background: transparent;
 }
 
 .launcher-app {
     display: flex;
     flex-direction: column;
     align-items: center;
     padding: 20px 15px;
     border-radius: 12px;
     cursor: pointer;
     transition: all 0.3s ease;
     background: rgba(255, 255, 255, 0.05);
     border: 2px solid transparent;
 }
 
 .launcher-app:hover {
     background: rgba(255, 255, 255, 0.1);
     transform: translateY(-5px);
     border-color: rgba(255, 255, 255, 0.2);
 }
 
 .launcher-app:active {
     transform: translateY(-2px);
 }
 
 .launcher-app.selected {
     background: rgba(255, 255, 255, 0.15);
     border-color: #0078d4;
     transform: translateY(-3px);
 }
 
 .launcher-app img {
     width: 80px;
     height: 80px;
     border-radius: 12px;
     margin-bottom: 12px;
     object-fit: cover;
 }
 
 .launcher-app span {
     font-size: 14px;
     text-align: center;
     color: rgba(255, 255, 255, 0.9);
     font-weight: 500;
 }
 
 .launcher-close {
     position: absolute;
     top: 20px;
     right: 20px;
     background: rgba(255, 255, 255, 0.1);
     border: none;
     color: white;
     width: 50px;
     height: 50px;
     border-radius: 50%;
     font-size: 24px;
     cursor: pointer;
     display: flex;
     align-items: center;
     justify-content: center;
     transition: all 0.3s ease;
 }
 
 .launcher-close:hover {
     background: rgba(255, 255, 255, 0.2);
     transform: scale(1.1);
 }
 
 .search-results-count {
     text-align: center;
     color: rgba(255, 255, 255, 0.6);
     font-size: 16px;
     margin-top: 15px;
 }
 
 .app-frame-container iframe {
     width: 100%;
     height: 100%;
     border: none;
     background-color: white;
     scrollbar-width: none;
     -ms-overflow-style: none;
 }
 
 .app-frame-container iframe::-webkit-scrollbar {
     width: 0px;
     height: 0px;
     background: transparent;
 }
 
 .iframe-scroll-container {
     width: 100%;
     height: 100%;
     overflow: hidden;
     position: relative;
 }
 
 .iframe-scroll-content {
     width: 100%;
     height: 100%;
     overflow: auto;
     -webkit-overflow-scrolling: touch;
     scrollbar-width: none;
     -ms-overflow-style: none;
 }
 
 .iframe-scroll-content::-webkit-scrollbar {
     display: none;
 }
 
 .container {
     padding-bottom: 60px;
 }
 
 .scroll-invisible {
     scrollbar-width: none;
     -ms-overflow-style: none;
 }
 
 .scroll-invisible::-webkit-scrollbar {
     width: 0px;
     height: 0px;
     background: transparent;
 }
 
 * {
     scrollbar-width: none;
     -ms-overflow-style: none;
 }
 
 *::-webkit-scrollbar {
     width: 0px;
     height: 0px;
     background: transparent;
 }
 
 *::-webkit-scrollbar-track {
     background: transparent;
 }
 
 *::-webkit-scrollbar-thumb {
     background: transparent;
     border: none;
 }
 
 *::-webkit-scrollbar-corner {
     background: transparent;
 }
 
 .uninstall-confirm {
     display: none;
     position: fixed;
     top: 50%;
     left: 50%;
     transform: translate(-50%, -50%);
     background: #181818;
     padding: 30px;
     border-radius: 8px;
     z-index: 1003;
     text-align: center;
     box-shadow: 0 4px 20px rgba(0,0,0,0.5);
     border: 1px solid #333;
 }
 
 .uninstall-confirm.active {
     display: block;
 }
 
 .uninstall-confirm-buttons {
     display: flex;
     gap: 10px;
     justify-content: center;
     margin-top: 20px;
 }
 
 .uninstall-info {
     color: #ff6b6b;
     font-size: 11px;
     margin-top: 5px;
 }

 /* MODIFICACIONES PARA APLICACIONES RECIENTES */
 .recent-app.featured {
     width: 480px;
     height: 160px;
     border: 3px solid #0078d4;
     box-shadow: 0 0 15px rgba(0, 120, 212, 0.5);
 }

 .recent-app.featured:hover {
     transform: scale(1.08);
 }

 .recent-app.featured::after {
     content: '√öltima';
     position: absolute;
     top: -10px;
     right: -10px;
     background: #0078d4;
     color: white;
     padding: 3px 8px;
     border-radius: 10px;
     font-size: 10px;
     font-weight: bold;
 }

 .recent-apps-container {
     height: 200px;
 }

 .menu-item.focused {
     background-color: #333;
     border-left: 3px solid #0078d4;
 }

 .menu-item.focused.selected {
     background-color: #444;
     border-left: 3px solid #0078d4;
 }

 .app-card:focus,
 .recent-app:focus,
 .category-button:focus,
 .menu-item:focus {
     outline: 2px solid #0078d4;
     outline-offset: 2px;
 }

 .focus-indicator {
     position: fixed;
     top: 10px;
     right: 10px;
     background: rgba(0, 0, 0, 0.7);
     color: white;
     padding: 5px 10px;
     border-radius: 4px;
     font-size: 12px;
     z-index: 10;
     pointer-events: none;
     display: none;
 }

 .windows-scroll-container {
     position: relative;
     overflow: hidden;
 }

 .windows-scroll-content {
     overflow: auto;
     scrollbar-width: none;
     -ms-overflow-style: none;
     padding-right: 0px;
     margin-right: 0px;
 }

 .windows-scroll-content::-webkit-scrollbar {
     display: none;
 }

 .windows-scrollbar {
     position: absolute;
     right: 2px;
     top: 2px;
     bottom: 2px;
     width: 8px;
     border-radius: 4px;
     background: rgba(255, 255, 255, 0.1);
     opacity: 0;
     transition: opacity 0.3s ease;
     z-index: 100;
 }

 .windows-scrollbar:hover,
 .windows-scroll-container.scrolling .windows-scrollbar {
     opacity: 1;
 }

 .windows-scroll-thumb {
     position: absolute;
     width: 100%;
     background: rgba(255, 255, 255, 0.4);
     border-radius: 4px;
     transition: background 0.2s ease;
     cursor: pointer;
 }

 .windows-scroll-thumb:hover {
     background: rgba(255, 255, 255, 0.6);
 }

 .app-grid-container {
     position: relative;
     height: calc(100vh - 300px);
     overflow: hidden;
 }

 .launcher-apps-container.windows-scroll-container {
     height: calc(100% - 100px);
 }

 .recent-apps-container.windows-scroll-container {
     height: 200px;
 }

 .section-container {
     position: relative;
     min-height: 100vh;
 }

 .section {
     transition: transform 0.3s ease, opacity 0.3s ease;
 }

 .section.hidden {
     opacity: 0;
     pointer-events: none;
     position: absolute;
     top: 0;
     left: 0;
     width: 100%;
 }

 .section.active {
     opacity: 1;
     pointer-events: all;
 }

 .categories.fixed {
     position: sticky;
     top: 70px;
     background-color: #141414;
     z-index: 50;
     padding: 10px 0;
     margin-bottom: 20px;
     border-bottom: 1px solid #333;
 }

 .header.navigation-mode .logo-container.focused,
 .header.navigation-mode .search-container.focused {
     background-color: rgba(255, 255, 255, 0.1);
     border-radius: 4px;
     outline: 2px solid #0078d4;
 }

 .section-indicator {
     position: fixed;
     bottom: 60px;
     left: 50%;
     transform: translateX(-50%);
     background: rgba(0, 0, 0, 0.7);
     color: white;
     padding: 5px 15px;
     border-radius: 20px;
     font-size: 12px;
     z-index: 10;
     pointer-events: none;
     display: none;
 }

 .loading-message {
     text-align: center;
     padding: 40px;
     color: #666;
     font-size: 18px;
 }

 .error-message {
     text-align: center;
     padding: 40px;
     color: #ff6b6b;
     font-size: 18px;
 }

 .logo-container.focused,
 .search-container.focused {
     background-color: rgba(255, 255, 255, 0.1);
     border-radius: 4px;
     outline: 2px solid #0078d4;
 }

 .logo-container.focused .menu-button,
 .search-container.focused .search-toggle {
     background-color: rgba(255, 255, 255, 0.2);
 }

 .focus-indicator {
     position: fixed;
     top: 10px;
     right: 10px;
     background: rgba(0, 0, 0, 0.7);
     color: white;
     padding: 5px 10px;
     border-radius: 4px;
     font-size: 12px;
     z-index: 10000;
     pointer-events: none;
 }

 .app-grid {
     display: grid;
     grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
     gap: 25px;
     margin-top: 30px;
 }

 .modal-actions {
     display: flex;
     gap: 10px;
     justify-content: center;
     margin-top: 20px;
 }

 .modal-action-button {
     background-color: #4a4a4a;
     color: white;
     border: none;
     padding: 10px 20px;
     border-radius: 4px;
     cursor: pointer;
     transition: background-color 0.3s ease;
     min-width: 120px;
 }

 .modal-action-button:hover {
     background-color: #666666;
 }

 .modal-action-button.selected {
     background-color: #0078d4;
     outline: 2px solid #0078d4;
     outline-offset: 2px;
 }

 .modal-action-button.install {
     background-color: #0078d4;
 }

 .modal-action-button.install:hover {
     background-color: #106ebe;
 }

 .modal-action-button.uninstall {
     background-color: #d32f2f;
 }

 .modal-action-button.uninstall:hover {
     background-color: #b71c1c;
 }

 .uninstall-confirm-buttons .action-button.selected {
     outline: 2px solid #0078d4;
     outline-offset: 2px;
 }

 /* ========== NUEVOS ESTILOS PARA SCROLL T√ÅCTIL ========== */
 .recent-apps-container {
     position: relative;
     overflow: hidden;
     cursor: grab;
 }

 .recent-apps-container.grabbing {
     cursor: grabbing;
 }

 .recent-apps {
     display: flex;
     gap: 15px;
     padding-bottom: 10px;
     -webkit-overflow-scrolling: touch;
     scroll-behavior: smooth;
     user-select: none;
 }

 /* ========== FLECHAS DE NAVEGACI√ìN MEJORADAS (PARA BOTONES) ========== */
 .scroll-arrow {
     position: absolute;
     top: 50%;
     transform: translateY(-50%);
     background-color: rgba(0, 0, 0, 0.8); /* M√°s visible */
     color: white;
     width: 50px; /* M√°s grande */
     height: 50px; /* M√°s grande */
     border-radius: 50%;
     display: flex;
     align-items: center;
     justify-content: center;
     cursor: pointer;
     z-index: 100;
     border: 2px solid rgba(255, 255, 255, 0.5); /* Borde m√°s visible */
     transition: all 0.3s ease;
     font-size: 24px; /* Texto m√°s grande */
     font-weight: bold;
     opacity: 0.7; /* Inicialmente semi-transparente */
 }

 .scroll-arrow:hover {
     background-color: rgba(0, 120, 212, 0.9); /* Color azul al hover */
     transform: translateY(-50%) scale(1.1);
     opacity: 1;
     border-color: #0078d4;
 }

 .scroll-arrow:active {
     transform: translateY(-50%) scale(0.95);
 }

 .scroll-arrow.left {
     left: 10px;
 }

 .scroll-arrow.right {
     right: 10px;
 }

 /* Mostrar flechas siempre que haya scroll posible */
 .scroll-arrow:not(.hidden) {
     display: flex !important;
 }

 /* Solo ocultar cuando realmente no hay scroll posible */
 .scroll-arrow.hidden {
     display: none !important;
     opacity: 0;
     pointer-events: none;
 }

 /* Mostrar flechas cuando el contenedor est√° siendo hover */
 .recent-apps-container:hover .scroll-arrow {
     opacity: 1;
 }

 /* Mejorar visibilidad para dispositivos t√°ctiles */
 @media (hover: none) and (pointer: coarse) {
     .scroll-arrow {
         width: 60px; /* M√°s grande para touch */
         height: 60px;
         opacity: 0.8; /* M√°s visible por defecto */
         background-color: rgba(0, 0, 0, 0.9);
     }
     
     .scroll-arrow:active {
         background-color: rgba(0, 120, 212, 0.8);
         transform: translateY(-50%) scale(0.9);
     }
 }

 /* Indicador de scroll para secci√≥n de apps */
 .app-grid-container {
     position: relative;
     height: calc(100vh - 300px);
     overflow: hidden;
     cursor: default;
 }

 .app-grid {
     display: grid;
     grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
     gap: 25px;
     margin-top: 30px;
     padding-bottom: 20px;
     user-select: none;
 }

 /* Scrollbar personalizada para modo touch */
 .windows-scroll-content.touch-scroll {
     -webkit-overflow-scrolling: touch;
     scroll-behavior: smooth;
 }

 .windows-scroll-thumb {
     background: rgba(255, 255, 255, 0.5);
 }

 .windows-scroll-thumb:hover {
     background: rgba(255, 255, 255, 0.8);
 }

 /* Efectos t√°ctiles mejorados */
 .recent-app, .app-card, .launcher-app {
     touch-action: manipulation;
 }

 .recent-app:active, .app-card:active, .launcher-app:active {
     transform: scale(0.95);
     transition: transform 0.1s ease;
 }

 /* ========== NUEVOS ESTILOS PARA MEJORAS VISUALES ========== */
 /* Mejoras para el men√∫ lateral */
 .menu-item.active {
     background-color: #333;
     border-left: 3px solid #0078d4;
 }

 /* ========== CORRECCI√ìN DEL SCROLLBAR DE CATEGOR√çAS ========== */
 .category-scrollbar {
     position: fixed;
     right: 10px;
     top: 50%;
     transform: translateY(-50%);
     width: 8px;
     height: 200px;
     background: rgba(255, 255, 255, 0.1);
     border-radius: 4px;
     z-index: 100;
     opacity: 0;
     transition: opacity 0.3s ease;
     pointer-events: auto;
 }

 /* Scrollbar siempre visible cuando hay m√°s de 4 apps */
 .category-scrollbar.visible {
     opacity: 1 !important;
 }

 /* Scrollbar oculto cuando hay 4 o menos apps */
 .category-scrollbar.hidden {
     opacity: 0 !important;
     pointer-events: none;
 }

 .category-scroll-thumb {
     position: absolute;
     width: 100%;
     background: rgba(255, 255, 255, 0.5);
     border-radius: 4px;
     transition: background 0.2s ease;
     cursor: pointer;
 }

 .category-scroll-thumb:hover {
     background: rgba(255, 255, 255, 0.8);
 }

 /* Scrollbar personalizado para categor√≠as */
 .category-scroll-container {
     position: relative;
     overflow: hidden;
     height: calc(100vh - 200px);
 }

 /* Ocultar controles de apps recientes cuando se selecciona una categor√≠a */
 .recent-section.hidden {
     display: none;
 }

 .scroll-arrow.hidden {
     display: none;
 }

 /* Transiciones suaves para cambios de secci√≥n */
 .section-transition {
     transition: opacity 0.3s ease, transform 0.3s ease;
 }

 /* Mejoras visuales para el scroll de apps */
 .app-grid-scroll-container {
     position: relative;
     height: calc(100vh - 300px);
     overflow-y: auto;
     overflow-x: hidden;
     padding-right: 5px;
 }

 .app-grid-scroll-container::-webkit-scrollbar {
     width: 8px;
 }

 .app-grid-scroll-container::-webkit-scrollbar-track {
     background: rgba(255, 255, 255, 0.1);
     border-radius: 4px;
 }

 .app-grid-scroll-container::-webkit-scrollbar-thumb {
     background: rgba(255, 255, 255, 0.3);
     border-radius: 4px;
 }

 .app-grid-scroll-container::-webkit-scrollbar-thumb:hover {
     background: rgba(255, 255, 255, 0.5);
 }

 /* ========== CORRECCI√ìN PARA OCULTAR APPS RECIENTES EN CATEGOR√çAS ========== */
 .recent-section.hidden {
     display: none !important;
 }

 .categories.fixed.hidden {
     display: none !important;
 }

 .section.hidden {
     opacity: 0;
     pointer-events: none;
     position: absolute;
     top: 0;
     left: 0;
     width: 100%;
     height: 0;
     overflow: hidden;
 }

 .app-grid-scroll-container.full-height {
     height: calc(100vh - 150px);
     margin-top: 0;
 }

 .category-button.active {
     background-color: #0078d4 !important;
     color: white !important;
 }

 /* Mejora visual para el men√∫ lateral */
 .menu-item.active {
     background-color: #333;
     border-left: 3px solid #0078d4;
     color: #0078d4;
 }

 .menu-item:hover {
     background-color: #2a2a2a;
 }

 /* ========== PANTALLA DE INICIO WINDOWS 11 STYLE ========== */
 .startup-screen {
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background: linear-gradient(135deg, #141414 0%, #000000 100%);
     display: flex;
     align-items: center;
     justify-content: center;
     z-index: 9999;
     transition: opacity 0.8s ease, visibility 0.8s ease;
     overflow: hidden;
 }

 .startup-screen.hidden {
     opacity: 0;
     visibility: hidden;
     pointer-events: none;
 }

 .startup-content {
     display: flex;
     flex-direction: column;
     align-items: center;
     justify-content: center;
     width: 100%;
     height: 100%;
     position: relative;
 }

 .startup-logo {
     margin-bottom: 50px;
     text-align: center;
     animation: fadeIn 1s ease;
 }

 .startup-logo h1 {
     font-size: 64px;
     font-weight: 300;
     background: linear-gradient(45deg, #0078d4, #00b7c3);
     -webkit-background-clip: text;
     -webkit-text-fill-color: transparent;
     margin-bottom: 15px;
     letter-spacing: 1px;
 }

 .startup-logo p {
     color: rgba(255, 255, 255, 0.6);
     font-size: 18px;
     font-weight: 300;
     letter-spacing: 0.5px;
 }

 .start-button {
     width: 140px;
     height: 140px;
     border-radius: 50%;
     background: linear-gradient(135deg, #0078d4, #00b7c3);
     border: none;
     color: white;
     font-size: 20px;
     font-weight: 500;
     cursor: pointer;
     position: relative;
     overflow: hidden;
     transition: all 0.3s ease;
     box-shadow: 
         0 10px 30px rgba(0, 120, 212, 0.3),
         inset 0 1px 0 rgba(255, 255, 255, 0.2);
     animation: pulse 2s infinite;
     letter-spacing: 1px;
 }

 .start-button:hover {
     transform: scale(1.08);
     box-shadow: 
         0 15px 40px rgba(0, 120, 212, 0.5),
         inset 0 1px 0 rgba(255, 255, 255, 0.3);
 }

 .start-button:focus {
     outline: none;
     box-shadow: 
         0 0 0 3px rgba(0, 120, 212, 0.3),
         0 15px 40px rgba(0, 120, 212, 0.5);
 }

 .start-button::before {
     content: '';
     position: absolute;
     top: -50%;
     left: -50%;
     width: 200%;
     height: 200%;
     background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, transparent 70%);
     opacity: 0;
     transition: opacity 0.3s ease;
 }

 .start-button:hover::before {
     opacity: 1;
 }

 @keyframes pulse {
     0% {
         box-shadow: 
             0 10px 30px rgba(0, 120, 212, 0.3),
             inset 0 1px 0 rgba(255, 255, 255, 0.2);
     }
     50% {
         box-shadow: 
             0 15px 40px rgba(0, 120, 212, 0.5),
             inset 0 1px 0 rgba(255, 255, 255, 0.3);
     }
     100% {
         box-shadow: 
             0 10px 30px rgba(0, 120, 212, 0.3),
             inset 0 1px 0 rgba(255, 255, 255, 0.2);
     }
 }

 @keyframes fadeIn {
     from {
         opacity: 0;
         transform: translateY(-20px);
     }
     to {
         opacity: 1;
         transform: translateY(0);
     }
 }

 /* ========== BOT√ìN ABOUT US WINDOWS 11 STYLE ========== */
 .startup-bottom-right {
     position: absolute;
     bottom: 40px;
     right: 40px;
     z-index: 10000;
 }

 .windows11-help-button {
     display: flex;
     align-items: center;
     gap: 10px;
     padding: 12px 20px;
     background: rgba(255, 255, 255, 0.07);
     backdrop-filter: blur(20px);
     -webkit-backdrop-filter: blur(20px);
     color: rgba(255, 255, 255, 0.9);
     border: 1px solid rgba(255, 255, 255, 0.12);
     border-radius: 8px;
     font-size: 14px;
     font-weight: 400;
     cursor: pointer;
     transition: all 0.3s ease;
     min-width: 140px;
     box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
 }

 .windows11-help-button:hover {
     background: rgba(255, 255, 255, 0.12);
     color: white;
     border-color: rgba(255, 255, 255, 0.2);
     transform: translateY(-2px);
     box-shadow: 
         0 6px 20px rgba(0, 0, 0, 0.15),
         0 0 0 1px rgba(255, 255, 255, 0.05);
 }

 .windows11-help-button:active {
     transform: translateY(0);
     background: rgba(255, 255, 255, 0.09);
 }

 .windows11-help-button:focus {
     outline: none;
     box-shadow: 
         0 0 0 2px rgba(0, 120, 212, 0.4),
         0 6px 20px rgba(0, 0, 0, 0.15);
 }

 .windows11-help-button svg {
     fill: currentColor;
     opacity: 0.9;
 }

 /* Animaci√≥n de entrada estilo Windows 11 */
 .windows11-help-button {
     animation: slideInRight 0.8s ease 0.3s both;
 }

 @keyframes slideInRight {
     from {
         opacity: 0;
         transform: translateX(30px);
     }
     to {
         opacity: 1;
         transform: translateX(0);
     }
 }

 /* Efecto de brillo al hover (estilo Windows 11) */
 .windows11-help-button::after {
     content: '';
     position: absolute;
     top: 0;
     left: 0;
     right: 0;
     bottom: 0;
     background: linear-gradient(
         135deg,
         rgba(255, 255, 255, 0.1) 0%,
         transparent 50%,
         rgba(255, 255, 255, 0.05) 100%
     );
     border-radius: 8px;
     opacity: 0;
     transition: opacity 0.3s ease;
     pointer-events: none;
 }

 .windows11-help-button:hover::after {
     opacity: 1;
 }

 /* ========== NUEVA POSICI√ìN PARA EL BOT√ìN DE PANTALLA COMPLETA ========== */
 .fullscreen-toggle {
     background: none;
     border: none;
     color: white;
     cursor: pointer;
     padding: 8px;
     border-radius: 50%;
     transition: all 0.3s ease;
     display: flex;
     align-items: center;
     justify-content: center;
     margin-left: 0;
     margin-right: 10px;
 }

 .fullscreen-toggle:hover {
     background-color: rgba(255, 255, 255, 0.1);
 }

 .fullscreen-toggle svg {
     width: 20px;
     height: 20px;
     fill: currentColor;
 }

 .fullscreen-toggle .fullscreen-icon {
     display: block;
 }

 .fullscreen-toggle .exit-fullscreen-icon {
     display: none;
 }

 .fullscreen-toggle.fullscreen-active .fullscreen-icon {
     display: none;
 }

 .fullscreen-toggle.fullscreen-active .exit-fullscreen-icon {
     display: block;
 }

 /* ========== REORDENAMIENTO DEL HEADER ========== */
 .header-system-info {
     display: flex;
     align-items: center;
     gap: 10px;
     margin-left: 20px;
     font-size: 14px;
     order: 3; /* Mover al final */
 }

 .search-container {
     order: 1; /* Buscador primero */
 }

 .logo-container {
     order: 0; /* Logo primero */
 }

 /* ========== NUEVO ORDEN EN EL HEADER ========== */
 .header-content {
     display: flex;
     align-items: center;
     max-width: 100%;
     margin: 0 auto;
     padding: 0 20px;
     justify-content: space-between;
 }

 .header-system-info {
     display: flex;
     align-items: center;
     gap: 10px;
     margin-left: auto;
 }

 /* ========== MEJORA EN EL BOT√ìN DE INICIO ========== */
 .startup-screen::before {
     content: '';
     position: absolute;
     top: 0;
     left: 0;
     right: 0;
     bottom: 0;
     background: 
         radial-gradient(circle at 20% 80%, rgba(0, 120, 212, 0.05) 0%, transparent 50%),
         radial-gradient(circle at 80% 20%, rgba(0, 183, 195, 0.05) 0%, transparent 50%),
         radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.02) 0%, transparent 50%);
     pointer-events: none;
 }

 /* ========== ESTILOS PARA EL DI√ÅLOGO DE SHUTDOWN ========== */
 .shutdown-confirm {
     display: none;
     position: fixed;
     top: 50%;
     left: 50%;
     transform: translate(-50%, -50%);
     background: #181818;
     padding: 30px;
     border-radius: 8px;
     z-index: 1003;
     text-align: center;
     box-shadow: 0 4px 20px rgba(0,0,0,0.5);
     border: 1px solid #333;
     max-width: 400px;
     width: 90%;
 }

 .shutdown-confirm.active {
     display: block;
 }

 .shutdown-confirm-buttons {
     display: flex;
     gap: 10px;
     justify-content: center;
     margin-top: 20px;
 }

 .shutdown-button {
     background-color: #d32f2f !important;
 }

 .shutdown-button:hover {
     background-color: #b71c1c !important;
 }

 .shutdown-info {
     color: #ff6b6b;
     font-size: 11px;
     margin-top: 5px;
 }

/* ========== NUEVOS ESTILOS PARA LA SECCI√ìN DE SETTINGS ========== */
.settings-section {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(10, 10, 10, 0.98);
    backdrop-filter: blur(20px);
    z-index: 3001;
    padding: 0;
    overflow: hidden;
}

.settings-section.active {
    display: flex;
}

.settings-container {
    display: flex;
    width: 100%;
    height: 100%;
}

.settings-sidebar {
    width: 250px;
    background: rgba(20, 20, 20, 0.9);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    padding: 20px 0;
    overflow-y: auto;
}

.settings-tab {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
}

.settings-tab:hover {
    background: rgba(255, 255, 255, 0.05);
}

.settings-tab.active {
    background: rgba(0, 120, 212, 0.2);
    border-left: 3px solid #0078d4;
    color: #0078d4;
}

.settings-tab svg {
    width: 20px;
    height: 20px;
    margin-right: 15px;
    fill: currentColor;
}

.settings-tab span {
    font-size: 14px;
    font-weight: 500;
}

.settings-content {
    flex: 1;
    padding: 40px;
    overflow-y: auto;
}

.settings-panel {
    display: none;
    max-width: 800px;
    margin: 0 auto;
}

.settings-panel.active {
    display: block;
}

.settings-header {
    margin-bottom: 30px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 20px;
}

.settings-header h2 {
    font-size: 32px;
    margin-bottom: 10px;
    background: linear-gradient(45deg, #0078d4, #00b7c3);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.settings-header p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 16px;
}

.settings-group {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.settings-group h3 {
    font-size: 20px;
    margin-bottom: 20px;
    color: #0078d4;
    display: flex;
    align-items: center;
    gap: 10px;
}

.settings-group h3 svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
}

.settings-option {
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.settings-option:hover {
    background: rgba(255, 255, 255, 0.07);
}

.settings-label {
    flex: 1;
    font-size: 16px;
    font-weight: 500;
}

.settings-control {
    display: flex;
    align-items: center;
    gap: 15px;
}

.color-picker {
    width: 40px;
    height: 40px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    cursor: pointer;
    background: #141414;
}

.color-preview {
    width: 30px;
    height: 30px;
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.select-control {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: white;
    padding: 8px 12px;
    min-width: 120px;
    cursor: pointer;
}

.range-control {
    width: 150px;
    height: 6px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
}

.range-control::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    background: #0078d4;
    border-radius: 50%;
    cursor: pointer;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.2);
    transition: .3s;
    border-radius: 24px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: #0078d4;
}

input:checked + .toggle-slider:before {
    transform: translateX(26px);
}

.settings-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    margin-top: 40px;
    padding-top: 30px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.settings-button {
    padding: 12px 30px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.3s ease;
    min-width: 140px;
}

.settings-button.apply {
    background: #0078d4;
    color: white;
}

.settings-button.apply:hover {
    background: #106ebe;
}

.settings-button.reset {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.settings-button.reset:hover {
    background: rgba(255, 255, 255, 0.2);
}

.background-preview {
    width: 80px;
    height: 60px;
    border-radius: 6px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    background-size: cover;
    background-position: center;
    cursor: pointer;
}

.image-upload {
    display: none;
}

.upload-button {
    background: rgba(255, 255, 255, 0.1);
    border: 1px dashed rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    padding: 10px 15px;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s ease;
}

.upload-button:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.5);
}

.font-preview {
    font-size: 16px;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
    min-width: 200px;
    text-align: center;
}

.settings-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 10;
}

.settings-close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}

/* ========== ESTILOS PARA APPS FIJADAS EN TASKBAR ========== */
.dockbar-pinned {
    border-left: 2px solid #0078d4 !important;
}

.dockbar-pinned::before {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 4px;
    height: 4px;
    background: #0078d4;
    border-radius: 50%;
}

/* Separador visual entre apps fijadas y abiertas */
.dockbar-pinned:not(:first-child) {
    margin-left: 2px;
}

.dockbar-pinned + .dockbar-app-icon:not(.dockbar-pinned) {
    border-left: 1px solid rgba(255, 255, 255, 0.2);
    padding-left: 8px;
    margin-left: 4px;
}

/* ========== MEJORAS PARA TOUCH ========== */
@media (hover: none) and (pointer: coarse) {
    /* Optimizar para dispositivos t√°ctiles */
    .recent-app, .app-card, .launcher-app, .category-button {
        min-height: 44px; /* Tama√±o m√≠nimo recomendado para touch */
        min-width: 44px;
    }
    
    .recent-app {
        width: 140px;
        height: 140px;
    }
    
    .recent-app.featured {
        width: 420px;
        height: 140px;
    }
    
    /* Mejorar feedback t√°ctil */
    .recent-app:active, 
    .app-card:active, 
    .launcher-app:active,
    .category-button:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
        opacity: 0.8;
    }
    
    /* Ocultar efectos hover en dispositivos t√°ctiles */
    .recent-app:hover, 
    .app-card:hover, 
    .launcher-app:hover {
        transform: none;
    }
    
    /* Scrollbars m√°s grandes para touch */
    .windows-scrollbar {
        width: 12px;
    }
    
    .windows-scroll-thumb {
        background: rgba(255, 255, 255, 0.6);
    }
    
    /* Flechas de navegaci√≥n m√°s grandes */
    .scroll-arrow {
        width: 60px;
        height: 60px;
        font-size: 24px;
        background-color: rgba(0, 0, 0, 0.9);
        border-width: 3px;
    }
}

/* Mejorar la capacidad de respuesta t√°ctil */
.recent-apps-container {
    -webkit-overflow-scrolling: touch; /* Scroll suave en iOS */
    overscroll-behavior-x: contain; /* Prevenir scroll de la p√°gina */
}

/* Indicador visual para elementos t√°ctiles */
.recent-app {
    cursor: pointer;
    user-select: none;
    -webkit-tap-highlight-color: rgba(0, 120, 212, 0.3);
    tap-highlight-color: rgba(0, 120, 212, 0.3);
}

/* Prevenir zoom en elementos interactivos */
.recent-apps-container,
.app-grid,
.launcher-apps {
    touch-action: pan-y pinch-zoom;
}

/* Mejorar el feedback de arrastre */
.recent-apps-container.grabbing {
    cursor: grabbing;
}

.recent-apps-container.grabbing .recent-app {
    pointer-events: none; /* Deshabilitar clicks durante el arrastre */
}

/* ========== MEJORAS ESPEC√çFICAS PARA SCROLL T√ÅCTIL ========== */
.recent-apps-container {
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-x: contain;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.recent-apps-container::-webkit-scrollbar {
    display: none;
}

.recent-apps {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-x: contain;
}

/* Mejorar la respuesta t√°ctil */
.recent-app {
    -webkit-tap-highlight-color: rgba(0, 120, 212, 0.3);
    tap-highlight-color: rgba(0, 120, 212, 0.3);
    touch-action: manipulation;
}

/* Indicador visual durante el arrastre */
.recent-apps-container.grabbing .recent-app {
    cursor: grabbing;
    user-select: none;
    -webkit-user-select: none;
}

/* Optimizar para dispositivos t√°ctiles */
@media (hover: none) and (pointer: coarse) {
    .recent-apps-container {
        cursor: grab;
    }
    
    .recent-apps-container.grabbing {
        cursor: grabbing;
    }
    
    .recent-app:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
    }
    
    /* Flechas de navegaci√≥n m√°s grandes para touch */
    .scroll-arrow {
        width: 60px;
        height: 60px;
        font-size: 24px;
        background-color: rgba(0, 0, 0, 0.9);
        border-width: 3px;
    }
    
    .scroll-arrow.left {
        left: 5px;
    }
    
    .scroll-arrow.right {
        right: 5px;
    }
}

/* Prevenir el efecto de rebote en iOS */
@supports (-webkit-touch-callout: none) {
    .recent-apps-container {
        -webkit-overflow-scrolling: touch;
    }
    
    .recent-apps {
        -webkit-overflow-scrolling: touch;
    }
}

/* Estilos para el bot√≥n de instalaci√≥n PWA */
.install-pwa-button {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px 12px;
    background: #0078d4;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s ease;
    margin-right: 10px;
}

.install-pwa-button:hover {
    background: #106ebe;
}

.install-pwa-button svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
}

/* Mejorar el header system info para acomodar el bot√≥n */
.header-system-info {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: nowrap;
    white-space: nowrap;
}

/* ========== ESTILOS PARA EL DI√ÅLOGO EULA ========== */
.eula-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.eula-modal.active {
    display: flex;
}

.eula-content {
    background: #181818;
    border-radius: 12px;
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    border: 2px solid #0078d4;
    box-shadow: 0 10px 40px rgba(0, 120, 212, 0.3);
    overflow: hidden;
}

.eula-header {
    background: #0078d4;
    color: white;
    padding: 20px 30px;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.eula-header h2 {
    margin: 0;
    font-size: 24px;
    font-weight: bold;
}

.eula-body {
    flex: 1;
    overflow: hidden;
    padding: 0;
}

.eula-scroll {
    padding: 30px;
    max-height: 60vh;
    overflow-y: auto;
    color: #e0e0e0;
    font-size: 14px;
    line-height: 1.6;
}

.eula-scroll::-webkit-scrollbar {
    width: 8px;
}

.eula-scroll::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
}

.eula-scroll::-webkit-scrollbar-thumb {
    background: #0078d4;
    border-radius: 4px;
}

.eula-scroll::-webkit-scrollbar-thumb:hover {
    background: #106ebe;
}

.eula-scroll h3 {
    color: #0078d4;
    margin-top: 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 10px;
}

.eula-scroll h4 {
    color: #4CAF50;
    margin: 20px 0 10px 0;
}

.eula-scroll ul {
    margin: 10px 0 20px 20px;
    padding: 0;
}

.eula-scroll li {
    margin-bottom: 8px;
}

.eula-scroll strong {
    color: #FF9800;
}

.eula-warning {
    background: rgba(255, 152, 0, 0.1);
    border-left: 4px solid #FF9800;
    padding: 15px;
    margin: 20px 0;
    border-radius: 4px;
    color: #FF9800;
    font-weight: bold;
}

.eula-footer {
    display: flex;
    justify-content: space-between;
    padding: 20px 30px;
    background: rgba(0, 0, 0, 0.3);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    gap: 20px;
}

.eula-button {
    flex: 1;
    padding: 15px 30px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 150px;
}

.eula-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.eula-button:active {
    transform: translateY(0);
}

.eula-button.disagree {
    background: #d32f2f;
    color: white;
}

.eula-button.disagree:hover {
    background: #b71c1c;
}

.eula-button.agree {
    background: #4CAF50;
    color: white;
}

.eula-button.agree:hover {
    background: #388E3C;
}

/* ========== RESPONSIVE PANTALLA DE INICIO ========== */
@media (max-width: 768px) {
    .startup-logo h1 {
        font-size: 48px;
    }
    
    .startup-logo p {
        font-size: 16px;
    }
    
    .start-button {
        width: 120px;
        height: 120px;
        font-size: 18px;
    }
    
    .startup-bottom-right {
        bottom: 30px;
        right: 30px;
    }
    
    .windows11-help-button {
        padding: 10px 16px;
        min-width: 120px;
        font-size: 13px;
        gap: 8px;
    }
    
    .windows11-help-button svg {
        width: 20px;
        height: 20px;
    }
    
    .eula-content {
        max-height: 95vh;
    }
    
    .eula-scroll {
        padding: 20px;
        font-size: 13px;
    }
    
    .eula-header h2 {
        font-size: 20px;
    }
    
    .eula-footer {
        flex-direction: column;
        gap: 10px;
    }
    
    .eula-button {
        width: 100%;
    }
}

@media (max-width: 480px) {
    .startup-logo h1 {
        font-size: 36px;
    }
    
    .startup-logo p {
        font-size: 14px;
    }
    
    .start-button {
        width: 100px;
        height: 100px;
        font-size: 16px;
    }
    
    .startup-bottom-right {
        bottom: 20px;
        right: 20px;
    }
    
    .windows11-help-button {
        padding: 8px 12px;
        min-width: auto;
    }
    
    .windows11-help-button span {
        display: none; /* Ocultar texto en m√≥viles muy peque√±os */
    }
    
    .windows11-help-button {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        justify-content: center;
        padding: 0;
    }
    
    .windows11-help-button svg {
        width: 22px;
        height: 22px;
    }
}

</style>
</head>
<body>
<!-- Pantalla de inicio estilo Windows 11 -->
<div class="startup-screen" id="startupScreen">
    <div class="startup-content">
        <div class="startup-logo">
            <h1>WineBOX</h1>
            <p>Click to start WineBOX</p>
        </div>
        
        <button class="start-button" id="startButton" title="Click to start WineBOX">
            START
        </button>
        
        <!-- Bot√≥n About us en esquina inferior derecha (estilo Windows 11) -->
        <div class="startup-bottom-right">
            <button class="windows11-help-button" id="aboutStartupButton" title="About WineBOX">
                <svg viewBox="0 0 24 24" width="24" height="24">
                    <path d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z"/>
                </svg>
                <span>About us</span>
            </button>
        </div>
    </div>
</div>

<!-- Di√°logo de Aviso Legal (EULA) -->
<div class="eula-modal" id="eulaModal">
    <div class="eula-content">
        <div class="eula-header">
            <h2>WineBOX End User License Agreement</h2>
        </div>
        <div class="eula-body">
            <div class="eula-scroll">
                <h3>IMPORTANT LEGAL NOTICE</h3>
                <p>Please read this agreement carefully before using WineBOX. By clicking "I AGREE" below, you acknowledge that you have read, understood, and agree to be bound by the terms of this agreement.</p>
                
                <h4>1. Software Disclaimer</h4>
                <p>WineBOX is an emulation platform that provides access to various software applications. WineBOX does NOT provide, distribute, or own any patented software. All software accessible through WineBOX falls under one of the following categories:</p>
                <ul>
                    <li><strong>Free Software/Open Source:</strong> Software distributed under licenses such as GPL, MIT, Apache, etc.</li>
                    <li><strong>Shareware/Demo Software:</strong> Trial versions or limited functionality software provided by developers.</li>
                    <li><strong>Abandonware:</strong> Software no longer maintained or supported by original developers.</li>
                    <li><strong>Public Domain:</strong> Software with expired copyright or explicitly released to public domain.</li>
                </ul>
                
                <h4>2. Third-Party Software</h4>
                <p>WineBOX allows installation and execution of third-party software. You acknowledge that:</p>
                <ul>
                    <li>You are solely responsible for verifying the licensing status of any third-party software you install.</li>
                    <li>You must ensure you have proper rights or licenses to use any third-party software.</li>
                    <li>WineBOX is not responsible for software licensing compliance of third-party applications.</li>
                </ul>
                
                <h4>3. User Responsibility</h4>
                <p>As a user of WineBOX, you agree that:</p>
                <ul>
                    <li>You will use WineBOX only for lawful purposes.</li>
                    <li>You are responsible for your actions while using WineBOX.</li>
                    <li>You will not use WineBOX to violate copyright laws or intellectual property rights.</li>
                    <li>You understand that some software may require separate licenses from original developers.</li>
                </ul>
                
                <h4>4. Limitation of Liability</h4>
                <p>WineBOX and its developers:</p>
                <ul>
                    <li>Provide the platform "AS IS" without any warranties.</li>
                    <li>Are not liable for any damages resulting from software use through WineBOX.</li>
                    <li>Do not guarantee compatibility, security, or performance of third-party software.</li>
                    <li>Reserve the right to remove or block software that violates this agreement.</li>
                </ul>
                
                <h4>5. Acceptance</h4>
                <p>By clicking "I AGREE", you confirm that:</p>
                <ul>
                    <li>You understand WineBOX only provides access to free, shareware, demo, or public domain software.</li>
                    <li>You take full responsibility for any third-party software you install.</li>
                    <li>You will comply with all applicable laws and software licenses.</li>
                    <li>You acknowledge that WineBOX does not distribute patented commercial software.</li>
                </ul>
                
                <p class="eula-warning">‚ö†Ô∏è <strong>WARNING:</strong> If you do not agree to these terms, click "I DISAGREE" to exit WineBOX. You will not be able to use WineBOX without accepting this agreement.</p>
            </div>
        </div>
        <div class="eula-footer">
            <button class="eula-button disagree" id="eulaDisagree">I DISAGREE</button>
            <button class="eula-button agree" id="eulaAgree">I AGREE</button>
        </div>
    </div>
</div>


<div class="side-menu" id="sideMenu">
    <div class="menu-item" data-category="all">
        <svg viewBox="0 0 24 24"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" /></svg>
        <span>Home</span>
    </div>
    <div class="menu-item" data-category="apps">
        <svg viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>
        <span>Applications</span>
    </div>
    <div class="menu-item" data-category="games">
        <svg viewBox="0 0 24 24"><path d="M21,6H3A2,2 0 0,0 1,8V16A2,2 0 0,0 3,18H21A2,2 0 0,0 23,16V8A2,2 0 0,0 21,6M21,16H3V8H21M6,15H8V13H10V11H8V9H6V11H4V13H6M14.5,12A1.5,1.5 0 0,1 16,13.5A1.5,1.5 0 0,1 14.5,15A1.5,1.5 0 0,1 13,13.5A1.5,1.5 0 0,1 14.5,12M18.5,9A1.5,1.5 0 0,1 20,10.5A1.5,1.5 0 0,1 18.5,12A1.5,1.5 0 0,1 17,10.5A1.5,1.5 0 0,1 18.5,9Z" /></svg>
        <span>Games</span>
    </div>
    <div class="menu-item" data-category="arcade">
        <svg viewBox="0 0 24 24"><path d="M21,16V4H3V16H21M21,2A2,2 0 0,1 23,4V16A2,2 0 0,1 21,18H14V20H16V22H8V20H10V18H3C1.89,18 1,17.1 1,16V4C1,2.89 1.89,2 3,2H21M5,6H14V11H5V6M15,6H19V8H15V6M19,9V14H15V9H19M5,12H9V14H5V12Z" /></svg>
        <span>Arcade</span>
    </div>
    <div class="menu-item" data-category="multimedia">
        <svg viewBox="0 0 24 24"><path d="M4,6H20V16H4M20,18A2,2 0 0,0 22,16V6C22,4.89 21.1,4 20,4H4C2.89,4 2,4.89 2,6V16A2,2 0 0,0 4,18H0V20H24V18H20Z" /></svg>
        <span>Multimedia</span>
    </div>
    <div class="menu-item" data-category="utilities">
        <svg viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L2.34,18.73C2.46,18.95 2.73,19.03 2.95,18.95L5.44,17.94C5.96,18.34 6.5,18.68 7.13,18.93L7.5,21.58C7.54,21.82 7.75,22 8,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" /></svg>
        <span>Utilities</span>
    </div>
    <div class="menu-item" data-category="rts">
        <svg viewBox="0 0 24 24"><path d="M12,2L1,21H23M12,6L19.53,19H4.47M11,10V14H13V10M11,16V18H13V16" /></svg>
        <span>Strategy</span>
    </div>
    <div class="menu-item" data-category="uninstall">
        <svg viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>
        <span>Uninstall</span>
    </div>
    <div class="menu-item" data-category="settings">
        <svg viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L2.34,18.73C2.46,18.95 2.73,19.03 2.95,18.95L5.44,17.94C5.96,18.34 6.5,18.68 7.13,18.93L7.5,21.58C7.54,21.82 7.75,22 8,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.67 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" /></svg>
        <span>Settings</span>
    </div>
    <div class="menu-item" data-category="shutdown">
        <svg viewBox="0 0 24 24"><path d="M13,3H11V13H13V3M17.83,5.17L16.41,6.59C18.05,7.91 19,9.9 19,12A7,7 0 0,1 12,19A7,7 0 0,1 5,12C5,9.91 5.95,7.91 7.58,6.58L6.17,5.17C4.23,6.82 3,9.26 3,12A9,9 0 0,0 12,21A9,9 0 0,0 21,12C21,9.26 19.77,6.82 17.83,5.17Z" /></svg>
        <span>Shutdown</span>
    </div>
</div>
<div class="menu-overlay" id="menuOverlay"></div>
<div class="status-message" id="statusMessage"></div>

<!-- Secci√≥n de Settings -->
<div class="settings-section" id="settingsSection">
    <button class="settings-close" id="settingsClose">√ó</button>
    <div class="settings-container">
        <div class="settings-sidebar">
            <div class="settings-tab active" data-tab="appearance">
                <svg viewBox="0 0 24 24"><path d="M12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" /></svg>
                <span>Appearance</span>
            </div>
            <div class="settings-tab" data-tab="interface">
                <svg viewBox="0 0 24 24"><path d="M18.5,12A1.5,1.5 0 0,1 17,10.5A1.5,1.5 0 0,1 18.5,9A1.5,1.5 0 0,1 20,10.5A1.5,1.5 0 0,1 18.5,12M5.5,12A1.5,1.5 0 0,1 7,10.5A1.5,1.5 0 0,1 8.5,9A1.5,1.5 0 0,1 10,10.5A1.5,1.5 0 0,1 8.5,12M18.5,4C14.92,4 12,6.92 12,10.5C12,12.29 12.74,13.92 13.89,15.11L12,17L13.5,18.5L15.62,16.38C16.43,16.81 17.42,17 18.5,17C22.08,17 25,14.08 25,10.5C25,6.92 22.08,4 18.5,4M5.5,4C1.92,4 -1,6.92 -1,10.5C-1,14.08 1.92,17 5.5,17C6.58,17 7.57,16.81 8.38,16.38L10.5,18.5L12,17L10.11,15.11C11.26,13.92 12,12.29 12,10.5C12,6.92 9.08,4 5.5,4Z" /></svg>
                <span>Interface</span>
            </div>
            <div class="settings-tab" data-tab="system">
                <svg viewBox="0 0 24 24"><path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M12,7C13.4,7 14.8,8.6 14.8,10V11.5C14.8,13.4 13.4,14.8 11.5,14.8C9.6,14.8 8.2,13.4 8.2,11.5V10C8.2,8.6 9.6,7 12,7M12,8.2C11,8.2 10.2,9 10.2,10V11.5C10.2,12.5 11,13.3 12,13.3C13,13.3 13.8,12.5 13.8,11.5V10C13.8,9 13,8.2 12,8.2Z" /></svg>
                <span>System</span>
            </div>
        </div>
        <div class="settings-content">
            <!-- Panel de Appearance -->
            <div class="settings-panel active" id="appearancePanel">
                <div class="settings-header">
                    <h2>Appearance</h2>
                    <p>Customize the look and feel of WineBOX</p>
                </div>

                <div class="settings-group">
                    <h3>
                        <svg viewBox="0 0 24 24"><path d="M12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" /></svg>
                        Theme
                    </h3>
                    
                    <div class="settings-option">
                        <div class="settings-label">Background Color</div>
                        <div class="settings-control">
                            <input type="color" class="color-picker" id="backgroundColor" value="#141414">
                            <div class="color-preview" id="colorPreview" style="background: #141414"></div>
                        </div>
                    </div>

                    <div class="settings-option">
                        <div class="settings-label">Background Image</div>
                        <div class="settings-control">
                            <div class="background-preview" id="backgroundPreview"></div>
                            <label class="upload-button">
                                Upload Image
                                <input type="file" class="image-upload" id="backgroundImageUpload" accept="image/*">
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel de Interface -->
            <div class="settings-panel" id="interfacePanel">
                <div class="settings-header">
                    <h2>Interface</h2>
                    <p>Configure how you interact with WineBOX</p>
                </div>

                <div class="settings-group">
                    <h3>
                        <svg viewBox="0 0 24 24"><path d="M18.5,12A1.5,1.5 0 0,1 17,10.5A1.5,1.5 0 0,1 18.5,9A1.5,1.5 0 0,1 20,10.5A1.5,1.5 0 0,1 18.5,12M5.5,12A1.5,1.5 0 0,1 7,10.5A1.5,1.5 0 0,1 8.5,9A1.5,1.5 0 0,1 10,10.5A1.5,1.5 0 0,1 8.5,12M18.5,4C14.92,4 12,6.92 12,10.5C12,12.29 12.74,13.92 13.89,15.11L12,17L13.5,18.5L15.62,16.38C16.43,16.81 17.42,17 18.5,17C22.08,17 25,14.08 25,10.5C25,6.92 22.08,4 18.5,4M5.5,4C1.92,4 -1,6.92 -1,10.5C-1,14.08 1.92,17 5.5,17C6.58,17 7.57,16.81 8.38,16.38L10.5,18.5L12,17L10.11,15.11C11.26,13.92 12,12.29 12,10.5C12,6.92 9.08,4 5.5,4Z" /></svg>
                        Display
                    </h3>
                    
                    <div class="settings-option">
                        <div class="settings-label">Icon Size</div>
                        <div class="settings-control">
                            <input type="range" class="range-control" id="iconSize" min="80" max="200" value="160">
                            <span id="iconSizeValue">160px</span>
                        </div>
                    </div>

                    <div class="settings-option">
                        <div class="settings-label">Enable Animations</div>
                        <div class="settings-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="animations" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel de System -->
            <div class="settings-panel" id="systemPanel">
                <div class="settings-header">
                    <h2>System</h2>
                    <p>System preferences and performance settings</p>
                </div>

                <div class="settings-group">
                    <h3>
                        <svg viewBox="0 0 24 24"><path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M12,7C13.4,7 14.8,8.6 14.8,10V11.5C14.8,13.4 13.4,14.8 11.5,14.8C9.6,14.8 8.2,13.4 8.2,11.5V10C8.2,8.6 9.6,7 12,7M12,8.2C11,8.2 10.2,9 10.2,10V11.5C10.2,12.5 11,13.3 12,13.3C13,13.3 13.8,12.5 13.8,11.5V10C13.8,9 13,8.2 12,8.2Z" /></svg>
                        Preferences
                    </h3>
                    
                    <div class="settings-option">
                        <div class="settings-label">Auto-start on boot</div>
                        <div class="settings-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoStart">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-option">
                        <div class="settings-label">Show startup screen</div>
                        <div class="settings-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="showStartup" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-actions">
                <button class="settings-button reset" id="resetSettings">Reset to Default</button>
                <button class="settings-button apply" id="applySettings">Apply Changes</button>
            </div>
        </div>
    </div>
</div>

<div class="uninstall-confirm" id="uninstallConfirm">
    <h3>Confirm Uninstall</h3>
    <p id="uninstallAppName">Are you sure you want to uninstall this application?</p>
    <div class="uninstall-confirm-buttons">
        <button class="action-button uninstall-button" id="confirmUninstall">Uninstall</button>
        <button class="action-button" id="cancelUninstall">Cancel</button>
    </div>
</div>

<!-- Di√°logo de confirmaci√≥n de shutdown -->
<div class="shutdown-confirm" id="shutdownConfirm">
    <h3>Confirm Shutdown</h3>
    <p>Are you sure you want to shutdown WineBOX?</p>
    <p style="font-size: 12px; color: #ff6b6b; margin-top: 10px;">
        This will close the program and all background processes. Any unsaved work may be lost.
    </p>
    <div class="shutdown-confirm-buttons">
        <button class="action-button shutdown-button" id="confirmShutdown">Shutdown</button>
        <button class="action-button" id="cancelShutdown">Cancel</button>
    </div>
</div>

<div class="app-frame-container" id="appFrameContainer">
    <div class="window-controls">
        <button class="window-control-btn" onclick="minimizeActiveWindow()">‚àí</button>
        <button class="window-control-btn" onclick="closeActiveWindow()">√ó</button>
    </div>
    <div class="iframe-scroll-container">
        <div class="iframe-scroll-content scroll-invisible">
            <iframe id="appFrame" src=""></iframe>
        </div>
    </div>
</div>

<div class="launcher" id="launcher">
    <button class="launcher-close" onclick="toggleLauncher()">√ó</button>
    <div class="launcher-header">
        <div class="launcher-search">
            <input type="text" id="launcherSearch" placeholder="Search applications...">
            <div class="search-results-count" id="searchResultsCount">Type to search applications</div>
        </div>
    </div>
    <div class="launcher-apps-container windows-scroll-container">
        <div class="launcher-apps windows-scroll-content" id="launcherApps"></div>
        <div class="windows-scrollbar">
            <div class="windows-scroll-thumb"></div>
        </div>
    </div>
</div>

<!-- Scrollbar personalizado para categor√≠as -->
<div class="category-scrollbar" id="categoryScrollbar">
    <div class="category-scroll-thumb" id="categoryScrollThumb"></div>
</div>

<div class="dockbar">
    <div class="dockbar-home" id="dockbarHome" title="Menu">
        <svg viewBox="0 0 24 24">
            <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" />
        </svg>
    </div>
    <div class="dockbar-separator"></div>
    <div class="dockbar-controls">
        <div class="dockbar-icon dockbar-minimize" id="dockbarMinimize" title="Minimize">
            <svg viewBox="0 0 24 24">
                <path d="M19,13H5V11H19V13Z" />
            </svg>
        </div>
        <div class="dockbar-icon dockbar-back" id="dockbarBack" title="Back">
            <svg viewBox="0 0 24 24">
                <path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" />
            </svg>
        </div>
    </div>
    <div class="dockbar-separator"></div>
    <div class="dockbar-apps scroll-invisible" id="dockbarApps"></div>
    <div class="dockbar-system"></div>
</div>

<header class="header">
    <div class="header-content">
        <div class="logo-container" id="headerMenu">
            <button id="menuButton" class="menu-button">
                <svg viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
            </button>
        </div>
        <div class="search-container" id="headerSearch">
            <button class="search-toggle" id="searchToggle">
                <svg viewBox="0 0 24 24">
                    <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                </svg>
            </button>
            <input type="text" class="search-input" id="searchInput" placeholder="Search applications...">
        </div>
        <div class="header-system-info">
            <!-- Bot√≥n de pantalla completa ahora entre bater√≠a y buscador -->
            <button class="fullscreen-toggle" id="fullscreenToggle" title="Toggle fullscreen">
                <svg class="fullscreen-icon" viewBox="0 0 24 24">
                    <path d="M7,14H5v5h5v-2H7V14z M5,10h2V7h3V5H5V10z M17,17h-3v2h5v-5h-2V17z M14,5v2h3v3h2V5H14z"/>
                </svg>
                <svg class="exit-fullscreen-icon" viewBox="0 0 24 24">
                    <path d="M5,16h3v3h2v-5H5V16z M16,8h-3V5h-2v5h5V8z M19,19h-3v2h5v-5h-2V19z M8,8H5v2h5V5H8V8z"/>
                </svg>
            </button>
            <div class="battery-info" id="batteryInfo">
                <div class="battery-icon">
                    <div class="battery-level" id="batteryLevel"></div>
                </div>
                <div class="battery-percentage" id="batteryPercentage">--%</div>
            </div>
            <div class="header-time" id="headerTime">00:00</div>
        </div>
    </div>
</header>
<div class="container">
    <div id="mainView">
        <div class="recent-section section active" id="recentSection">
            <div class="recent-title">Recently Used</div>
            <div class="recent-apps-container windows-scroll-container" id="recentAppsContainer">
                <div class="scroll-arrow left hidden" id="scrollLeft">‚Äπ</div>
                <div class="scroll-arrow right" id="scrollRight">‚Ä∫</div>
                <div class="recent-apps windows-scroll-content" id="recentApps"></div>
                <div class="windows-scrollbar">
                    <div class="windows-scroll-thumb"></div>
                </div>
                <div class="selected-app-info" id="selectedAppInfo"></div>
            </div>
        </div>
        <div class="categories section active" id="categoriesSection">
            <button class="category-button active" data-category="all">All</button>
            <button class="category-button" data-category="apps">Apps</button>
            <button class="category-button" data-category="games">Games</button>
            <button class="category-button" data-category="multimedia">Multimedia</button>
            <button class="category-button" data-category="utilities">Utilities</button>
            <button class="category-button" data-category="arcade">Arcade</button>
            <button class="category-button" data-category="rts">Strategy</button>
        </div>
        <div class="app-grid-scroll-container section active" id="appsSection">
            <div class="app-grid" id="appGrid">
                <div class="loading-message" id="loadingMessage">Loading applications...</div>
            </div>
        </div>
    </div>
</div>
<div id="appModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div class="app-details" id="appDetails"></div>
        <div class="modal-actions" id="modalActions">
            <button class="modal-action-button" data-action="run">Run</button>
            <button class="modal-action-button install" data-action="install">Install in Program Manager</button>
        </div>
    </div>
</div>
<audio id="navSound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" type="audio/mpeg">
</audio>

<script>
// ========== VARIABLES GLOBALES OPTIMIZADAS ==========
let appData = [];
let currentCategory = 'all';
let keyboardEnabled = true;
let isModalOpen = false;
let isMenuOpen = false;
let isSearchActive = false;
let currentFocusArea = 'recent';
let currentSelectedIndex = -1;
let currentCategoryIndex = 0;
let currentRecentIndex = -1;
let currentMenuItemIndex = -1;
let currentSection = 'recent';
let currentHeaderIndex = 0;
let lastFocusArea = 'recent';
let isScrolling = false;
let currentUninstallApp = null;
let recentApps = JSON.parse(localStorage.getItem('recentApps')) || [];
let currentApps = [];
const MAX_RECENT_APPS = 16;

// Variables para navegaci√≥n en di√°logos y launcher
let currentModalActionIndex = 0;
let currentLauncherAppIndex = -1;
let currentConfirmButtonIndex = 0;

// Variables para shutdown
let currentShutdownConfirm = false;
let currentShutdownButtonIndex = 0;

// Variables para settings
let currentSettingsTabIndex = 0;
let settingsTabs = [];
let isSettingsOpen = false;

// Elementos globales
let appGrid, recentAppsContainer, selectedAppInfo, categoryButtons, navSound, scrollIndicator, recentAppsEl;
let menuButton, sideMenu, menuOverlay, menuItems;

// Task Manager
let taskManager = {
    openWindows: [],
    nextWindowId: 1,
    activeWindowId: null
};

// ========== NUEVAS VARIABLES PARA PANTALLA COMPLETA ==========
let isFullscreen = false;
let startupScreen = null;
let startButton = null;
let fullscreenToggle = null;

// ========== VARIABLES PARA SCROLL T√ÅCTIL ==========
let isDragging = false;
let startX = 0;
let scrollLeft = 0;
let currentScrollPosition = 0;
let scrollVelocity = 0;
let lastScrollTime = 0;

// ========== NUEVAS VARIABLES PARA SCROLL DE CATEGOR√çAS ==========
let categoryScrollbar = null;
let categoryScrollThumb = null;
let isCategoryScrolling = false;
let categoryScrollStartY = 0;
let categoryScrollStartTop = 0;

// ========== NUEVAS VARIABLES PARA PROGRAM MANAGER ==========
let programManagerApp = {
    name: "Program Manager",
    image: "http://winebox.cloud/src/icons/fileExplorer.png", // Icono espec√≠fico para taskbar
    category: "utilities", 
    description: "Manage your installed applications and shortcuts",
    link: "progman.html"
};

// ========== FUNCIONES PARA AUTO-START Y TASKBAR FIJADA ==========
function autoStartProgramManager() {
    const settings = JSON.parse(localStorage.getItem('wineboxSettings') || '{}');
    
    // Siempre fijar Program Manager en la taskbar (independiente del auto-start)
    ensureProgramManagerPinned();
    
    // Solo auto-iniciar si est√° configurado
    if (settings.autoStart) {
        console.log('üîÑ Auto-starting Program Manager...');
        setTimeout(() => {
            launchAppDirectly(programManagerApp);
        }, 1000);
    }
}

// NUEVA FUNCI√ìN: Asegurar que Program Manager est√© siempre fijado
function ensureProgramManagerPinned() {
    const pinnedApps = getPinnedApps();
    const programManagerPinned = pinnedApps.some(app => app.name === 'Program Manager');
    
    if (!programManagerPinned) {
        console.log('üìå Fijando Program Manager permanentemente en taskbar...');
        pinToTaskbar(programManagerApp);
    } else {
        console.log('‚úÖ Program Manager ya est√° fijado en taskbar');
    }
}

function getPinnedApps() {
    return JSON.parse(localStorage.getItem('wineboxPinnedApps') || '[]');
}

function savePinnedApps(pinnedApps) {
    localStorage.setItem('wineboxPinnedApps', JSON.stringify(pinnedApps));
}

function pinToTaskbar(app) {
    const pinnedApps = getPinnedApps();
    
    // Verificar si ya est√° fijada
    const alreadyPinned = pinnedApps.some(pinned => pinned.name === app.name);
    
    if (!alreadyPinned) {
        pinnedApps.push(app);
        savePinnedApps(pinnedApps);
        updateTaskbarPinnedApps();
        console.log('üìå App pinned to taskbar:', app.name);
    } else {
        console.log('üìå App already pinned:', app.name);
    }
}

function unpinFromTaskbar(appName) {
    // No permitir desfijar Program Manager
    if (appName === 'Program Manager') {
        console.log('‚ùå Cannot unpin Program Manager');
        return;
    }
    
    let pinnedApps = getPinnedApps();
    pinnedApps = pinnedApps.filter(app => app.name !== appName);
    savePinnedApps(pinnedApps);
    updateTaskbarPinnedApps();
    console.log('üìå App unpinned from taskbar:', appName);
}

// Modificar la funci√≥n updateTaskbarPinnedApps para mejor manejo de errores
function updateTaskbarPinnedApps() {
    const dockbarApps = document.getElementById('dockbarApps');
    if (!dockbarApps) {
        console.warn('‚ùå dockbarApps no encontrado, reintentando...');
        setTimeout(updateTaskbarPinnedApps, 500);
        return;
    }
    
    const pinnedApps = getPinnedApps();
    
    // Limpiar solo los iconos fijados existentes (no las ventanas abiertas)
    const existingPinnedIcons = dockbarApps.querySelectorAll('.dockbar-pinned');
    existingPinnedIcons.forEach(icon => {
        // No remover Program Manager si ya existe
        const appName = icon.getAttribute('data-app-name');
        if (appName !== 'Program Manager') {
            icon.remove();
        }
    });
    
    // Agregar apps fijadas al inicio de la taskbar
    pinnedApps.forEach(app => {
        // Verificar si ya existe antes de agregar
        const existingIcon = dockbarApps.querySelector(`.dockbar-pinned[data-app-name="${app.name}"]`);
        if (!existingIcon) {
            const pinnedIcon = createPinnedAppIcon(app);
            dockbarApps.insertBefore(pinnedIcon, dockbarApps.firstChild);
            console.log(`‚úÖ Icono fijado agregado: ${app.name}`);
        }
    });
}

function createPinnedAppIcon(app) {
    const iconElement = document.createElement('div');
    iconElement.className = 'dockbar-app-icon dockbar-pinned';
    iconElement.setAttribute('data-title', app.name);
    iconElement.setAttribute('data-app-name', app.name);
    
    // Usar icono espec√≠fico para Program Manager, icono gen√©rico para otras apps
    const iconUrl = app.name === 'Program Manager' 
        ? 'http://winebox.cloud/src/icons/fileExplorer.png'
        : app.image;
    
    iconElement.innerHTML = `
        <img src="${iconUrl}" alt="${app.name}" 
             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzQiIGhlaWdodD0iMzQiIHZpZXdCb3g9IjAgMCAzNCAzNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjM0IiBoZWlnaHQ9IjM0IiBmaWxsPSIjMzMzMzMzIiByeD0iNCIvPgo8dGV4dCB4PSIxNyIgeT0iMTciIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5BcHA8L3RleHQ+Cjwvc3ZnPgo='">
    `;
    
    iconElement.addEventListener('click', () => {
        launchAppDirectly(app);
    });
    
    // Context menu para desfijar (excepto para Program Manager)
    if (app.name !== 'Program Manager') {
        iconElement.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showUnpinContextMenu(app.name, e.clientX, e.clientY);
        });
    }
    
    return iconElement;
}

function showUnpinContextMenu(appName, x, y) {
    // No permitir desfijar Program Manager
    if (appName === 'Program Manager') {
        return;
    }
    
    // Remover men√∫ contextual existente
    const existingMenu = document.getElementById('unpinContextMenu');
    if (existingMenu) {
        existingMenu.remove();
    }
    
    const contextMenu = document.createElement('div');
    contextMenu.id = 'unpinContextMenu';
    contextMenu.style.cssText = `
        position: fixed;
        left: ${x}px;
        top: ${y}px;
        background: #2f2f2f;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 8px 0;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        min-width: 150px;
    `;
    
    const unpinOption = document.createElement('div');
    unpinOption.style.cssText = `
        padding: 8px 16px;
        cursor: pointer;
        color: white;
        font-size: 14px;
        transition: background 0.2s;
    `;
    unpinOption.textContent = `Unpin "${appName}"`;
    unpinOption.addEventListener('mouseenter', () => {
        unpinOption.style.background = '#0078d4';
    });
    unpinOption.addEventListener('mouseleave', () => {
        unpinOption.style.background = 'transparent';
    });
    unpinOption.addEventListener('click', () => {
        unpinFromTaskbar(appName);
        contextMenu.remove();
    });
    
    contextMenu.appendChild(unpinOption);
    document.body.appendChild(contextMenu);
    
    // Cerrar men√∫ al hacer click fuera
    const closeMenu = (e) => {
        if (!contextMenu.contains(e.target)) {
            contextMenu.remove();
            document.removeEventListener('click', closeMenu);
        }
    };
    
    setTimeout(() => {
        document.addEventListener('click', closeMenu);
    }, 100);
}

// ========== FUNCI√ìN PARA INICIALIZAR PROGRAM MANAGER FIJO ==========
function initFixedProgramManager() {
    console.log('üîß Inicializando Program Manager fijo...');
    
    // Asegurar que Program Manager est√© en la lista de apps fijadas
    ensureProgramManagerPinned();
    
    // Actualizar la taskbar inmediatamente
    updateTaskbarPinnedApps();
    
    // Verificar nuevamente despu√©s de que la interfaz cargue completamente
    setTimeout(() => {
        ensureProgramManagerPinned();
        updateTaskbarPinnedApps();
    }, 1000);
}

// NUEVA FUNCI√ìN: Verificar estado del Program Manager peri√≥dicamente
function monitorProgramManagerStatus() {
    setInterval(() => {
        const pinnedApps = getPinnedApps();
        const programManagerPinned = pinnedApps.some(app => app.name === 'Program Manager');
        
        if (!programManagerPinned) {
            console.warn('‚ö†Ô∏è Program Manager no est√° fijado, reparando...');
            ensureProgramManagerPinned();
            updateTaskbarPinnedApps();
        }
    }, 5000); // Verificar cada 5 segundos
}

// ========== FUNCIONES PARA PANTALLA COMPLETA ==========
function initStartupScreen() {
    startupScreen = document.getElementById('startupScreen');
    startButton = document.getElementById('startButton');
    fullscreenToggle = document.getElementById('fullscreenToggle');
    const aboutStartupButton = document.getElementById('aboutStartupButton');
    
    if (startButton) {
        startButton.addEventListener('click', function() {
            // Intentar entrar en pantalla completa
            enterFullscreen();
            
            // Ocultar pantalla de inicio despu√©s de un breve retraso
            setTimeout(function() {
                if (startupScreen) {
                    startupScreen.classList.add('hidden');
                }
            }, 800);
        });
        
        // Permitir activar con Enter
        startButton.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                startButton.click();
            }
        });
    }
    
    // ========== BOT√ìN ABOUT US EN STARTUP ==========
    if (aboutStartupButton) {
        aboutStartupButton.addEventListener('click', function() {
            // Redirigir a about.html
            window.location.href = 'about.html';
        });
        
        aboutStartupButton.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                window.location.href = 'about.html';
            }
        });
    }
    
    if (fullscreenToggle) {
        fullscreenToggle.addEventListener('click', toggleFullscreen);
        
        fullscreenToggle.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (document.activeElement === fullscreenToggle) {
                    toggleFullscreen();
                }
            }
        });
    }
    
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('MSFullscreenChange', handleFullscreenChange);
}

// ========== SISTEMA DE EULA (AVISO LEGAL) ==========
function initEULA() {
    // Verificar si el usuario ya acept√≥ el EULA
    const eulaAccepted = localStorage.getItem('wineboxEulaAccepted');
    
    if (!eulaAccepted) {
        // Configurar evento para el bot√≥n START
        const startButton = document.getElementById('startButton');
        const originalStartClick = startButton.onclick;
        
        startButton.onclick = function(e) {
            e.preventDefault();
            showEULAModal();
        };
    }
}

function showEULAModal() {
    const eulaModal = document.getElementById('eulaModal');
    const startupScreen = document.getElementById('startupScreen');
    
    if (!eulaModal) return;
    
    // Ocultar pantalla de inicio
    if (startupScreen) {
        startupScreen.style.display = 'none';
    }
    
    // Mostrar modal EULA
    eulaModal.classList.add('active');
    
    // Configurar botones
    const agreeBtn = document.getElementById('eulaAgree');
    const disagreeBtn = document.getElementById('eulaDisagree');
    
    if (agreeBtn) {
        agreeBtn.addEventListener('click', acceptEULA);
    }
    
    if (disagreeBtn) {
        disagreeBtn.addEventListener('click', rejectEULA);
    }
    
    // Configurar navegaci√≥n por teclado
    document.addEventListener('keydown', handleEULAKeydown);
}

function hideEULAModal() {
    const eulaModal = document.getElementById('eulaModal');
    if (eulaModal) {
        eulaModal.classList.remove('active');
        document.removeEventListener('keydown', handleEULAKeydown);
    }
}

function acceptEULA() {
    // Guardar aceptaci√≥n en localStorage
    localStorage.setItem('wineboxEulaAccepted', 'true');
    
    // Ocultar modal
    hideEULAModal();
    
    // Continuar con el inicio normal
    continueStartupProcess();
    
    showStatusMessage('EULA accepted. Welcome to WineBOX!', 'success');
}

function rejectEULA() {
    // No guardar aceptaci√≥n
    hideEULAModal();
    
    // Mostrar mensaje y cerrar
    const startupScreen = document.getElementById('startupScreen');
    if (startupScreen) {
        startupScreen.style.display = 'flex';
        startupScreen.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <h2 style="color: #ff6b6b;">EULA Not Accepted</h2>
                <p style="color: rgba(255, 255, 255, 0.7); margin: 20px 0;">
                    WineBOX requires acceptance of the End User License Agreement to operate.
                </p>
                <p style="color: rgba(255, 255, 255, 0.5); font-size: 14px; margin: 20px 0;">
                    The application will now close.
                </p>
                <button onclick="location.reload()" 
                        style="margin-top: 20px; padding: 12px 30px; background: #0078d4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">
                    Restart WineBOX
                </button>
            </div>
        `;
    }
    
    console.log('‚ùå EULA rejected by user');
}

function continueStartupProcess() {
    const startupScreen = document.getElementById('startupScreen');
    
    // Intentar entrar en pantalla completa
    enterFullscreen();
    
    // Ocultar pantalla de inicio despu√©s de un breve retraso
    setTimeout(function() {
        if (startupScreen) {
            startupScreen.classList.add('hidden');
        }
    }, 800);
}

function handleEULAKeydown(e) {
    const eulaModal = document.getElementById('eulaModal');
    if (!eulaModal || !eulaModal.classList.contains('active')) return;
    
    switch(e.key) {
        case 'Escape':
            e.preventDefault();
            // No permitir cerrar con Escape, debe aceptar o rechazar
            break;
            
        case 'ArrowLeft':
        case 'ArrowRight':
            e.preventDefault();
            // Opcional: Navegaci√≥n entre botones
            const agreeBtn = document.getElementById('eulaAgree');
            const disagreeBtn = document.getElementById('eulaDisagree');
            
            if (document.activeElement === agreeBtn) {
                disagreeBtn.focus();
            } else if (document.activeElement === disagreeBtn) {
                agreeBtn.focus();
            } else {
                agreeBtn.focus();
            }
            break;
            
        case 'Enter':
            e.preventDefault();
            if (document.activeElement === document.getElementById('eulaAgree')) {
                acceptEULA();
            } else if (document.activeElement === document.getElementById('eulaDisagree')) {
                rejectEULA();
            }
            break;
    }
}

function enterFullscreen() {
    const element = document.documentElement;
    
    if (element.requestFullscreen) {
        element.requestFullscreen();
    } else if (element.webkitRequestFullscreen) {
        element.webkitRequestFullscreen();
    } else if (element.mozRequestFullScreen) {
        element.mozRequestFullScreen();
    } else if (element.msRequestFullscreen) {
        element.msRequestFullscreen();
    }
}

function exitFullscreen() {
    if (document.exitFullscreen) {
        document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
    } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
    } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
    }
}

function toggleFullscreen() {
    if (isFullscreen) {
        exitFullscreen();
    } else {
        enterFullscreen();
    }
}

function handleFullscreenChange() {
    isFullscreen = !!(document.fullscreenElement || 
                     document.webkitFullscreenElement || 
                     document.mozFullScreenElement || 
                     document.msFullscreenElement);
    
    if (fullscreenToggle) {
        if (isFullscreen) {
            fullscreenToggle.classList.add('fullscreen-active');
            fullscreenToggle.setAttribute('title', 'Exit fullscreen');
        } else {
            fullscreenToggle.classList.remove('fullscreen-active');
            fullscreenToggle.setAttribute('title', 'Fullscreen');
        }
    }
}

// ========== NAVEGACI√ìN EN PANTALLA DE INICIO WINDOWS 11 ==========
function handleWindows11StartupKeydown(e) {
    const startupScreen = document.getElementById('startupScreen');
    if (!startupScreen || startupScreen.classList.contains('hidden')) return;
    
    const eulaModal = document.getElementById('eulaModal');
    if (eulaModal && eulaModal.classList.contains('active')) return;
    
    const startBtn = document.getElementById('startButton');
    const aboutBtn = document.getElementById('aboutStartupButton');
    
    switch(e.key) {
        case 'Tab':
            e.preventDefault();
            playNavSound();
            if (document.activeElement === startBtn) {
                aboutBtn.focus();
            } else {
                startBtn.focus();
            }
            break;
            
        case 'Enter':
            if (document.activeElement === aboutBtn) {
                e.preventDefault();
                playNavSound();
                window.location.href = 'about.html';
            }
            break;
            
        case ' ':
            if (document.activeElement === aboutBtn) {
                e.preventDefault();
                playNavSound();
                window.location.href = 'about.html';
            }
            break;
            
        case 'Escape':
            // Opcional: Podr√≠as agregar funcionalidad extra aqu√≠
            // Por ejemplo, mostrar un men√∫ con m√°s opciones
            break;
    }
}

// ========== FUNCIONES PARA SHUTDOWN ==========
function showShutdownConfirm() {
    currentShutdownConfirm = true;
    currentShutdownButtonIndex = 0;
    document.getElementById('shutdownConfirm').classList.add('active');
    updateShutdownSelection();
}

function hideShutdownConfirm() {
    document.getElementById('shutdownConfirm').classList.remove('active');
    currentShutdownConfirm = false;
    currentShutdownButtonIndex = 0;
}

function executeShutdown() {
    console.log('üîÑ Initiating shutdown sequence...');
    
    // 1. Salir del modo pantalla completa si est√° activo
    if (isFullscreen) {
        exitFullscreen();
    }
    
    // 2. Cerrar todas las ventanas abiertas
    if (taskManager.openWindows.length > 0) {
        taskManager.openWindows.forEach(window => {
            closeWindow(window.id);
        });
    }
    
    // 3. Mostrar mensaje de estado
    showStatusMessage('Shutting down WineBOX...', 'warning');
    
    // 4. Redirigir despu√©s de un breve delay para que el usuario vea el mensaje
    setTimeout(() => {
        console.log('‚úÖ Redirecting to shutdown page...');
        window.location.href = 'http://winebox.cloud/src/redirects/shutdown/logoff.html';
    }, 1500);
}

function updateShutdownSelection() {
    const shutdownButtons = document.querySelectorAll('.shutdown-confirm-buttons .action-button');
    shutdownButtons.forEach((button, index) => {
        button.classList.remove('selected');
        if (index === currentShutdownButtonIndex) {
            button.classList.add('selected');
        }
    });
}

function handleShutdownKeydown(e) {
    const shutdownDialog = document.getElementById('shutdownConfirm');
    if (!shutdownDialog || !shutdownDialog.classList.contains('active')) return;
    
    const shutdownButtons = document.querySelectorAll('.shutdown-confirm-buttons .action-button');
    if (shutdownButtons.length === 0) return;
    
    switch(e.key) {
        case 'ArrowLeft':
        case 'ArrowRight':
            e.preventDefault();
            playNavSound();
            currentShutdownButtonIndex = currentShutdownButtonIndex === 0 ? 1 : 0;
            updateShutdownSelection();
            break;
            
        case 'Enter':
            e.preventDefault();
            playNavSound();
            if (currentShutdownButtonIndex === 0) {
                executeShutdown();
            } else {
                hideShutdownConfirm();
            }
            break;
            
        case 'Escape':
            e.preventDefault();
            playNavSound();
            hideShutdownConfirm();
            break;
    }
}

// ========== FUNCIONES DE SETTINGS ==========
function showSettings() {
    isSettingsOpen = true;
    document.getElementById('settingsSection').classList.add('active');
    currentSettingsTabIndex = 0;
    settingsTabs = Array.from(document.querySelectorAll('.settings-tab'));
    updateSettingsSelection();
}

function hideSettings() {
    isSettingsOpen = false;
    document.getElementById('settingsSection').classList.remove('active');
    currentSettingsTabIndex = 0;
}

function updateSettingsSelection() {
    settingsTabs.forEach((tab, index) => {
        tab.classList.remove('active');
        if (index === currentSettingsTabIndex) {
            tab.classList.add('active');
            const tabId = tab.getAttribute('data-tab');
            showSettingsPanel(tabId);
        }
    });
}

function showSettingsPanel(panelId) {
    const panels = document.querySelectorAll('.settings-panel');
    panels.forEach(panel => {
        panel.classList.remove('active');
        if (panel.id === panelId + 'Panel') {
            panel.classList.add('active');
        }
    });
}

function handleSettingsKeydown(e) {
    if (!isSettingsOpen) return;

    switch(e.key) {
        case 'ArrowUp':
            e.preventDefault();
            playNavSound();
            if (currentSettingsTabIndex > 0) {
                currentSettingsTabIndex--;
            } else {
                currentSettingsTabIndex = settingsTabs.length - 1;
            }
            updateSettingsSelection();
            break;
            
        case 'ArrowDown':
            e.preventDefault();
            playNavSound();
            if (currentSettingsTabIndex < settingsTabs.length - 1) {
                currentSettingsTabIndex++;
            } else {
                currentSettingsTabIndex = 0;
            }
            updateSettingsSelection();
            break;
            
        case 'Enter':
            e.preventDefault();
            playNavSound();
            const activeTab = settingsTabs[currentSettingsTabIndex];
            if (activeTab) {
                const tabId = activeTab.getAttribute('data-tab');
                showSettingsPanel(tabId);
            }
            break;
            
        case 'Escape':
            e.preventDefault();
            playNavSound();
            hideSettings();
            break;
    }
}

function applySettings() {
    const settings = {
        backgroundColor: document.getElementById('backgroundColor').value,
        backgroundImage: localStorage.getItem('wineboxBackgroundImage') || '',
        iconSize: document.getElementById('iconSize').value,
        animations: document.getElementById('animations').checked,
        autoStart: document.getElementById('autoStart').checked,
        showStartup: document.getElementById('showStartup').checked
    };

    // Aplicar configuraci√≥n
    document.body.style.backgroundColor = settings.backgroundColor;

    if (settings.backgroundImage) {
        document.body.style.backgroundImage = `url(${settings.backgroundImage})`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
        document.body.style.backgroundAttachment = 'fixed';
    } else {
        document.body.style.backgroundImage = 'none';
    }

    // Aplicar tama√±o de iconos
    document.documentElement.style.setProperty('--icon-size', settings.iconSize + 'px');
    document.querySelectorAll('.recent-app').forEach(icon => {
        icon.style.width = settings.iconSize + 'px';
        icon.style.height = settings.iconSize + 'px';
    });

    // NUEVO: Manejar auto-start del Program Manager
    if (settings.autoStart) {
        console.log('‚úÖ Program Manager set to auto-start');
    } else {
        console.log('‚ùå Program Manager auto-start disabled');
    }

    // Guardar configuraci√≥n
    localStorage.setItem('wineboxSettings', JSON.stringify(settings));
    
    showStatusMessage('Settings applied successfully', 'success');
}

function resetSettings() {
    const defaultSettings = {
        backgroundColor: '#141414',
        backgroundImage: '',
        iconSize: 160,
        animations: true,
        autoStart: false, // Por defecto desactivado
        showStartup: true
    };

    // Restablecer controles
    document.getElementById('backgroundColor').value = defaultSettings.backgroundColor;
    document.getElementById('iconSize').value = defaultSettings.iconSize;
    document.getElementById('animations').checked = defaultSettings.animations;
    document.getElementById('autoStart').checked = defaultSettings.autoStart;
    document.getElementById('showStartup').checked = defaultSettings.showStartup;

    // NO desfijar Program Manager al resetear - siempre debe estar fijo
    console.log('üìå Program Manager permanece fijado tras reset');

    // Actualizar valores mostrados
    updateSettingsValues();
    
    showStatusMessage('Settings reset to defaults', 'success');
}

function loadSettings() {
    const savedSettings = localStorage.getItem('wineboxSettings');
    if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        
        // Cargar valores en los controles
        document.getElementById('backgroundColor').value = settings.backgroundColor || '#141414';
        document.getElementById('iconSize').value = settings.iconSize || 160;
        document.getElementById('animations').checked = settings.animations !== false;
        document.getElementById('autoStart').checked = settings.autoStart || false;
        document.getElementById('showStartup').checked = settings.showStartup !== false;

        // Aplicar configuraci√≥n cargada
        applySettings();
    }
    
    updateSettingsValues();
}

function updateSettingsValues() {
    document.getElementById('iconSizeValue').textContent = document.getElementById('iconSize').value + 'px';
    document.getElementById('colorPreview').style.backgroundColor = document.getElementById('backgroundColor').value;
}

function initSettings() {
    // Cargar configuraci√≥n guardada
    loadSettings();

    // Event listeners para controles
    document.getElementById('backgroundColor').addEventListener('input', function() {
        document.getElementById('colorPreview').style.backgroundColor = this.value;
    });

    document.getElementById('iconSize').addEventListener('input', function() {
        document.getElementById('iconSizeValue').textContent = this.value + 'px';
    });

    document.getElementById('backgroundImageUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;
                localStorage.setItem('wineboxBackgroundImage', imageUrl);
                document.getElementById('backgroundPreview').style.backgroundImage = `url(${imageUrl})`;
                showStatusMessage('Background image uploaded successfully', 'success');
            };
            reader.readAsDataURL(file);
        }
    });

    // Botones de acci√≥n
    document.getElementById('applySettings').addEventListener('click', applySettings);
    document.getElementById('resetSettings').addEventListener('click', resetSettings);
    document.getElementById('settingsClose').addEventListener('click', hideSettings);

    // Cargar imagen de fondo si existe
    const savedBackground = localStorage.getItem('wineboxBackgroundImage');
    if (savedBackground) {
        document.getElementById('backgroundPreview').style.backgroundImage = `url(${savedBackground})`;
    }

    // Event listeners para tabs
    settingsTabs = Array.from(document.querySelectorAll('.settings-tab'));
    settingsTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            currentSettingsTabIndex = settingsTabs.indexOf(this);
            updateSettingsSelection();
        });
    });
}

// ========== CORRECCI√ìN COMPLETA DEL SISTEMA DE CATEGOR√çAS ==========
function handleCategorySelection(category) {
    if (category === 'settings') {
        showSettings();
        return;
    }
    
    currentCategory = category;
    let filteredApps = [];
    
    // Ocultar/mostrar secciones seg√∫n la categor√≠a seleccionada
    const recentSection = document.getElementById('recentSection');
    const categoriesSection = document.getElementById('categoriesSection');
    const appsSection = document.getElementById('appsSection');
    
    // Resetear todas las secciones primero
    if (recentSection) recentSection.classList.remove('hidden');
    if (categoriesSection) categoriesSection.classList.remove('hidden');
    if (appsSection) appsSection.classList.remove('hidden');
    
    if (category === 'all') {
        // MOSTRAR TODO - comportamiento normal
        filteredApps = appData;
        if (recentSection) recentSection.classList.remove('hidden');
        if (categoriesSection) categoriesSection.classList.remove('hidden');
        if (appsSection) appsSection.classList.remove('hidden');
        
        // Restaurar altura normal
        if (appsSection) appsSection.classList.remove('full-height');
        
    } else if (category === 'uninstall') {
        // SOLO APPS INSTALADAS - ocultar recientes y categor√≠as
        filteredApps = getInstalledApps();
        if (recentSection) recentSection.classList.add('hidden');
        if (categoriesSection) categoriesSection.classList.add('hidden');
        if (appsSection) appsSection.classList.remove('hidden');
        
        // Expandir altura
        if (appsSection) appsSection.classList.add('full-height');
        
    } else if (category === 'shutdown') {
        // NUEVO: Mostrar di√°logo de shutdown
        showShutdownConfirm();
        return; // No necesitamos actualizar apps para esta categor√≠a
        
    } else {
        // CATEGOR√çA ESPEC√çFICA - ocultar solo recientes
        filteredApps = appData.filter(app => app.category === category);
        if (recentSection) recentSection.classList.add('hidden');
        if (categoriesSection) categoriesSection.classList.remove('hidden');
        if (appsSection) appsSection.classList.remove('hidden');
        
        // Expandir altura
        if (appsSection) appsSection.classList.add('full-height');
    }
    
    // Actualizar display de apps
    displayApps(filteredApps);
    
    // Resetear √≠ndices de navegaci√≥n
    currentSelectedIndex = 0;
    currentFocusArea = 'apps';
    currentSection = 'apps';
    
    // Actualizar selecci√≥n visual
    updateMenuSelection(category);
    updateSectionDisplay();
    
    // Scroll a la parte superior
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Actualizar visibilidad del scrollbar despu√©s de un breve delay
    setTimeout(updateCategoryScrollVisibility, 150);
}

// ========== CORRECCI√ìN DE LA ACTUALIZACI√ìN DE SELECCI√ìN DEL MEN√ö ==========
function updateMenuSelection(category) {
    // Remover clase active de todos los items del men√∫
    const menuItems = document.querySelectorAll('.menu-item');
    menuItems.forEach(item => {
        item.classList.remove('active');
    });
    
    // Agregar clase active al item seleccionado
    const selectedItem = document.querySelector(`.menu-item[data-category="${category}"]`);
    if (selectedItem) {
        selectedItem.classList.add('active');
    }
    
    // Actualizar botones de categor√≠a tambi√©n
    const categoryButtons = document.querySelectorAll('.category-button');
    categoryButtons.forEach(button => {
        button.classList.remove('active');
        if (button.getAttribute('data-category') === category) {
            button.classList.add('active');
        }
    });
}

// ========== MODIFICAR LA FUNCI√ìN DE ACTUALIZACI√ìN DE SECCIONES ==========
function updateSectionDisplay() {
    // Esta funci√≥n ahora maneja la visibilidad basada en currentCategory
    const recentSection = document.getElementById('recentSection');
    const categoriesSection = document.getElementById('categoriesSection');
    const appsSection = document.getElementById('appsSection');
    
    if (currentCategory === 'all') {
        // Mostrar todo
        if (recentSection) {
            recentSection.classList.remove('hidden');
            recentSection.classList.add('active');
        }
        if (categoriesSection) {
            categoriesSection.classList.remove('hidden');
            categoriesSection.classList.add('active');
        }
        if (appsSection) {
            appsSection.classList.remove('hidden');
            appsSection.classList.add('active');
            appsSection.classList.remove('full-height');
        }
    } else if (currentCategory === 'uninstall') {
        // Solo apps instaladas
        if (recentSection) {
            recentSection.classList.add('hidden');
            recentSection.classList.remove('active');
        }
        if (categoriesSection) {
            categoriesSection.classList.add('hidden');
            categoriesSection.classList.remove('active');
        }
        if (appsSection) {
            appsSection.classList.remove('hidden');
            appsSection.classList.add('active');
            appsSection.classList.add('full-height');
        }
    } else if (currentCategory === 'shutdown') {
        // Para shutdown, mantener la vista actual
        return;
    } else {
        // Categor√≠a espec√≠fica
        if (recentSection) {
            recentSection.classList.add('hidden');
            recentSection.classList.remove('active');
        }
        if (categoriesSection) {
            categoriesSection.classList.remove('hidden');
            categoriesSection.classList.add('active');
        }
        if (appsSection) {
            appsSection.classList.remove('hidden');
            appsSection.classList.add('active');
            appsSection.classList.add('full-height');
        }
    }
    
    updateFocusForSection();
}

// ========== ACTUALIZACI√ìN DE LA FUNCI√ìN DE SCROLL DE CATEGOR√çAS ==========
function updateCategoryScrollVisibility() {
    const appsSection = document.getElementById('appsSection');
    const appCards = document.querySelectorAll('.app-card');
    
    if (!appsSection || !categoryScrollbar) return;
    
    // Mostrar scrollbar solo si hay m√°s de 4 aplicaciones
    if (appCards.length > 4) {
        categoryScrollbar.classList.add('visible');
        categoryScrollbar.classList.remove('hidden');
    } else {
        categoryScrollbar.classList.remove('visible');
        categoryScrollbar.classList.add('hidden');
    }
    
    updateCategoryScrollThumb();
}

// ========== INICIALIZACI√ìN DEL SCROLL DE CATEGOR√çAS ==========
function initCategoryScroll() {
    categoryScrollbar = document.getElementById('categoryScrollbar');
    categoryScrollThumb = document.getElementById('categoryScrollThumb');
    
    if (!categoryScrollbar || !categoryScrollThumb) return;
    
    // Usar la nueva funci√≥n de visibilidad
    updateCategoryScrollVisibility();
    
    // Eventos para el thumb del scrollbar
    categoryScrollThumb.addEventListener('mousedown', startCategoryScroll);
    categoryScrollThumb.addEventListener('touchstart', startCategoryScrollTouch);
    
    // Eventos para el track del scrollbar
    categoryScrollbar.addEventListener('click', handleCategoryScrollbarClick);
    
    // Observar cambios en la lista de apps
    const appsObserver = new MutationObserver(updateCategoryScrollVisibility);
    const appsSection = document.getElementById('appsSection');
    if (appsSection) {
        appsObserver.observe(appsSection, {
            childList: true,
            subtree: true
        });
    }
    
    // Actualizar posici√≥n inicial del thumb
    updateCategoryScrollThumb();
}

function startCategoryScroll(e) {
    e.preventDefault();
    isCategoryScrolling = true;
    categoryScrollStartY = e.clientY;
    categoryScrollStartTop = parseFloat(categoryScrollThumb.style.top) || 0;
    
    document.addEventListener('mousemove', handleCategoryScroll);
    document.addEventListener('mouseup', stopCategoryScroll);
}

function startCategoryScrollTouch(e) {
    if (e.touches.length !== 1) return;
    e.preventDefault();
    isCategoryScrolling = true;
    categoryScrollStartY = e.touches[0].clientY;
    categoryScrollStartTop = parseFloat(categoryScrollThumb.style.top) || 0;
    
    document.addEventListener('touchmove', handleCategoryScrollTouch);
    document.addEventListener('touchend', stopCategoryScroll);
}

function handleCategoryScroll(e) {
    if (!isCategoryScrolling) return;
    
    const deltaY = e.clientY - categoryScrollStartY;
    const scrollbarHeight = categoryScrollbar.clientHeight;
    const thumbHeight = categoryScrollThumb.clientHeight;
    const maxThumbTop = scrollbarHeight - thumbHeight;
    
    let newTop = categoryScrollStartTop + deltaY;
    newTop = Math.max(0, Math.min(newTop, maxThumbTop));
    
    categoryScrollThumb.style.top = newTop + 'px';
    
    // Calcular posici√≥n de scroll
    const scrollRatio = newTop / maxThumbTop;
    const appsSection = document.getElementById('appsSection');
    const maxScroll = appsSection.scrollHeight - appsSection.clientHeight;
    appsSection.scrollTop = scrollRatio * maxScroll;
}

function handleCategoryScrollTouch(e) {
    if (!isCategoryScrolling || e.touches.length !== 1) return;
    
    const deltaY = e.touches[0].clientY - categoryScrollStartY;
    const scrollbarHeight = categoryScrollbar.clientHeight;
    const thumbHeight = categoryScrollThumb.clientHeight;
    const maxThumbTop = scrollbarHeight - thumbHeight;
    
    let newTop = categoryScrollStartTop + deltaY;
    newTop = Math.max(0, Math.min(newTop, maxThumbTop));
    
    categoryScrollThumb.style.top = newTop + 'px';
    
    // Calcular posici√≥n de scroll
    const scrollRatio = newTop / maxThumbTop;
    const appsSection = document.getElementById('appsSection');
    const maxScroll = appsSection.scrollHeight - appsSection.clientHeight;
    appsSection.scrollTop = scrollRatio * maxScroll;
}

function stopCategoryScroll() {
    isCategoryScrolling = false;
    document.removeEventListener('mousemove', handleCategoryScroll);
    document.removeEventListener('touchmove', handleCategoryScrollTouch);
    document.removeEventListener('mouseup', stopCategoryScroll);
    document.removeEventListener('touchend', stopCategoryScroll);
}

function handleCategoryScrollbarClick(e) {
    if (e.target === categoryScrollbar) {
        const scrollbarRect = categoryScrollbar.getBoundingClientRect();
        const clickY = e.clientY - scrollbarRect.top;
        const scrollbarHeight = categoryScrollbar.clientHeight;
        const thumbHeight = categoryScrollThumb.clientHeight;
        
        let newTop = clickY - (thumbHeight / 2);
        const maxThumbTop = scrollbarHeight - thumbHeight;
        newTop = Math.max(0, Math.min(newTop, maxThumbTop));
        
        categoryScrollThumb.style.top = newTop + 'px';
        
        // Calcular posici√≥n de scroll
        const scrollRatio = newTop / maxThumbTop;
        const appsSection = document.getElementById('appsSection');
        const maxScroll = appsSection.scrollHeight - appsSection.clientHeight;
        appsSection.scrollTop = scrollRatio * maxScroll;
    }
}

function updateCategoryScrollThumb() {
    const appsSection = document.getElementById('appsSection');
    if (!appsSection || !categoryScrollThumb) return;
    
    const scrollTop = appsSection.scrollTop;
    const scrollHeight = appsSection.scrollHeight;
    const clientHeight = appsSection.clientHeight;
    
    if (scrollHeight <= clientHeight) {
        categoryScrollThumb.style.height = '100%';
        categoryScrollThumb.style.top = '0';
        return;
    }
    
    const thumbHeight = Math.max((clientHeight / scrollHeight) * categoryScrollbar.clientHeight, 20);
    const maxThumbTop = categoryScrollbar.clientHeight - thumbHeight;
    const thumbTop = (scrollTop / (scrollHeight - clientHeight)) * maxThumbTop;
    
    categoryScrollThumb.style.height = thumbHeight + 'px';
    categoryScrollThumb.style.top = thumbTop + 'px';
}

// ========== SISTEMA H√çBRIDO DE SCROLL (T√ÅCTIL + BOTONES) ==========

// ========== FUNCIONES PARA DESPLAZAR CON BOTONES ==========
function initScrollButtons() {
    const scrollLeftBtn = document.getElementById('scrollLeft');
    const scrollRightBtn = document.getElementById('scrollRight');
    const recentAppsEl = document.getElementById('recentApps');
    const recentAppsContainer = document.getElementById('recentAppsContainer');
    
    if (!scrollLeftBtn || !scrollRightBtn || !recentAppsEl) {
        console.warn('‚ùå Elementos de botones de scroll no encontrados');
        return;
    }
    
    // Configurar desplazamiento con flecha izquierda
    scrollLeftBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevenir eventos del padre
        scrollRecentApps(-1);
    });
    
    // Configurar desplazamiento con flecha derecha
    scrollRightBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevenir eventos del padre
        scrollRecentApps(1);
    });
    
    // Tambi√©n permitir navegaci√≥n con teclado en las flechas
    scrollLeftBtn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            scrollRecentApps(-1);
        }
    });
    
    scrollRightBtn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            scrollRecentApps(1);
        }
    });
    
    // Hacer las flechas enfocables para accesibilidad
    scrollLeftBtn.tabIndex = 0;
    scrollRightBtn.tabIndex = 0;
    
    console.log('‚úÖ Botones de desplazamiento inicializados');
}

function scrollRecentApps(direction) {
    const recentAppsEl = document.getElementById('recentApps');
    if (!recentAppsEl) return;
    
    const scrollAmount = 300; // Cantidad de desplazamiento en p√≠xeles
    const targetScroll = recentAppsEl.scrollLeft + (scrollAmount * direction);
    
    // Desplazamiento suave
    recentAppsEl.scrollTo({
        left: targetScroll,
        behavior: 'smooth'
    });
    
    // Actualizar flechas despu√©s de un breve retraso
    setTimeout(updateScrollArrows, 300);
    
    playNavSound(); // Sonido de navegaci√≥n
}

// ========== SCROLL T√ÅCTIL SIMPLIFICADO (MANTENIENDO FUNCIONALIDAD EXISTENTE) ==========
function initTouchScrollSimple() {
    const recentAppsContainer = document.getElementById('recentAppsContainer');
    const recentAppsEl = document.getElementById('recentApps');
    
    if (!recentAppsContainer || !recentAppsEl) return;
    
    let isDragging = false;
    let startX;
    let scrollLeft;
    
    // Mouse events
    recentAppsContainer.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.pageX - recentAppsContainer.offsetLeft;
        scrollLeft = recentAppsEl.scrollLeft;
        recentAppsContainer.style.cursor = 'grabbing';
    });
    
    recentAppsContainer.addEventListener('mouseleave', () => {
        isDragging = false;
        recentAppsContainer.style.cursor = 'grab';
    });
    
    recentAppsContainer.addEventListener('mouseup', () => {
        isDragging = false;
        recentAppsContainer.style.cursor = 'grab';
    });
    
    recentAppsContainer.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const x = e.pageX - recentAppsContainer.offsetLeft;
        const walk = (x - startX) * 2; // Multiplicador para velocidad
        recentAppsEl.scrollLeft = scrollLeft - walk;
    });
    
    // Touch events (para dispositivos m√≥viles)
    recentAppsContainer.addEventListener('touchstart', (e) => {
        isDragging = true;
        startX = e.touches[0].pageX - recentAppsContainer.offsetLeft;
        scrollLeft = recentAppsEl.scrollLeft;
        recentAppsContainer.style.cursor = 'grabbing';
    }, { passive: true });
    
    recentAppsContainer.addEventListener('touchend', () => {
        isDragging = false;
        recentAppsContainer.style.cursor = 'grab';
    }, { passive: true });
    
    recentAppsContainer.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        const x = e.touches[0].pageX - recentAppsContainer.offsetLeft;
        const walk = (x - startX) * 2;
        recentAppsEl.scrollLeft = scrollLeft - walk;
    }, { passive: true });
    
    // Configurar cursor inicial
    recentAppsContainer.style.cursor = 'grab';
    
    // Permitir scroll con rueda del mouse horizontalmente
    recentAppsContainer.addEventListener('wheel', (e) => {
        e.preventDefault();
        recentAppsEl.scrollLeft += e.deltaY;
    }, { passive: false });
    
    console.log('‚úÖ Scroll t√°ctil inicializado');
}

// ========== SISTEMA INTEGRADO DE SCROLL ==========
function initIntegratedScroll() {
    const recentAppsContainer = document.getElementById('recentAppsContainer');
    const recentAppsEl = document.getElementById('recentApps');
    
    if (!recentAppsContainer || !recentAppsEl) return;
    
    // Inicializar botones de desplazamiento
    initScrollButtons();
    
    // Inicializar scroll t√°ctil
    initTouchScrollSimple();
    
    // Actualizar flechas cuando se hace scroll
    recentAppsEl.addEventListener('scroll', () => {
        updateScrollArrows();
    });
    
    // Actualizar flechas cuando cambia el tama√±o de la ventana
    window.addEventListener('resize', () => {
        setTimeout(updateScrollArrows, 100);
    });
    
    // Actualizar flechas inicialmente
    setTimeout(updateScrollArrows, 500);
    
    console.log('‚úÖ Sistema de desplazamiento integrado inicializado');
}

// ========== MEJORAR LA FUNCI√ìN updateScrollArrows() ==========
function updateScrollArrows() {
    const recentAppsEl = document.getElementById('recentApps');
    const scrollLeftBtn = document.getElementById('scrollLeft');
    const scrollRightBtn = document.getElementById('scrollRight');
    
    if (!recentAppsEl || !scrollLeftBtn || !scrollRightBtn) return;
    
    const scrollLeft = recentAppsEl.scrollLeft;
    const maxScrollLeft = recentAppsEl.scrollWidth - recentAppsEl.clientWidth;
    const threshold = 10; // Umbral para considerar que se lleg√≥ al final
    
    // Siempre mostrar flechas cuando hay contenido para desplazar
    if (maxScrollLeft <= 0) {
        // No hay scroll posible - ocultar ambas flechas
        scrollLeftBtn.classList.add('hidden');
        scrollRightBtn.classList.add('hidden');
    } else {
        // Mostrar u ocultar seg√∫n la posici√≥n
        if (scrollLeft <= threshold) {
            scrollLeftBtn.classList.add('hidden');
        } else {
            scrollLeftBtn.classList.remove('hidden');
        }
        
        if (scrollLeft >= maxScrollLeft - threshold) {
            scrollRightBtn.classList.add('hidden');
        } else {
            scrollRightBtn.classList.remove('hidden');
        }
    }
    
    // Forzar que las flechas sean visibles si hay hover
    const container = recentAppsEl.parentElement;
    if (container && container.matches(':hover')) {
        scrollLeftBtn.style.opacity = scrollLeftBtn.classList.contains('hidden') ? '0' : '0.7';
        scrollRightBtn.style.opacity = scrollRightBtn.classList.contains('hidden') ? '0' : '0.7';
    }
}

// ========== SCROLL F√çSICO PARA LA SECCI√ìN DE APPS ==========
function initAppGridScroll() {
    const appGridContainer = document.getElementById('appsSection');
    
    if (!appGridContainer) return;
    
    // Configurar scroll suave con rueda del mouse
    appGridContainer.addEventListener('wheel', handleAppGridWheel, { passive: false });
    
    // Actualizar scrollbar cuando se hace scroll
    appGridContainer.addEventListener('scroll', function() {
        updateCategoryScrollThumb();
    });
}

function handleAppGridWheel(e) {
    const appGridContainer = document.getElementById('appsSection');
    if (!appGridContainer) return;
    
    // Prevenir scroll vertical por defecto
    e.preventDefault();
    
    // Scroll suave con la rueda del mouse
    appGridContainer.scrollBy({
        top: e.deltaY * 2,
        behavior: 'smooth'
    });
}

// ========== AGREGAR SOPORTE PARA TECLADO EN LAS FLECHAS ==========
function handleRightArrow() {
    if (!keyboardEnabled || isModalOpen) return;
    
    // NUEVO: Si estamos en apps recientes y presionamos flecha derecha
    // mientras la √∫ltima app est√° seleccionada, usar la flecha de scroll
    if (currentFocusArea === 'recent' && recentApps.length > 0) {
        if (currentRecentIndex === recentApps.length - 1) {
            const scrollRightBtn = document.getElementById('scrollRight');
            if (scrollRightBtn && !scrollRightBtn.classList.contains('hidden')) {
                scrollRecentApps(1);
                return;
            }
        }
    }
    
    if (isMenuOpen) {
        if (currentMenuItemIndex < menuItems.length - 1) {
            currentMenuItemIndex++;
            updateSelection();
        }
        return;
    }
    
    if (currentFocusArea === 'header') {
        if (currentHeaderIndex < 2) { // Cambiado de 1 a 2 para incluir el bot√≥n de pantalla completa
            currentHeaderIndex++;
            updateSelection();
        }
    }
    else if (currentFocusArea === 'recent' && recentApps.length > 0) {
        if (currentRecentIndex < recentApps.length - 1) {
            currentRecentIndex++;
            updateSelection();
        } else {
            currentRecentIndex = 0;
            updateSelection();
        }
    }
    else if (currentFocusArea === 'categories') {
        if (currentCategoryIndex < categoryButtons.length - 1) {
            currentCategoryIndex++;
            updateSelection();
        } else {
            currentCategoryIndex = 0;
            updateSelection();
        }
    }
    else if (currentFocusArea === 'apps' && currentApps.length > 0) {
        if (currentSelectedIndex < currentApps.length - 1) {
            currentSelectedIndex++;
            updateSelection();
        } else {
            currentSelectedIndex = 0;
            updateSelection();
        }
    }
}

function handleLeftArrow() {
    if (!keyboardEnabled || isModalOpen) return;
    
    // NUEVO: Si estamos en apps recientes y presionamos flecha izquierda
    // mientras la primera app est√° seleccionada, usar la flecha de scroll
    if (currentFocusArea === 'recent' && recentApps.length > 0) {
        if (currentRecentIndex === 0) {
            const scrollLeftBtn = document.getElementById('scrollLeft');
            if (scrollLeftBtn && !scrollLeftBtn.classList.contains('hidden')) {
                scrollRecentApps(-1);
                return;
            }
        }
    }
    
    if (isMenuOpen) {
        if (currentMenuItemIndex > 0) {
            currentMenuItemIndex--;
            updateSelection();
        }
        return;
    }
    
    if (currentFocusArea === 'header') {
        if (currentHeaderIndex > 0) {
            currentHeaderIndex--;
            updateSelection();
        }
    }
    else if (currentFocusArea === 'recent' && recentApps.length > 0) {
        if (currentRecentIndex > 0) {
            currentRecentIndex--;
            updateSelection();
        } else {
            currentRecentIndex = recentApps.length - 1;
            updateSelection();
        }
    }
    else if (currentFocusArea === 'categories') {
        if (currentCategoryIndex > 0) {
            currentCategoryIndex--;
            updateSelection();
        } else {
            currentCategoryIndex = categoryButtons.length - 1;
            updateSelection();
        }
    }
    else if (currentFocusArea === 'apps' && currentApps.length > 0) {
        if (currentSelectedIndex > 0) {
            currentSelectedIndex--;
            updateSelection();
        } else {
            currentSelectedIndex = currentApps.length - 1;
            updateSelection();
        }
    }
}

function handleEnter() {
    if (!keyboardEnabled || isModalOpen) return;
    
    // NUEVO: Manejar flechas de scroll si est√°n enfocadas
    if (currentFocusArea === 'recent') {
        const scrollLeftBtn = document.getElementById('scrollLeft');
        const scrollRightBtn = document.getElementById('scrollRight');
        
        if (scrollLeftBtn && document.activeElement === scrollLeftBtn) {
            scrollRecentApps(-1);
            return;
        }
        
        if (scrollRightBtn && document.activeElement === scrollRightBtn) {
            scrollRecentApps(1);
            return;
        }
    }
    
    if (isMenuOpen && currentMenuItemIndex >= 0 && currentMenuItemIndex < menuItems.length) {
        // CORRECCI√ìN: Minimizar ventanas antes de navegar
        if (taskManager.openWindows.length > 0) {
            taskManager.openWindows.forEach(window => {
                minimizeWindow(window.id);
            });
        }
        menuItems[currentMenuItemIndex].click();
        return;
    }
    
    if (currentFocusArea === 'header') {
        if (currentHeaderIndex === 0) {
            toggleMenu();
        } else if (currentHeaderIndex === 1) {
            toggleLauncher();
        } else if (currentHeaderIndex === 2) {
            // CORRECCI√ìN: Solo activar pantalla completa si est√° expl√≠citamente enfocado
            if (document.activeElement === fullscreenToggle) {
                toggleFullscreen();
            }
        }
    }
    else if (currentFocusArea === 'recent' && currentRecentIndex >= 0 && currentRecentIndex < recentApps.length) {
        launchRecentApp(currentRecentIndex);
    } 
    else if (currentFocusArea === 'categories' && currentCategoryIndex >= 0 && currentCategoryIndex < categoryButtons.length) {
        categoryButtons[currentCategoryIndex].click();
    } 
    else if (currentFocusArea === 'apps' && currentSelectedIndex >= 0 && currentSelectedIndex < currentApps.length) {
        openAppModal(currentApps[currentSelectedIndex]);
    }
}

// ========== FUNCI√ìN BACK REPARADA ==========
function goBackInApp() {
    if (taskManager.activeWindowId) {
        const activeWindow = taskManager.openWindows.find(w => w.id === taskManager.activeWindowId);
        if (activeWindow && activeWindow.iframe && activeWindow.iframe.contentWindow) {
            try {
                const iframeWindow = activeWindow.iframe.contentWindow;
                if (iframeWindow.location && iframeWindow.history.length > 1) {
                    iframeWindow.history.back();
                    console.log('‚úÖ Back navigation executed in:', activeWindow.title);
                } else {
                    console.log('‚ÑπÔ∏è No history to go back in:', activeWindow.title);
                    iframeWindow.location.reload();
                }
            } catch(e) {
                console.log("‚ùå Could not execute back:", e);
                if (activeWindow.iframe.src) {
                    activeWindow.iframe.src = activeWindow.iframe.src;
                }
            }
        }
    } else {
        console.log('‚ÑπÔ∏è No active window to go back');
    }
}

// ========== SISTEMA DE CARGA DE APPS-DATA.JS REPARADO ==========
function loadAppsData() {
    return new Promise((resolve, reject) => {
        console.log('üîÑ Loading apps-data.js...');
        
        if (window.appData && Array.isArray(window.appData) && window.appData.length > 0) {
            console.log('‚úÖ appData already loaded in window:', window.appData.length, 'applications');
            appData = window.appData;
            resolve(appData);
            return;
        }

        const script = document.createElement('script');
        script.src = 'apps-data.js';
        script.onload = function() {
            console.log('üì¶ apps-data.js loaded successfully');
            
            setTimeout(() => {
                if (window.appData && Array.isArray(window.appData)) {
                    console.log('‚úÖ appData available:', window.appData.length, 'applications');
                    appData = window.appData;
                    resolve(appData);
                } else {
                    console.error('‚ùå window.appData not available after loading script');
                    fallbackToEmptyData(resolve);
                }
            }, 100);
        };
        
        script.onerror = function(error) {
            console.error('‚ùå Error loading apps-data.js:', error);
            fallbackToEmptyData(resolve);
        };
        
        document.head.appendChild(script);
    });
}

function fallbackToEmptyData(resolve) {
    console.log('üîÑ Using empty data as fallback');
    window.appData = [];
    appData = [];
    resolve(appData);
}

// ========== SISTEMA DE NAVEGACI√ìN POR SECCIONES OPTIMIZADO ==========
const sections = {
    recent: document.getElementById('recentSection'),
    categories: document.getElementById('categoriesSection'),
    apps: document.getElementById('appsSection')
};

function initSectionNavigation() {
    // ========== CORRECCI√ìN: ESTABLECER CATEGOR√çA POR DEFECTO ==========
    currentCategory = 'all';
    
    // Mostrar todas las secciones inicialmente
    updateSectionDisplay();
    
    // Asegurar que el men√∫ muestre "Home" como activo
    updateMenuSelection('all');
}

function updateFocusForSection() {
    if (currentSection === 'recent') {
        currentFocusArea = 'recent';
        if (recentApps.length > 0) {
            currentRecentIndex = 0;
        }
    }
    else if (currentSection === 'categories') {
        currentFocusArea = 'categories';
        currentCategoryIndex = 0;
    }
    else if (currentSection === 'apps') {
        currentFocusArea = 'apps';
        if (currentApps.length > 0) {
            currentSelectedIndex = 0;
        }
    }
    
    updateSelection();
}

// ========== NAVEGACI√ìN POR TECLADO REPARADA ==========
function handleUpArrow() {
    if (!keyboardEnabled || isModalOpen) return;
    
    if (isMenuOpen) {
        if (currentMenuItemIndex > 0) {
            currentMenuItemIndex--;
            updateSelection();
        }
        return;
    }
    
    // L√ìGICA REPARADA: Navegaci√≥n vertical consistente
    if (currentFocusArea === 'apps') {
        currentFocusArea = 'categories';
        currentCategoryIndex = 0;
        currentSection = 'categories';
        updateSectionDisplay();
    }
    else if (currentFocusArea === 'categories') {
        currentFocusArea = 'recent';
        currentSection = 'recent';
        if (recentApps.length > 0) {
            currentRecentIndex = 0;
        }
        updateSectionDisplay();
    }
    else if (currentFocusArea === 'recent') {
        // CORRECCI√ìN: Ahora s√≠ permite subir al header desde recientes
        currentFocusArea = 'header';
        currentHeaderIndex = 0;
        currentSection = 'recent';
        updateSectionDisplay();
    }
    else if (currentFocusArea === 'header') {
        return;
    }
    
    updateSelection();
}

function handleDownArrow() {
    if (!keyboardEnabled || isModalOpen) return;
    
    if (isMenuOpen) {
        if (currentMenuItemIndex < menuItems.length - 1) {
            currentMenuItemIndex++;
            updateSelection();
        }
        return;
    }
    
    if (currentFocusArea === 'header') {
        currentFocusArea = 'recent';
        currentSection = 'recent';
        if (recentApps.length > 0) {
            currentRecentIndex = 0;
        }
        updateSectionDisplay();
    }
    else if (currentFocusArea === 'recent') {
        currentFocusArea = 'categories';
        currentCategoryIndex = 0;
        currentSection = 'categories';
        updateSectionDisplay();
    }
    else if (currentFocusArea === 'categories') {
        currentFocusArea = 'apps';
        currentSection = 'apps';
        if (currentApps.length > 0) {
            currentSelectedIndex = 0;
        }
        updateSectionDisplay();
    }
    else if (currentFocusArea === 'apps') {
        const columns = 4;
        if (currentSelectedIndex + columns < currentApps.length) {
            currentSelectedIndex += columns;
            updateSelection();
        }
    }
    
    updateSelection();
}

function handleEscape() {
    if (!keyboardEnabled) return;
    
    if (isModalOpen) {
        const modal = document.getElementById('appModal');
        if (modal) modal.style.display = 'none';
        isModalOpen = false;
        currentModalActionIndex = 0;
    } else if (isMenuOpen) {
        toggleMenu();
    } else if (isSearchActive) {
        toggleLauncher();
    } else if (isSettingsOpen) {
        hideSettings();
    } else if (taskManager.activeWindowId) {
        closeActiveWindow();
    } else if (currentFocusArea !== 'header') {
        currentFocusArea = 'header';
        currentHeaderIndex = 0;
        updateSelection();
    }
}

// ========== ACTUALIZAR LA FUNCI√ìN DE SELECCI√ìN ==========
function updateSelection() {
    const recentAppElements = document.querySelectorAll('.recent-app');
    const categoryButtons = document.querySelectorAll('.category-button');
    const appCards = document.querySelectorAll('.app-card');
    const menuItems = document.querySelectorAll('.menu-item');
    const headerElements = document.querySelectorAll('.logo-container, .search-container, .fullscreen-toggle');
    
    recentAppElements.forEach(el => el.classList.remove('selected'));
    categoryButtons.forEach(el => el.classList.remove('selected'));
    appCards.forEach(el => el.classList.remove('selected'));
    menuItems.forEach(el => el.classList.remove('focused'));
    headerElements.forEach(el => el.classList.remove('focused'));
    
    // CORRECCI√ìN MEJORADA: Header completamente funcional
    if (currentFocusArea === 'header' && headerElements.length > 0 && currentHeaderIndex >= 0) {
        const selectedHeader = headerElements[currentHeaderIndex];
        if (selectedHeader) {
            selectedHeader.classList.add('focused');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
    else if (currentFocusArea === 'recent' && recentAppElements.length > 0 && currentRecentIndex >= 0) {
        const selectedRecent = recentAppElements[currentRecentIndex];
        if (selectedRecent) {
            selectedRecent.classList.add('selected');
            const appName = selectedRecent.getAttribute('data-app-name');
            if (selectedAppInfo) {
                selectedAppInfo.textContent = appName;
                selectedAppInfo.style.left = selectedRecent.offsetLeft + 'px';
                selectedAppInfo.style.width = selectedRecent.offsetWidth + 'px';
            }
            selectedRecent.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center',
                inline: 'center' 
            });
        }
    } 
    else if (currentFocusArea === 'categories' && categoryButtons.length > 0 && currentCategoryIndex >= 0) {
        const selectedCategory = categoryButtons[currentCategoryIndex];
        if (selectedCategory) {
            selectedCategory.classList.add('selected');
            selectedCategory.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center',
                inline: 'center' 
            });
        }
    } 
    else if (currentFocusArea === 'apps' && appCards.length > 0 && currentSelectedIndex >= 0) {
        const selectedApp = appCards[currentSelectedIndex];
        if (selectedApp) {
            selectedApp.classList.add('selected');
            selectedApp.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center',
                inline: 'center' 
            });
        }
    } 
    else if (currentFocusArea === 'menu' && menuItems.length > 0 && currentMenuItemIndex >= 0) {
        const selectedMenuItem = menuItems[currentMenuItemIndex];
        if (selectedMenuItem) {
            selectedMenuItem.classList.add('focused');
            selectedMenuItem.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center',
                inline: 'center' 
            });
        }
    }
}

function playNavSound() {
    if (navSound) {
        navSound.currentTime = 0;
        try {
            navSound.play();
        } catch(e) {
            console.log("Audio play failed:", e);
        }
    }
}

// ========== SISTEMA DE APLICACIONES REPARADO ==========
function displayApps(apps) {
    if (!appGrid) return;
    
    appGrid.innerHTML = '';
    currentApps = apps;
    
    const loadingMessage = document.getElementById('loadingMessage');
    if (loadingMessage) {
        loadingMessage.style.display = 'none';
    }
    
    if (apps.length === 0) {
        appGrid.innerHTML = `
            <div style="color: #666; grid-column: 1/-1; text-align: center; padding: 40px;">
                <p>No applications available</p>
                <p style="font-size: 12px; margin-top: 10px;">
                    Add applications in apps-data.js file
                </p>
            </div>
        `;
        return;
    }
    
    apps.forEach((app, i) => {
        const appCard = document.createElement('div');
        appCard.className = 'app-card';
        if (i === currentSelectedIndex && currentFocusArea === 'apps') {
            appCard.classList.add('selected');
        }
        
        const additionalInfo = currentCategory === 'uninstall' ? 
            '<div class="uninstall-info">Click to view details or uninstall</div>' : '';
        
        appCard.innerHTML = `
            <img src="${app.image}" alt="${app.name}" class="app-thumbnail" 
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0CveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjMzMzMzMzIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+QXBwPC90ZXh0Pgo8L3N2Zz4K'">
            <div class="app-info">
                <div class="app-title">${app.name}</div>
                <div class="app-category">${app.category}</div>
                ${additionalInfo}
            </div>
        `;
        
        appCard.addEventListener('click', () => openAppModal(app));
        appGrid.appendChild(appCard);
    });
    
    if (currentApps.length > 0 && currentSelectedIndex === -1 && currentFocusArea === 'apps') {
        currentSelectedIndex = 0;
        updateSelection();
    }
    
    // Actualizar visibilidad del scrollbar despu√©s de mostrar las apps
    setTimeout(updateCategoryScrollVisibility, 100);
}

// ========== FUNCI√ìN DISPLAY RECENT APPS REPARADA ==========
function displayRecentApps() {
    const recentAppsContainer = document.getElementById('recentApps');
    if (!recentAppsContainer) return;
    
    recentAppsContainer.innerHTML = '';
    
    if (recentApps.length === 0) {
        recentAppsContainer.innerHTML = '<p style="color: #666; padding: 10px;">No recent applications</p>';
        return;
    }
    
    recentApps.forEach((app, i) => {
        let appInData = appData.find(a => a.name === app.name) || app;
        
        const img = document.createElement('img');
        img.src = appInData.image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDE2MCAxNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNjAiIGhlaWdodD0iMTYwIiBmaWxsPSIjMzMzMzMzIiByeD0iOCIvPgo8dGV4dCB4PSI4MCIgeT0iODAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5BcHA8L3RleHQ+Cjwvc3ZnPgo=';
        img.onerror = function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDE2MCAxNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNjAiIGhlaWdodD0iMTYwIiBmaWxsPSIjMzMzMzMzIiByeD0iOCIvPgo8dGV4dCB4PSI4MCIgeT0iODAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5BcHA8L3RleHQ+Cjwvc3ZnPgo=';
        };
        
        img.className = i === 0 ? 'recent-app featured' : 'recent-app';
        img.title = appInData.name;
        img.setAttribute('data-index', i);
        img.setAttribute('data-app-name', appInData.name);
        img.tabIndex = 0;
        
        // Evento de click simple (funciona tanto para mouse como para touch)
        img.addEventListener('click', () => {
            launchRecentApp(i);
        });
        
        // Evento de teclado para accesibilidad
        img.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                launchRecentApp(i);
            }
        });
        
        recentAppsContainer.appendChild(img);
    });
    
    // Inicializar scroll integrado despu√©s de crear los elementos
    initIntegratedScroll();
    
    if (currentFocusArea === 'recent' && recentApps.length > 0) {
        if (currentRecentIndex >= recentApps.length) {
            currentRecentIndex = 0;
        }
        updateSelection();
    }
    
    setTimeout(updateScrollArrows, 100);
}

function addToRecentApps(app) {
    let newRecentApps = recentApps.filter(recentApp => recentApp.name !== app.name);
    
    newRecentApps.unshift({ 
        name: app.name, 
        image: app.image, 
        link: app.link,
        timestamp: Date.now()
    });
    
    if (newRecentApps.length > MAX_RECENT_APPS) {
        newRecentApps = newRecentApps.slice(0, MAX_RECENT_APPS);
    }
    
    recentApps = newRecentApps;
    localStorage.setItem('recentApps', JSON.stringify(recentApps));
    displayRecentApps();
    
    if (currentFocusArea === 'recent' && recentApps.length > 0) {
        currentRecentIndex = 0;
        updateSelection();
    }
}

function launchRecentApp(index) {
    if (index < 0 || index >= recentApps.length) return;
    
    const recentApp = recentApps[index];
    let fullAppData = appData.find(app => app.name === recentApp.name) || recentApp;
    
    // Mover a la primera posici√≥n si no est√° ya all√≠
    if (index > 0) {
        const movedApp = recentApps.splice(index, 1)[0];
        recentApps.unshift(movedApp);
        localStorage.setItem('recentApps', JSON.stringify(recentApps));
        displayRecentApps();
    }
    
    // Lanzar la aplicaci√≥n
    launchAppDirectly(fullAppData);
}

// ========== MEN√ö LATERAL OPTIMIZADO ==========
function toggleMenu() {
    isMenuOpen = !isMenuOpen;
    if (isMenuOpen) {
        if (sideMenu) sideMenu.classList.add('open');
        if (menuOverlay) menuOverlay.classList.add('open');
        currentFocusArea = 'menu';
        currentMenuItemIndex = 0;
    } else {
        if (sideMenu) sideMenu.classList.remove('open');
        if (menuOverlay) menuOverlay.classList.remove('open');
        currentFocusArea = 'header';
        currentHeaderIndex = 0;
        currentMenuItemIndex = -1;
    }
    updateSelection();
}

// ========== LAUNCHER Y B√öSQUEDA OPTIMIZADOS ==========
function toggleLauncher() {
    const launcher = document.getElementById('launcher');
    const searchInput = document.getElementById('launcherSearch');
    
    if (launcher.classList.contains('open')) {
        launcher.classList.remove('open');
        searchInput.value = '';
        searchLauncher();
        isSearchActive = false;
        currentFocusArea = 'header';
        currentHeaderIndex = 1;
        currentLauncherAppIndex = -1;
    } else {
        launcher.classList.add('open');
        populateLauncher();
        searchInput.focus();
        isSearchActive = true;
        currentLauncherAppIndex = 0;
        updateLauncherSelection();
    }
    updateSelection();
}

function populateLauncher() {
    const launcherApps = document.getElementById('launcherApps');
    const searchResultsCount = document.getElementById('searchResultsCount');
    
    if (!launcherApps) return;
    
    launcherApps.innerHTML = '';
    
    appData.forEach((app, index) => {
        const appElement = document.createElement('div');
        appElement.className = 'launcher-app';
        appElement.setAttribute('data-index', index);
        appElement.innerHTML = `
            <img src="${app.image}" alt="${app.name}" 
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMzMzMzMzIiByeD0iMTIiLz4KPHRleHQgeD0iNDAiIHk9IjQwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+QXBwPC90ZXh0Pgo8L3N2Zz4K'">
            <span>${app.name}</span>
        `;
        
        appElement.addEventListener('click', () => {
            // CORRECCI√ìN: Cerrar el launcher antes de lanzar
            toggleLauncher();
            setTimeout(() => {
                launchAppDirectly(app);
            }, 50);
        });
        
        launcherApps.appendChild(appElement);
    });
    
    currentLauncherAppIndex = 0;
    
    if (searchResultsCount) {
        searchResultsCount.textContent = `${appData.length} applications available`;
    }
    
    updateLauncherSelection();
}

function updateLauncherSelection() {
    const apps = Array.from(document.querySelectorAll('.launcher-app:not([style*="display: none"])'));
    apps.forEach((app, index) => {
        app.classList.remove('selected');
        if (index === currentLauncherAppIndex) {
            app.classList.add('selected');
            const container = document.querySelector('.launcher-apps-container');
            const appRect = app.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            if (appRect.top < containerRect.top) {
                app.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else if (appRect.bottom > containerRect.bottom) {
                app.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }
        }
    });
}

function handleLauncherKeydown(e) {
    if (!isSearchActive) return;
    
    const apps = Array.from(document.querySelectorAll('.launcher-app:not([style*="display: none"])'));
    if (apps.length === 0) return;
    
    const container = document.querySelector('.launcher-apps');
    const appWidth = 160;
    const gap = 20;
    const columns = Math.floor(container.clientWidth / (appWidth + gap));
    
    switch(e.key) {
        case 'ArrowUp':
            e.preventDefault();
            playNavSound();
            if (currentLauncherAppIndex >= columns) {
                currentLauncherAppIndex -= columns;
            } else {
                const rows = Math.ceil(apps.length / columns);
                currentLauncherAppIndex = Math.min(apps.length - 1, currentLauncherAppIndex + (columns * (rows - 1)));
            }
            updateLauncherSelection();
            break;
            
        case 'ArrowDown':
            e.preventDefault();
            playNavSound();
            if (currentLauncherAppIndex + columns < apps.length) {
                currentLauncherAppIndex += columns;
            } else {
                currentLauncherAppIndex = currentLauncherAppIndex % columns;
            }
            updateLauncherSelection();
            break;
            
        case 'ArrowLeft':
            e.preventDefault();
            playNavSound();
            if (currentLauncherAppIndex > 0) {
                currentLauncherAppIndex--;
            } else {
                currentLauncherAppIndex = apps.length - 1;
            }
            updateLauncherSelection();
            break;
            
        case 'ArrowRight':
            e.preventDefault();
            playNavSound();
            if (currentLauncherAppIndex < apps.length - 1) {
                currentLauncherAppIndex++;
            } else {
                currentLauncherAppIndex = 0;
            }
            updateLauncherSelection();
            break;
            
        case 'Enter':
            e.preventDefault();
            playNavSound();
            if (currentLauncherAppIndex >= 0 && currentLauncherAppIndex < apps.length) {
                const selectedApp = apps[currentLauncherAppIndex];
                const appIndex = parseInt(selectedApp.getAttribute('data-index'));
                const app = appData[appIndex];
                if (app) {
                    // CORRECCI√ìN: Cerrar el launcher ANTES de lanzar la app
                    toggleLauncher(); // Cerrar primero
                    setTimeout(() => {
                        launchAppDirectly(app); // Lanzar despu√©s
                    }, 100);
                }
            }
            break;
            
        case 'Escape':
            e.preventDefault();
            playNavSound();
            toggleLauncher();
            break;
    }
}

function searchLauncher() {
    const searchTerm = document.getElementById('launcherSearch').value.toLowerCase();
    const apps = document.querySelectorAll('.launcher-app');
    const searchResultsCount = document.getElementById('searchResultsCount');
    
    let visibleCount = 0;
    let firstVisibleIndex = -1;
    const visibleApps = [];
    
    apps.forEach((app, index) => {
        const appName = app.querySelector('span').textContent.toLowerCase();
        if (appName.includes(searchTerm) || searchTerm === '') {
            app.style.display = 'flex';
            visibleCount++;
            visibleApps.push(index);
            if (firstVisibleIndex === -1) {
                firstVisibleIndex = index;
            }
        } else {
            app.style.display = 'none';
        }
    });
    
    if (visibleApps.length > 0) {
        if (currentLauncherAppIndex === -1 || !apps[currentLauncherAppIndex] || apps[currentLauncherAppIndex].style.display === 'none') {
            currentLauncherAppIndex = visibleApps[0];
        } else {
            const currentVisibleIndex = visibleApps.indexOf(currentLauncherAppIndex);
            if (currentVisibleIndex === -1) {
                currentLauncherAppIndex = visibleApps[0];
            }
        }
    } else {
        currentLauncherAppIndex = -1;
    }
    
    updateLauncherSelection();
    
    if (searchResultsCount) {
        if (searchTerm === '') {
            searchResultsCount.textContent = `${visibleCount} applications available`;
        } else {
            searchResultsCount.textContent = `${visibleCount} applications found for "${searchTerm}"`;
        }
    }
}

// ========== LANZAR APLICACIONES OPTIMIZADO ==========
function launchAppDirectly(app) {
    console.log('üéØ launchAppDirectly called for:', app.name);
    
    // Asegurar que el launcher est√© cerrado
    const launcher = document.getElementById('launcher');
    if (launcher && launcher.classList.contains('open')) {
        launcher.classList.remove('open');
        isSearchActive = false;
    }
    
    // Asegurar que el men√∫ est√© cerrado
    if (isMenuOpen) {
        toggleMenu();
    }
    
    createAppWindow(
        app.name, 
        app.name, 
        app.image, 
        'web', 
        null, 
        app.link
    );
    
    addToRecentApps(app);
    
    console.log('‚úÖ App launch process completed for:', app.name);
}

// ========== MODAL DE APLICACI√ìN OPTIMIZADO ==========
function openAppModal(app) {
    isModalOpen = true;
    const appDetails = document.getElementById('appDetails');
    const modal = document.getElementById('appModal');
    const modalActions = document.getElementById('modalActions');
    
    if (!appDetails || !modal || !modalActions) return;
    
    const programManagerData = JSON.parse(localStorage.getItem('programManagerData')) || { shortcuts: [] };
    const isInstalled = programManagerData.shortcuts.some(shortcut => 
        shortcut.name === app.name && shortcut.type === 'web' && !shortcut.isDiscoLocal && !shortcut.isTrash
    );

    appDetails.innerHTML = `
        <h2>${app.name}</h2>
        <img src="${app.image}" alt="${app.name}" style="max-width: 200px; border-radius: 8px; margin: 10px 0;"
             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjMzMzMzMzIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+QXBwPC90ZXh0Pgo8L3N2Zz4K'">
        <p><strong>Category:</strong> ${app.category}</p>
        <p><strong>Description:</strong> ${app.description}</p>
        ${isInstalled || currentCategory === 'uninstall' ? 
            '<p><strong>Status:</strong> <span style="color: #4CAF50;">‚úì Installed</span></p>' : ''}
    `;

    if (isInstalled || currentCategory === 'uninstall') {
        modalActions.innerHTML = `
            <button class="modal-action-button" data-action="run">Run</button>
            <button class="modal-action-button uninstall" data-action="uninstall">Uninstall</button>
        `;
    } else {
        modalActions.innerHTML = `
            <button class="modal-action-button" data-action="run">Run</button>
            <button class="modal-action-button install" data-action="install">Install in Program Manager</button>
        `;
    }
    
    const modalButtons = modalActions.querySelectorAll('.modal-action-button');
    modalButtons.forEach(button => {
        button.addEventListener('click', function() {
            const action = this.getAttribute('data-action');
            executeModalAction(action);
        });
        
        button.addEventListener('mouseenter', function() {
            modalButtons.forEach(btn => btn.classList.remove('selected'));
            this.classList.add('selected');
            currentModalActionIndex = Array.from(modalButtons).indexOf(this);
        });
    });
    
    currentModalActionIndex = 0;
    updateModalSelection();
    
    modal.style.display = 'block';
    currentSelectedIndex = -1;
    
    const closeBtn = document.querySelector('.close');
    if (closeBtn) {
        closeBtn.onclick = function() {
            modal.style.display = 'none';
            isModalOpen = false;
            currentModalActionIndex = 0;
        };
    }
}

function updateModalSelection() {
    const modalButtons = document.querySelectorAll('.modal-action-button');
    modalButtons.forEach((button, index) => {
        button.classList.remove('selected');
        if (index === currentModalActionIndex) {
            button.classList.add('selected');
        }
    });
}

function handleModalKeydown(e) {
    if (!isModalOpen) return;
    
    const modalButtons = document.querySelectorAll('.modal-action-button');
    if (modalButtons.length === 0) return;
    
    switch(e.key) {
        case 'ArrowLeft':
            e.preventDefault();
            playNavSound();
            if (currentModalActionIndex > 0) {
                currentModalActionIndex--;
            } else {
                currentModalActionIndex = modalButtons.length - 1;
            }
            updateModalSelection();
            break;
            
        case 'ArrowRight':
            e.preventDefault();
            playNavSound();
            if (currentModalActionIndex < modalButtons.length - 1) {
                currentModalActionIndex++;
            } else {
                currentModalActionIndex = 0;
            }
            updateModalSelection();
            break;
            
        case 'Enter':
            e.preventDefault();
            playNavSound();
            if (currentModalActionIndex >= 0 && currentModalActionIndex < modalButtons.length) {
                const selectedButton = modalButtons[currentModalActionIndex];
                const action = selectedButton.getAttribute('data-action');
                executeModalAction(action);
            }
            break;
            
        case 'Escape':
            e.preventDefault();
            playNavSound();
            const modal = document.getElementById('appModal');
            if (modal) modal.style.display = 'none';
            isModalOpen = false;
            currentModalActionIndex = 0;
            break;
    }
}

function executeModalAction(action) {
    const modal = document.getElementById('appModal');
    const appName = document.querySelector('#appDetails h2').textContent;
    const app = appData.find(a => a.name === appName) || currentApps.find(a => a.name === appName);
    
    if (!app) return;
    
    switch(action) {
        case 'run':
            modal.style.display = 'none';
            isModalOpen = false;
            launchAppDirectly(app);
            break;
            
        case 'install':
            modal.style.display = 'none';
            isModalOpen = false;
            installAppInProgramManager(app);
            break;
            
        case 'uninstall':
            modal.style.display = 'none';
            isModalOpen = false;
            showUninstallConfirm(app);
            break;
    }
    
    currentModalActionIndex = 0;
}

// ========== NAVEGACI√ìN EN CONFIRMACI√ìN DE DESINSTALACI√ìN ==========
function updateConfirmSelection() {
    const confirmButtons = document.querySelectorAll('.uninstall-confirm-buttons .action-button');
    confirmButtons.forEach((button, index) => {
        button.classList.remove('selected');
        if (index === currentConfirmButtonIndex) {
            button.classList.add('selected');
        }
    });
}

function handleConfirmKeydown(e) {
    const confirmDialog = document.getElementById('uninstallConfirm');
    if (!confirmDialog || !confirmDialog.classList.contains('active')) return;
    
    const confirmButtons = document.querySelectorAll('.uninstall-confirm-buttons .action-button');
    if (confirmButtons.length === 0) return;
    
    switch(e.key) {
        case 'ArrowLeft':
        case 'ArrowRight':
            e.preventDefault();
            playNavSound();
            currentConfirmButtonIndex = currentConfirmButtonIndex === 0 ? 1 : 0;
            updateConfirmSelection();
            break;
            
        case 'Enter':
            e.preventDefault();
            playNavSound();
            if (currentConfirmButtonIndex === 0) {
                if (currentUninstallApp) {
                    uninstallApp(currentUninstallApp);
                }
            } else {
                hideUninstallConfirm();
            }
            break;
            
        case 'Escape':
            e.preventDefault();
            playNavSound();
            hideUninstallConfirm();
            break;
    }
}

// ========== SISTEMA DE DESINSTALACI√ìN OPTIMIZADO ==========
function getInstalledApps() {
    const programManagerData = JSON.parse(localStorage.getItem('programManagerData'));
    if (!programManagerData) return [];
    
    const installedApps = programManagerData.shortcuts.filter(shortcut => 
        shortcut.type === 'web' && !shortcut.isDiscoLocal && !shortcut.isTrash
    );
    
    return installedApps.map(shortcut => {
        const originalApp = appData.find(app => app.name === shortcut.name);
        return originalApp || {
            name: shortcut.name,
            image: shortcut.icon,
            category: 'installed',
            description: 'Installed application',
            link: shortcut.url
        };
    });
}

function showUninstallConfirm(app) {
    currentUninstallApp = app;
    currentConfirmButtonIndex = 0;
    document.getElementById('uninstallAppName').textContent = `Are you sure you want to uninstall "${app.name}"? This will remove it from Program Manager and recent apps.`;
    document.getElementById('uninstallConfirm').classList.add('active');
    updateConfirmSelection();
}

function hideUninstallConfirm() {
    document.getElementById('uninstallConfirm').classList.remove('active');
    currentUninstallApp = null;
    currentConfirmButtonIndex = 0;
}

function uninstallApp(app) {
    const programManagerData = JSON.parse(localStorage.getItem('programManagerData'));
    if (!programManagerData) return;
    
    const initialLength = programManagerData.shortcuts.length;
    programManagerData.shortcuts = programManagerData.shortcuts.filter(shortcut => 
        !(shortcut.name === app.name && shortcut.type === 'web' && !shortcut.isDiscoLocal && !shortcut.isTrash)
    );
    
    if (programManagerData.shortcuts.length < initialLength) {
        localStorage.setItem('programManagerData', JSON.stringify(programManagerData));
        
        removeFromRecentApps(app);
        
        showStatusMessage('"' + app.name + '" uninstalled successfully from Program Manager', 'success');
        
        if (window.opener && typeof window.opener.renderShortcuts === 'function') {
            window.opener.renderShortcuts();
        }
        
        if (currentCategory === 'uninstall') {
            const filteredApps = getInstalledApps();
            displayApps(filteredApps);
            if (filteredApps.length > 0) {
                currentSelectedIndex = 0;
            } else {
                currentSelectedIndex = -1;
            }
            updateSelection();
        }
        
        hideUninstallConfirm();
    } else {
        showStatusMessage('"' + app.name + '" was not found in Program Manager', 'warning');
        hideUninstallConfirm();
    }
}

function removeFromRecentApps(app) {
    recentApps = recentApps.filter(recentApp => recentApp.name !== app.name);
    localStorage.setItem('recentApps', JSON.stringify(recentApps));
    displayRecentApps();
}

// ========== PROGRAM MANAGER INTEGRATION OPTIMIZADA ==========
function installAppInProgramManager(app) {
    let programManagerData = JSON.parse(localStorage.getItem('programManagerData')) || {
        shortcuts: [],
        folders: [],
        trash: [],
        settings: { view: 'icons' }
    };
    
    const isAlreadyInstalled = programManagerData.shortcuts.some(shortcut => 
        shortcut.name === app.name && shortcut.type === 'web'
    );
    
    if (isAlreadyInstalled) {
        showStatusMessage('"' + app.name + '" is already installed in Program Manager', 'warning');
        return;
    }
    
    const shortcut = {
        id: Date.now().toString(36) + Math.random().toString(36).substr(2),
        name: app.name,
        icon: app.image,
        type: 'web',
        url: app.link,
        created: new Date().toISOString(),
        location: 'desktop'
    };
    
    programManagerData.shortcuts.push(shortcut);
    localStorage.setItem('programManagerData', JSON.stringify(programManagerData));
    
    // NUEVO: Si es el Program Manager, fijarlo autom√°ticamente
    if (app.name === 'Program Manager') {
        pinToTaskbar(app);
    }
    
    showStatusMessage('"' + app.name + '" installed successfully in Program Manager', 'success');
    
    if (window.opener && typeof window.opener.renderShortcuts === 'function') {
        window.opener.renderShortcuts();
    }
}

function showStatusMessage(message, type = 'success') {
    const statusMessage = document.getElementById('statusMessage');
    if (!statusMessage) return;
    
    statusMessage.textContent = message;
    statusMessage.className = 'status-message';
    
    if (type === 'warning') {
        statusMessage.style.backgroundColor = '#ff9800';
    } else if (type === 'error') {
        statusMessage.style.backgroundColor = '#f44336';
    } else {
        statusMessage.style.backgroundColor = '#0078d4';
    }
    
    statusMessage.classList.add('show');
    
    setTimeout(() => {
        statusMessage.classList.remove('show');
    }, 3000);
}

// ========== SISTEMA DE VENTANAS ==========
function createAppWindow(appName, appTitle, appIcon, appType, shortcutId, url) {
    const windowId = `window-${taskManager.nextWindowId++}`;
    
    const windowContainer = document.createElement('div');
    windowContainer.className = 'app-frame-container';
    windowContainer.id = windowId;
    windowContainer.style.display = 'block';
    
    const iframeScrollContainer = document.createElement('div');
    iframeScrollContainer.className = 'iframe-scroll-container';
    
    const iframeScrollContent = document.createElement('div');
    iframeScrollContent.className = 'iframe-scroll-content scroll-invisible';
    
    const iframe = document.createElement('iframe');
    iframe.className = 'app-window';
    iframe.id = `${windowId}-iframe`;
    
    if (appType === 'zip') {
        iframe.src = `http://winebox.cloud/accesories/wine.html?app=${appName}&p=${appName}.exe`;
    } else if (appType === 'web') {
        iframe.src = url;
    } else if (appType === 'html') {
        const fileURL = URL.createObjectURL(url);
        iframe.src = fileURL;
    } else if (appType === 'system') {
        iframe.src = url;
    }
    
    const windowControls = document.createElement('div');
    windowControls.className = 'window-controls';
    windowControls.innerHTML = `
        <button class="window-control-btn" onclick="minimizeWindow('${windowId}')">‚àí</button>
        <button class="window-control-btn" onclick="closeWindow('${windowId}')">√ó</button>
    `;
    
    iframeScrollContent.appendChild(iframe);
    iframeScrollContainer.appendChild(iframeScrollContent);
    windowContainer.appendChild(iframeScrollContainer);
    windowContainer.appendChild(windowControls);
    document.body.appendChild(windowContainer);
    
    const windowInfo = {
        id: windowId,
        title: appTitle,
        icon: appIcon,
        type: appType,
        shortcutId: shortcutId,
        minimized: false,
        container: windowContainer,
        iframe: iframe
    };
    
    taskManager.openWindows.push(windowInfo);
    setActiveWindow(windowId);
    
    updateDockBar();
    return windowId;
}

function setActiveWindow(windowId) {
    taskManager.openWindows.forEach(window => {
        window.container.style.display = 'none';
    });
    
    const activeWindow = taskManager.openWindows.find(w => w.id === windowId);
    if (activeWindow && !activeWindow.minimized) {
        activeWindow.container.style.display = 'block';
    }
    
    taskManager.activeWindowId = windowId;
    updateDockBar();
}

function minimizeWindow(windowId) {
    const window = taskManager.openWindows.find(w => w.id === windowId);
    if (window) {
        window.minimized = true;
        window.container.style.display = 'none';
        updateDockBar();
    }
}

function closeWindow(windowId) {
    const windowIndex = taskManager.openWindows.findIndex(w => w.id === windowId);
    if (windowIndex !== -1) {
        const window = taskManager.openWindows[windowIndex];
        
        if (window.container && window.container.parentNode) {
            window.container.parentNode.removeChild(window.container);
        }
        
        taskManager.openWindows.splice(windowIndex, 1);
        
        if (taskManager.openWindows.length > 0) {
            const lastWindow = taskManager.openWindows[taskManager.openWindows.length - 1];
            setActiveWindow(lastWindow.id);
        } else {
            taskManager.activeWindowId = null;
        }
        
        updateDockBar();
    }
}

function minimizeActiveWindow() {
    if (taskManager.activeWindowId) {
        minimizeWindow(taskManager.activeWindowId);
    }
}

function closeActiveWindow() {
    if (taskManager.activeWindowId) {
        closeWindow(taskManager.activeWindowId);
    }
}

// ========== CORRECCI√ìN DE LA DOCKBAR ==========
function updateDockBar() {
    const dockbarApps = document.getElementById('dockbarApps');
    if (!dockbarApps) return;
    
    dockbarApps.innerHTML = '';
    
    // Primero agregar apps fijadas
    updateTaskbarPinnedApps();
    
    // Luego agregar ventanas abiertas
    taskManager.openWindows.forEach(window => {
        const iconElement = document.createElement('div');
        iconElement.className = `dockbar-app-icon ${window.id === taskManager.activeWindowId ? 'active' : ''}`;
        iconElement.setAttribute('data-title', window.title);
        iconElement.setAttribute('data-window-id', window.id);
        
        iconElement.innerHTML = `<img src="${window.icon}" alt="${window.title}" 
             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzQiIGhlaWdodD0iMzQiIHZpZXdCb3g9IjAgMCAzNCAzNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjM0IiBoZWlnaHQ9IjM0IiBmaWxsPSIjMzMzMzMzIiByeD0iNCIvPgo8dGV4dCB4PSIxNyIgeT0iMTciIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5BcHA8L3RleHQ+Cjwvc3ZnPgo='">`;
        
        iconElement.addEventListener('click', () => {
            toggleWindow(window.id);
        });
        
        dockbarApps.appendChild(iconElement);
    });
}

function toggleWindow(windowId) {
    const window = taskManager.openWindows.find(w => w.id === windowId);
    if (window) {
        if (window.minimized || window.id !== taskManager.activeWindowId) {
            window.minimized = false;
            setActiveWindow(windowId);
        } else {
            minimizeWindow(windowId);
        }
    }
}

function showDesktop() {
    taskManager.openWindows.forEach(window => {
        window.minimized = true;
        window.container.style.display = 'none';
    });
    
    taskManager.activeWindowId = null;
    updateDockBar();
}

function goHome() {
    showDesktop();
    const launcher = document.getElementById('launcher');
    if (launcher) {
        launcher.classList.remove('open');
    }
    if (isSearchActive) {
        isSearchActive = false;
    }
    currentFocusArea = 'header';
    currentHeaderIndex = 0;
    currentSection = 'recent';
    updateSectionDisplay();
    updateSelection();
}

function closeAppFrame() {
    if (taskManager.activeWindowId) {
        closeWindow(taskManager.activeWindowId);
    }
}

// ========== NUEVOS CONTROLES DE DOCKBAR ==========
function initDockbarControls() {
    const dockbarHome = document.getElementById('dockbarHome');
    const dockbarMinimize = document.getElementById('dockbarMinimize');
    const dockbarBack = document.getElementById('dockbarBack');
    
    if (dockbarHome) {
        dockbarHome.addEventListener('click', function() {
            if (!isMenuOpen) {
                toggleMenu();
            }
        });
    }
    
    if (dockbarMinimize) {
        dockbarMinimize.addEventListener('click', function() {
            minimizeActiveWindow();
        });
    }
    
    if (dockbarBack) {
        dockbarBack.addEventListener('click', goBackInApp);
    }
}

// ========== SISTEMA DE SCROLL WINDOWS 10 ==========
class WindowsScroll {
    constructor(container) {
        this.container = container;
        this.content = container.querySelector('.windows-scroll-content');
        this.scrollbar = container.querySelector('.windows-scrollbar');
        this.thumb = container.querySelector('.windows-scroll-thumb');
        
        this.init();
    }
    
    init() {
        this.updateScrollbar();
        this.setupEvents();
        
        const observer = new MutationObserver(() => {
            this.updateScrollbar();
        });
        
        observer.observe(this.content, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'class']
        });
    }
    
    updateScrollbar() {
        const contentHeight = this.content.scrollHeight;
        const containerHeight = this.content.clientHeight;
        const scrollTop = this.content.scrollTop;
        
        if (contentHeight <= containerHeight) {
            this.scrollbar.style.display = 'none';
            return;
        }
        
        this.scrollbar.style.display = 'block';
        
        const thumbHeight = Math.max((containerHeight / contentHeight) * containerHeight, 20);
        const thumbPosition = (scrollTop / contentHeight) * containerHeight;
        
        this.thumb.style.height = thumbHeight + 'px';
        this.thumb.style.top = thumbPosition + 'px';
    }
    
    setupEvents() {
        this.content.addEventListener('scroll', () => {
            this.updateScrollbar();
        });
        
        window.addEventListener('resize', () => {
            this.updateScrollbar();
        });
        
        this.thumb.addEventListener('mousedown', (e) => {
            e.preventDefault();
            const startY = e.clientY;
            const startTop = parseFloat(this.thumb.style.top);
            const contentHeight = this.content.scrollHeight;
            const containerHeight = this.content.clientHeight;
            
            const onMouseMove = (e) => {
                const deltaY = e.clientY - startY;
                let newTop = startTop + deltaY;
                
                newTop = Math.max(0, Math.min(newTop, containerHeight - parseFloat(this.thumb.style.height)));
                
                this.thumb.style.top = newTop + 'px';
                this.content.scrollTop = (newTop / containerHeight) * contentHeight;
            };
            
            const onMouseUp = () => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                this.container.classList.remove('scrolling');
            };
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            this.container.classList.add('scrolling');
        });
        
        this.scrollbar.addEventListener('click', (e) => {
            if (e.target === this.scrollbar) {
                const rect = this.scrollbar.getBoundingClientRect();
                const clickY = e.clientY - rect.top;
                const contentHeight = this.content.scrollHeight;
                const containerHeight = this.content.clientHeight;
                const thumbHeight = parseFloat(this.thumb.style.height);
                
                let newTop = clickY - (thumbHeight / 2);
                newTop = Math.max(0, Math.min(newTop, containerHeight - thumbHeight));
                
                this.thumb.style.top = newTop + 'px';
                this.content.scrollTop = (newTop / containerHeight) * contentHeight;
            }
        });
        
        this.thumb.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const startY = touch.clientY;
            const startTop = parseFloat(this.thumb.style.top);
            const contentHeight = this.content.scrollHeight;
            const containerHeight = this.content.clientHeight;
            
            const onTouchMove = (e) => {
                const touch = e.touches[0];
                const deltaY = touch.clientY - startY;
                let newTop = startTop + deltaY;
                
                newTop = Math.max(0, Math.min(newTop, containerHeight - parseFloat(this.thumb.style.height)));
                
                this.thumb.style.top = newTop + 'px';
                this.content.scrollTop = (newTop / containerHeight) * contentHeight;
            };
            
            const onTouchEnd = () => {
                document.removeEventListener('touchmove', onTouchMove);
                document.removeEventListener('touchend', onTouchEnd);
                this.container.classList.remove('scrolling');
            };
            
            document.addEventListener('touchmove', onTouchMove);
            document.addEventListener('touchend', onTouchEnd);
            this.container.classList.add('scrolling');
        });
    }
}

function initWindowsScroll() {
    const scrollContainers = document.querySelectorAll('.windows-scroll-container');
    scrollContainers.forEach(container => {
        new WindowsScroll(container);
    });
}

// ========== SISTEMA DE BATER√çA Y HORA ==========
function getBatteryInfo() {
    if ('getBattery' in navigator) {
        navigator.getBattery().then(function(battery) {
            updateBatteryInfo(battery);
            
            battery.addEventListener('levelchange', function() {
                updateBatteryInfo(battery);
            });
            
            battery.addEventListener('chargingchange', function() {
                updateBatteryInfo(battery);
            });
        });
    } else {
        simulateBatteryInfo();
    }
}

function updateBatteryInfo(battery) {
    const batteryLevel = document.getElementById('batteryLevel');
    const batteryPercentage = document.getElementById('batteryPercentage');
    
    if (!batteryLevel || !batteryPercentage) return;
    
    const level = battery.level * 100;
    const isCharging = battery.charging;
    
    batteryLevel.style.width = level + '%';
    
    if (level <= 20) {
        batteryLevel.className = 'battery-level low';
    } else if (level <= 50) {
        batteryLevel.className = 'battery-level medium';
    } else {
        batteryLevel.className = 'battery-level';
    }
    
    batteryPercentage.textContent = isCharging ? '‚ö° ' + Math.round(level) + '%' : Math.round(level) + '%';
}

function simulateBatteryInfo() {
    const batteryLevel = document.getElementById('batteryLevel');
    const batteryPercentage = document.getElementById('batteryPercentage');
    
    if (!batteryLevel || !batteryPercentage) return;
    
    const level = Math.floor(Math.random() * 60) + 30;
    
    batteryLevel.style.width = level + '%';
    
    if (level <= 20) {
        batteryLevel.className = 'battery-level low';
    } else if (level <= 50) {
        batteryLevel.className = 'battery-level medium';
    } else {
        batteryLevel.className = 'battery-level';
    }
    
    batteryPercentage.textContent = level + '%';
}

function updateHeaderTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const headerTime = document.getElementById('headerTime');
    if (headerTime) {
        headerTime.textContent = timeString;
    }
}

// ========== INICIALIZACI√ìN OPTIMIZADA ==========
function ready(fn) {
    if (document.readyState != 'loading') {
        fn();
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', fn);
    } else {
        document.attachEvent('onreadystatechange', function() {
            if (document.readyState != 'loading') fn();
        });
    }
}

ready(function() {
    // Inicializar elementos globales
    appGrid = document.getElementById('appGrid');
    recentAppsContainer = document.getElementById('recentApps');
    selectedAppInfo = document.getElementById('selectedAppInfo');
    categoryButtons = document.querySelectorAll('.category-button');
    navSound = document.getElementById('navSound');
    scrollIndicator = document.getElementById('scrollIndicator');
    recentAppsEl = document.getElementById('recentApps');
    menuButton = document.getElementById('menuButton');
    sideMenu = document.getElementById('sideMenu');
    menuOverlay = document.getElementById('menuOverlay');
    menuItems = document.querySelectorAll('.menu-item');

    // Inicializar pantalla de inicio y controles de pantalla completa
    initStartupScreen();

    // Inicializar sistema de EULA
    initEULA();

    // Inicializar settings
    initSettings();

    // Cargar datos de aplicaciones
    loadAppsData().then(function(loadedData) {
        console.log('‚úÖ appData loaded successfully:', loadedData.length, 'applications');
        
        if (loadedData.length === 0) {
            console.warn('‚ö†Ô∏è appData is empty');
            showStatusMessage('Could not load applications', 'warning');
        }
        
        // Inicializar sistemas
        initWindowsScroll();
        initSectionNavigation();
        initDockbarControls();
        // El sistema de scroll integrado se inicializa autom√°ticamente en displayRecentApps()
        initAppGridScroll();
        initCategoryScroll();
        getBatteryInfo();
        updateHeaderTime();
        setInterval(updateHeaderTime, 60000);

        // Inicializar taskbar y auto-start
        initFixedProgramManager();
        autoStartProgramManager();

        // Iniciar monitoreo del Program Manager
        setTimeout(monitorProgramManagerStatus, 3000);

        // CORRECCI√ìN: Inicializar navegaci√≥n correctamente
        currentFocusArea = 'recent';
        currentSection = 'recent';
        if (recentApps.length > 0) {
            currentRecentIndex = 0;
        }
        updateSectionDisplay();
        updateSelection();

        // Event listeners del men√∫ lateral
        menuItems.forEach((item, index) => {
            item.addEventListener('click', function() {
                // CORRECCI√ìN: Minimizar todas las ventanas activas
                if (taskManager.openWindows.length > 0) {
                    taskManager.openWindows.forEach(window => {
                        minimizeWindow(window.id);
                    });
                }
                
                const category = this.getAttribute('data-category');
                
                // CORRECCI√ìN: Usar handleCategorySelection en lugar de toggleMenu directamente
                handleCategorySelection(category);
                
                // Cerrar el men√∫ despu√©s de seleccionar
                toggleMenu();
            });
        });

        // Event listeners de category buttons
        categoryButtons.forEach((button, index) => {
            button.addEventListener('click', function() {
                const category = this.getAttribute('data-category');
                handleCategorySelection(category);
            });
        });

        // Event listeners para shutdown
        const confirmShutdown = document.getElementById('confirmShutdown');
        if (confirmShutdown) {
            confirmShutdown.addEventListener('click', executeShutdown);
        }

        const cancelShutdown = document.getElementById('cancelShutdown');
        if (cancelShutdown) {
            cancelShutdown.addEventListener('click', hideShutdownConfirm);
        }

        const shutdownConfirm = document.getElementById('shutdownConfirm');
        if (shutdownConfirm) {
            shutdownConfirm.addEventListener('click', function(e) {
                if (e.target === this) {
                    hideShutdownConfirm();
                }
            });
        }

        // Configurar eventos del teclado principales
        document.addEventListener('keydown', function(e) {
            const startupScreen = document.getElementById('startupScreen');
            const eulaModal = document.getElementById('eulaModal');
            
            // PRIMERO verificar si estamos en pantalla de inicio (sin EULA activo)
            if (startupScreen && !startupScreen.classList.contains('hidden') && 
                (!eulaModal || !eulaModal.classList.contains('active'))) {
                handleWindows11StartupKeydown(e);
                return; // Salir temprano, no procesar otras teclas
            }
            
            if (isSettingsOpen) {
                handleSettingsKeydown(e);
                return;
            }
            
            if (taskManager.activeWindowId) {
                if (e.key === 'Escape') {
                    closeAppFrame();
                }
                return;
            }
            
            if (document.getElementById('shutdownConfirm').classList.contains('active')) {
                handleShutdownKeydown(e);
                return;
            }
            
            if (document.getElementById('uninstallConfirm').classList.contains('active')) {
                handleConfirmKeydown(e);
                return;
            }
            
            if (isModalOpen) {
                handleModalKeydown(e);
                return;
            }
            
            if (isSearchActive) {
                handleLauncherKeydown(e);
                return;
            }
            
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                keyboardEnabled = !keyboardEnabled;
                showStatusMessage(keyboardEnabled ? 'Keyboard navigation enabled' : 'Keyboard navigation disabled', 
                                 keyboardEnabled ? 'success' : 'warning');
                return;
            }
            
            if (!keyboardEnabled) return;
            
            switch(e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    playNavSound();
                    handleUpArrow();
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    playNavSound();
                    handleDownArrow();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    playNavSound();
                    handleLeftArrow();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    playNavSound();
                    handleRightArrow();
                    break;
                case 'Enter':
                    e.preventDefault();
                    playNavSound();
                    handleEnter();
                    break;
                case 'Escape':
                    e.preventDefault();
                    playNavSound();
                    handleEscape();
                    break;
            }
        });

        // Configurar eventos de UI
        if (scrollIndicator && recentAppsEl) {
            scrollIndicator.addEventListener('click', function() {
                recentAppsEl.scrollLeft += 200;
                setTimeout(updateScrollArrows, 300);
            });

            recentAppsEl.addEventListener('scroll', function() {
                if (!isScrolling) {
                    isScrolling = true;
                    setTimeout(function() {
                        updateScrollArrows();
                        isScrolling = false;
                    }, 100);
                }
            });
        }

        if (menuButton) {
            menuButton.addEventListener('click', function() {
                playNavSound();
                toggleMenu();
            });
        }

        if (menuOverlay) {
            menuOverlay.addEventListener('click', function() {
                playNavSound();
                toggleMenu();
            });
        }

        // Configurar b√∫squeda y launcher
        const searchToggle = document.getElementById('searchToggle');
        if (searchToggle) {
            searchToggle.addEventListener('click', toggleLauncher);
        }

        const launcherSearch = document.getElementById('launcherSearch');
        if (launcherSearch) {
            launcherSearch.addEventListener('input', searchLauncher);
        }

        // ========== BOT√ìN ABOUT US EN PANTALLA DE INICIO ==========
        const aboutStartupButton = document.getElementById('aboutStartupButton');
        if (aboutStartupButton) {
            aboutStartupButton.addEventListener('click', function() {
                window.location.href = 'about.html';
            });
            
            aboutStartupButton.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    window.location.href = 'about.html';
                }
            });
        }

        const confirmUninstall = document.getElementById('confirmUninstall');
        if (confirmUninstall) {
            confirmUninstall.addEventListener('click', function() {
                if (currentUninstallApp) {
                    uninstallApp(currentUninstallApp);
                }
            });
        }

        const cancelUninstall = document.getElementById('cancelUninstall');
        if (cancelUninstall) {
            cancelUninstall.addEventListener('click', hideUninstallConfirm);
        }

        const uninstallConfirm = document.getElementById('uninstallConfirm');
        if (uninstallConfirm) {
            uninstallConfirm.addEventListener('click', function(e) {
                if (e.target === this) {
                    hideUninstallConfirm();
                }
            });
        }

        document.addEventListener('click', function(e) {
            const launcher = document.getElementById('launcher');
            const homeBtn = document.getElementById('dockbarHome');
            const launcherClose = document.querySelector('.launcher-close');
            const searchToggle = document.getElementById('searchToggle');
            
            if (launcher && !launcher.contains(e.target) && 
                homeBtn && !homeBtn.contains(e.target) && 
                launcherClose && !launcherClose.contains(e.target) &&
                searchToggle && !searchToggle.contains(e.target) &&
                launcher.classList.contains('open')) {
                toggleLauncher();
            }
        });

        document.addEventListener('scroll', function() {
            const dockbar = document.querySelector('.dockbar');
            if (dockbar) {
                dockbar.style.zIndex = '2500';
            }
        });

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('appModal');
            if (event.target === modal) {
                modal.style.display = 'none';
                isModalOpen = false;
                currentModalActionIndex = 0;
            }
        });

        // Mostrar aplicaciones iniciales
        displayApps(appData);
        displayRecentApps();
        if (recentApps.length > 0) {
            currentRecentIndex = 0;
            updateSelection();
        }
        
    }).catch(function(error) {
        console.error('‚ùå Critical error loading appData:', error);
        if (appGrid) {
            appGrid.innerHTML = `
                <div class="error-message">
                    <p>Error loading applications</p>
                    <p style="font-size: 14px; margin-top: 10px;">
                        Verify that apps-data.js is in the same folder
                    </p>
                    <button onclick="location.reload()" 
                            style="margin-top: 15px; padding: 8px 16px; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Retry
                    </button>
                </div>
            `;
        }
        showStatusMessage('Error loading applications', 'error');
    });
});

// ========== POLYFILL PARA SCROLL BEHAVIOR SMOOTH ==========
if (!('scrollBehavior' in document.documentElement.style)) {
    const smoothScrollPolyfill = function() {
        const supportsScrollBehavior = 'scrollBehavior' in document.documentElement.style;
        
        if (!supportsScrollBehavior) {
            const originalScrollTo = window.scrollTo;
            const originalScrollBy = window.scrollBy;
            const originalElementScrollTo = Element.prototype.scrollTo;
            const originalElementScrollBy = Element.prototype.scrollBy;
            
            // Polyfill para window.scrollTo
            window.scrollTo = function(options) {
                if (typeof options === 'object' && options.behavior === 'smooth') {
                    const start = window.pageYOffset;
                    const end = options.top !== undefined ? options.top : start;
                    const duration = 500;
                    
                    const startTime = performance.now();
                    
                    function animateScroll(currentTime) {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        window.scrollTo(0, start + (end - start) * progress);
                        
                        if (progress < 1) {
                            requestAnimationFrame(animateScroll);
                        }
                    }
                    
                    requestAnimationFrame(animateScroll);
                } else {
                    originalScrollTo.apply(this, arguments);
                }
            };
            
            // Polyfill para Element.prototype.scrollTo
            Element.prototype.scrollTo = function(options) {
                if (typeof options === 'object' && options.behavior === 'smooth') {
                    const start = this.scrollTop;
                    const end = options.top !== undefined ? options.top : start;
                    const duration = 500;
                    
                    const startTime = performance.now();
                    
                    const animateScroll = (currentTime) => {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        this.scrollTop = start + (end - start) * progress;
                        
                        if (progress < 1) {
                            requestAnimationFrame(animateScroll);
                        }
                    };
                    
                    requestAnimationFrame(animateScroll);
                } else {
                    originalElementScrollTo.apply(this, arguments);
                }
            };
            
            // Polyfill para Element.prototype.scrollBy
            Element.prototype.scrollBy = function(options) {
                if (typeof options === 'object' && options.behavior === 'smooth') {
                    const start = this.scrollTop;
                    const end = start + (options.top || 0);
                    const duration = 500;
                    
                    const startTime = performance.now();
                    
                    const animateScroll = (currentTime) => {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        this.scrollTop = start + (end - start) * progress;
                        
                        if (progress < 1) {
                            requestAnimationFrame(animateScroll);
                        }
                    };
                    
                    requestAnimationFrame(animateScroll);
                } else {
                    originalElementScrollBy.apply(this, arguments);
                }
            };
        }
    };
    
    // Ejecutar el polyfill
    smoothScrollPolyfill();
}

// Polyfills para compatibilidad
if (!Array.prototype.forEach) {
    Array.prototype.forEach = function(callback, thisArg) {
        var T, k;
        if (this == null) {
            throw new TypeError(' this is null or not defined');
        }
        var O = Object(this);
        var len = O.length >>> 0;
        if (typeof callback !== 'function') {
            throw new TypeError(callback + ' is not a function');
        }
        if (arguments.length > 1) {
            T = thisArg;
        }
        k = 0;
        while (k < len) {
            var kValue;
            if (k in O) {
                kValue = O[k];
                callback.call(T, kValue, k, O);
            }
            k++;
        }
    };
}

if (!NodeList.prototype.forEach) {
    NodeList.prototype.forEach = Array.prototype.forEach;
}

if (!String.prototype.includes) {
    String.prototype.includes = function(search, start) {
        if (typeof start !== 'number') {
            start = 0;
        }
        if (start + search.length > this.length) {
            return false;
        } else {
            return this.indexOf(search, start) !== -1;
        }
    };
}
</script>
</body>
</html>