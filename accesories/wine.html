<!doctype html>
<html lang="en-us">
  <head>
		<meta http-equiv="x-ua-compatible" content="IE=edge">
		<title>WineBOX</title>
		<!--[if IE]><style>#targetIE {margin-left:-2.5px;}</style><![endif]-->
		<link rel="stylesheet" href="lib/style.css"/>
     		<link rel="stylesheet" type="text/css" href="wine.css">
		<link rel="stylesheet" href="lib/scrollbar.css"/>
		<link rel="shortcut icon" href="favicon.ico"/>
    		<script src="lib/jquery-1.8.0.min.js" type="text/javascript"></script>
    		<script src="lib/jquery-ui-1.8.23.min.js" type="text/javascript"></script>

    <!-- Estilos del teclado virtual -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .virtual-keyboard-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 15, 35, 0.98);
            border-radius: 15px 15px 0 0;
            padding: 15px;
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: none;
            z-index: 10000;
            display: none;
        }

        .keyboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .keyboard-title {
            color: #00ffcc;
            font-size: 14px;
            font-weight: bold;
        }

        .close-keyboard {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .keyboard {
            background: linear-gradient(135deg, #1e1e3f 0%, #2d2b55 100%);
            border-radius: 10px;
            padding: 15px;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            margin-bottom: 8px;
            gap: 4px;
        }

        .key {
            background: linear-gradient(135deg, #3c3c5a 0%, #2a2a4a 100%);
            color: #ffffff;
            border: none;
            border-radius: 6px;
            padding: 12px 0;
            min-width: 50px;
            height: 50px;
            cursor: pointer;
            transition: all 0.1s ease;
            font-weight: 600;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 3px 0 #1a1a35,
                0 4px 6px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            user-select: none;
        }

        .key:hover {
            background: linear-gradient(135deg, #4c4c6a 0%, #3a3a5a 100%);
            transform: translateY(-1px);
        }

        .key:active {
            transform: translateY(2px);
            box-shadow: 
                0 1px 0 #1a1a35,
                0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .key-wide {
            min-width: 70px;
        }

        .key-extra-wide {
            min-width: 90px;
        }

        .key-ultra-wide {
            min-width: 200px;
        }

        .key-special {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }

        .key-utility {
            background: linear-gradient(135deg, #45b7d1 0%, #3a92ab 100%);
        }

        .key-space {
            background: linear-gradient(135deg, #96ceb4 0%, #7ab89c 100%);
            min-width: 150px;
        }

        .key-sub {
            font-size: 9px;
            opacity: 0.7;
            margin-top: 1px;
        }

        .key-shift-active {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            color: #2d3436;
        }

        .key-caps-active {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            color: white;
        }

        /* Estilos para cuando el teclado está activo */
        .keyboard-active #canvas {
            margin-bottom: 300px;
            transition: margin-bottom 0.3s ease;
        }

        .keyboard-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #4ecdc4;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
    </style>
  </head>
  <body>

  <!-- Botón para mostrar/ocultar teclado -->
  <button class="keyboard-toggle" onclick="toggleVirtualKeyboard()">⌨️</button>

  <!-- Teclado Virtual -->
  <div class="virtual-keyboard-container" id="virtualKeyboard">
      <div class="keyboard-header">
          <div class="keyboard-title">Teclado Virtual</div>
          <button class="close-keyboard" onclick="toggleVirtualKeyboard()">Cerrar</button>
      </div>
      <div class="keyboard">
          <!-- Fila de números -->
          <div class="keyboard-row">
              <div class="key" data-key="`">`<div class="key-sub">~</div></div>
              <div class="key" data-key="1">1<div class="key-sub">!</div></div>
              <div class="key" data-key="2">2<div class="key-sub">@</div></div>
              <div class="key" data-key="3">3<div class="key-sub">#</div></div>
              <div class="key" data-key="4">4<div class="key-sub">$</div></div>
              <div class="key" data-key="5">5<div class="key-sub">%</div></div>
              <div class="key" data-key="6">6<div class="key-sub">^</div></div>
              <div class="key" data-key="7">7<div class="key-sub">&</div></div>
              <div class="key" data-key="8">8<div class="key-sub">*</div></div>
              <div class="key" data-key="9">9<div class="key-sub">(</div></div>
              <div class="key" data-key="0">0<div class="key-sub">)</div></div>
              <div class="key" data-key="-">-<div class="key-sub">_</div></div>
              <div class="key" data-key="=">=<div class="key-sub">+</div></div>
              <div class="key key-wide key-utility" data-key="Backspace">⌫</div>
          </div>

          <!-- Fila QWERTY -->
          <div class="keyboard-row">
              <div class="key key-wide key-utility" data-key="Tab">Tab</div>
              <div class="key" data-key="q">Q</div>
              <div class="key" data-key="w">W</div>
              <div class="key" data-key="e">E</div>
              <div class="key" data-key="r">R</div>
              <div class="key" data-key="t">T</div>
              <div class="key" data-key="y">Y</div>
              <div class="key" data-key="u">U</div>
              <div class="key" data-key="i">I</div>
              <div class="key" data-key="o">O</div>
              <div class="key" data-key="p">P</div>
              <div class="key" data-key="[">[<div class="key-sub">{</div></div>
              <div class="key" data-key="]">]<div class="key-sub">}</div></div>
              <div class="key" data-key="\">\<div class="key-sub">|</div></div>
          </div>

          <!-- Fila ASDF -->
          <div class="keyboard-row">
              <div class="key key-wide key-utility" data-key="CapsLock" id="capsLock">Caps</div>
              <div class="key" data-key="a">A</div>
              <div class="key" data-key="s">S</div>
              <div class="key" data-key="d">D</div>
              <div class="key" data-key="f">F</div>
              <div class="key" data-key="g">G</div>
              <div class="key" data-key="h">H</div>
              <div class="key" data-key="j">J</div>
              <div class="key" data-key="k">K</div>
              <div class="key" data-key="l">L</div>
              <div class="key" data-key=";">;<div class="key-sub">:</div></div>
              <div class="key" data-key="'">'<div class="key-sub">"</div></div>
              <div class="key key-wide key-utility" data-key="Enter">↵</div>
          </div>

          <!-- Fila ZXCV -->
          <div class="keyboard-row">
              <div class="key key-extra-wide key-special" data-key="Shift" id="shiftKey">Shift</div>
              <div class="key" data-key="z">Z</div>
              <div class="key" data-key="x">X</div>
              <div class="key" data-key="c">C</div>
              <div class="key" data-key="v">V</div>
              <div class="key" data-key="b">B</div>
              <div class="key" data-key="n">N</div>
              <div class="key" data-key="m">M</div>
              <div class="key" data-key=",">,<div class="key-sub"><</div></div>
              <div class="key" data-key=".">.<div class="key-sub">></div></div>
              <div class="key" data-key="/">/<div class="key-sub">?</div></div>
              <div class="key key-extra-wide key-special" data-key="Shift" id="shiftKeyRight">Shift</div>
          </div>

          <!-- Fila de espacio -->
          <div class="keyboard-row">
              <div class="key key-special" data-key="Control">Ctrl</div>
              <div class="key key-special" data-key="Alt">Alt</div>
              <div class="key key-space" data-key=" ">Espacio</div>
              <div class="key key-special" data-key="Alt">Alt</div>
              <div class="key key-special" data-key="Control">Ctrl</div>
          </div>
      </div>
  </div>

  <!-- if running inline add style="display: none" to id="loading" and id="inline" and remove same from id="run-inline" -->
  <div id="loading">
      <figure id="spinner" style="overflow: visible;">
         <div class="spinner" style="margin-top: .5em; margin-left: auto; margin-right: auto;"></div>
	  </figure>
      <div class="emscripten" id="status"></div>
  </div>
    <div id="run-inline" style="display: none">
        <button id="inline-runbtn" onclick="startInline()">inline</button>
    </div>

    <div id="inline">
        <div class="emscripten">
            <button id="saveFSImage" style="display: none" onclick="saveFSImage()">Save FS Image</button>         
            <button id="startbtn" style="display: none" onclick="start()">Start</button>
            <button id="uploadbtn" style="display: none" onclick="document.getElementById('upload').click()" >Add File(s)</button>
            <input style="display: none" id="upload" name="upload" onclick="document.getElementById('uploadbtn').click();" onchange="startWithFiles(event.target.files);"  type="file" multiple />
            <button id="downloadbtn" style="display: none" onclick="buildTree();">Get File(s)</button>
            <a style="display: none" id="modalLink" href="#openModal">Open</a>
            <a style="display: none" id="modalLinkExe" href="#openModalExe">Open</a>

          <span id="sound-checkbox" style="display: none">
              <input type="checkbox" id="soundToggle" onclick="toggleSound();" />Enable Sound
          </span>
          <input style="display: none" id="pointerLock" unchecked>
          <!-- input type="checkbox" id="showConsole" onclick="toggleConsoleAndKeyboard();" unchecked -->
          <input style="display: none" id="showConsole" onclick="toggleConsoleAndKeyboard();" unchecked>
          <!-- input type="checkbox" id="resize" -->
          <!-- input type="checkbox" id="fullscreen" onclick="Module.requestFullScreen(document.getElementById('pointerLock').checked, document.getElementById('resize').checked)" checked -->
        </div>
        <div id="dropzone">
            <div class="emscripten_border">
                <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
            </div>
        </div>
        <div>
            <textarea class="emscripten" id="output" rows="8" style="display: none"></textarea>
        </div>
        <div id="openModal" class="modalDialog">
            <div> <a href="#close" title="Close" class="close" onclick="done();">X</a>
                <div>
                    <h3>Get File(s)</h3>
                    <input id="selectedItem" type="text" size="50" readonly>
                    <button onclick="extract();">Get</button>
                </div>
                <div id="tree" class="scroll-style">
                </div>
                <div>
                    <h3 id="loadStatus">Loading...</h3>
                </div>
            </div>
        </div>
        <div id="openModalExe" class="modalDialog">
            <div> <a id="openModalExeClick" href="#close" title="Close" class="close">X</a>
                <div>
                    <h3>Execute</h3>
                    <div id="message"></div>
                    <div id="items" class="scroll-style"></div>
                </div>
            </div>
        </div>
        <hr>
    </div>
        <script src="fat.js"></script>
        <script src="jszip.js"></script>
        <script src="shell.js"></script>

        <!-- Script del teclado virtual -->
        <script>
            let isShiftActive = false;
            let isCapsActive = false;
            
            // Mapeo de teclas para el modo shift
            const shiftMap = {
                '`': '~', '1': '!', '2': '@', '3': '#', '4': '$', '5': '%', 
                '6': '^', '7': '&', '8': '*', '9': '(', '0': ')', '-': '_', 
                '=': '+', '[': '{', ']': '}', '\\': '|', ';': ':', "'": '"', 
                ',': '<', '.': '>', '/': '?',
                'a': 'A', 'b': 'B', 'c': 'C', 'd': 'D', 'e': 'E', 'f': 'F',
                'g': 'G', 'h': 'H', 'i': 'I', 'j': 'J', 'k': 'K', 'l': 'L',
                'm': 'M', 'n': 'N', 'o': 'O', 'p': 'P', 'q': 'Q', 'r': 'R',
                's': 'S', 't': 'T', 'u': 'U', 'v': 'V', 'w': 'W', 'x': 'X',
                'y': 'Y', 'z': 'Z'
            };

            // Mapeo de keyCodes para eventos de teclado
            const keyCodeMap = {
                '`': 192, '1': 49, '2': 50, '3': 51, '4': 52, '5': 53,
                '6': 54, '7': 55, '8': 56, '9': 57, '0': 48, '-': 173,
                '=': 61, '[': 219, ']': 221, '\\': 220, ';': 186, "'": 222,
                ',': 188, '.': 190, '/': 191, ' ': 32,
                'a': 65, 'b': 66, 'c': 67, 'd': 68, 'e': 69, 'f': 70,
                'g': 71, 'h': 72, 'i': 73, 'j': 74, 'k': 75, 'l': 76,
                'm': 77, 'n': 78, 'o': 79, 'p': 80, 'q': 81, 'r': 82,
                's': 83, 't': 84, 'u': 85, 'v': 86, 'w': 87, 'x': 88,
                'y': 89, 'z': 90
            };

            // Mapeo de teclas especiales
            const specialKeyCodes = {
                'Backspace': 8,
                'Tab': 9,
                'Enter': 13,
                'Shift': 16,
                'Control': 17,
                'Alt': 18,
                'CapsLock': 20,
                'Escape': 27
            };

            function toggleVirtualKeyboard() {
                const keyboard = document.getElementById('virtualKeyboard');
                const isVisible = keyboard.style.display === 'block';
                
                if (isVisible) {
                    keyboard.style.display = 'none';
                    document.body.classList.remove('keyboard-active');
                } else {
                    keyboard.style.display = 'block';
                    document.body.classList.add('keyboard-active');
                }
            }

            function toggleConsoleAndKeyboard() {
                const consoleEl = document.getElementById('output');
                const showConsole = document.getElementById('showConsole');
                
                if (showConsole.checked) {
                    consoleEl.style.display = '';
                    // Mostrar teclado cuando se muestra la consola
                    document.getElementById('virtualKeyboard').style.display = 'block';
                    document.body.classList.add('keyboard-active');
                } else {
                    consoleEl.style.display = 'none';
                    // Ocultar teclado cuando se oculta la consola
                    document.getElementById('virtualKeyboard').style.display = 'none';
                    document.body.classList.remove('keyboard-active');
                }
            }

            function sendKeyToEmulator(key, isSpecialKey = false) {
                const canvas = document.getElementById('canvas');
                if (!canvas) return;

                let keyCode;
                let keyValue = key;

                // Determinar el keyCode
                if (isSpecialKey) {
                    keyCode = specialKeyCodes[key] || 0;
                } else {
                    // Aplicar transformaciones de shift/caps
                    if (isShiftActive && shiftMap[key]) {
                        keyValue = shiftMap[key];
                    } else if (isCapsActive && key.match(/[a-z]/)) {
                        keyValue = key.toUpperCase();
                    }
                    keyCode = keyCodeMap[key] || keyValue.charCodeAt(0);
                }

                // Crear y disparar evento keydown
                const keyDownEvent = new KeyboardEvent('keydown', {
                    key: keyValue,
                    code: 'Key' + (key.length === 1 ? key.toUpperCase() : key),
                    keyCode: keyCode,
                    which: keyCode,
                    bubbles: true,
                    cancelable: true
                });

                // Crear y disparar evento keypress (para caracteres)
                if (!isSpecialKey && key.length === 1) {
                    const keyPressEvent = new KeyboardEvent('keypress', {
                        key: keyValue,
                        code: 'Key' + key.toUpperCase(),
                        keyCode: keyValue.charCodeAt(0),
                        charCode: keyValue.charCodeAt(0),
                        which: keyValue.charCodeAt(0),
                        bubbles: true,
                        cancelable: true
                    });
                    
                    canvas.dispatchEvent(keyPressEvent);
                }

                // Disparar keydown
                canvas.dispatchEvent(keyDownEvent);

                // Crear y disparar evento keyup después de un breve delay
                setTimeout(() => {
                    const keyUpEvent = new KeyboardEvent('keyup', {
                        key: keyValue,
                        code: 'Key' + (key.length === 1 ? key.toUpperCase() : key),
                        keyCode: keyCode,
                        which: keyCode,
                        bubbles: true,
                        cancelable: true
                    });
                    canvas.dispatchEvent(keyUpEvent);
                }, 50);

                // También escribir en la consola de debug para feedback
                const output = document.getElementById('output');
                if (output && output.style.display !== 'none') {
                    if (key === 'Backspace') {
                        output.value = output.value.slice(0, -1);
                    } else if (key === 'Enter') {
                        output.value += '\n';
                    } else if (key === 'Tab') {
                        output.value += '    ';
                    } else if (!isSpecialKey || key === ' ') {
                        output.value += keyValue;
                    }
                    output.scrollTop = output.scrollHeight;
                }

                console.log(`Tecla enviada al emulador: ${keyValue} (keyCode: ${keyCode})`);
            }

            function handleSpecialKey(key) {
                switch(key) {
                    case 'Backspace':
                        sendKeyToEmulator('Backspace', true);
                        break;
                    case 'Enter':
                        sendKeyToEmulator('Enter', true);
                        break;
                    case 'Tab':
                        sendKeyToEmulator('Tab', true);
                        break;
                    case ' ':
                        sendKeyToEmulator(' ', false);
                        break;
                    case 'Shift':
                        toggleShift();
                        break;
                    case 'CapsLock':
                        toggleCaps();
                        break;
                    case 'Control':
                        sendKeyToEmulator('Control', true);
                        break;
                    case 'Alt':
                        sendKeyToEmulator('Alt', true);
                        break;
                }
            }

            function toggleShift() {
                isShiftActive = !isShiftActive;
                const shiftKey = document.getElementById('shiftKey');
                const shiftKeyRight = document.getElementById('shiftKeyRight');
                
                if (shiftKey) shiftKey.classList.toggle('key-shift-active', isShiftActive);
                if (shiftKeyRight) shiftKeyRight.classList.toggle('key-shift-active', isShiftActive);
            }

            function toggleCaps() {
                isCapsActive = !isCapsActive;
                const capsLock = document.getElementById('capsLock');
                if (capsLock) capsLock.classList.toggle('key-caps-active', isCapsActive);
            }

            // Inicializar event listeners para las teclas
            document.addEventListener('DOMContentLoaded', function() {
                const keys = document.querySelectorAll('.key');
                
                keys.forEach(key => {
                    key.addEventListener('click', function() {
                        const keyValue = this.getAttribute('data-key');
                        
                        // Si es una tecla especial
                        if (this.classList.contains('key-special') || 
                            this.classList.contains('key-utility')) {
                            handleSpecialKey(keyValue);
                        } 
                        // Si es una tecla normal
                        else {
                            sendKeyToEmulator(keyValue, false);
                            
                            // Desactivar shift después de una tecla normal
                            if (isShiftActive && keyValue !== 'Shift') {
                                toggleShift();
                            }
                        }
                    });
                });

                // Asegurarse de que el canvas pueda recibir eventos de teclado
                const canvas = document.getElementById('canvas');
                if (canvas) {
                    canvas.setAttribute('tabindex', '0');
                    canvas.focus();
                    
                    // Re-enfocar el canvas cuando se hace clic en cualquier lugar
                    document.addEventListener('click', function() {
                        canvas.focus();
                    });
                }
            });

            // Sobrescribir la función toggleConsole original
            const originalToggleConsole = window.toggleConsole;
            window.toggleConsole = function() {
                toggleConsoleAndKeyboard();
            };

            // Función global para que otros scripts puedan usar el teclado
            window.virtualKeyboard = {
                show: function() {
                    document.getElementById('virtualKeyboard').style.display = 'block';
                    document.body.classList.add('keyboard-active');
                },
                hide: function() {
                    document.getElementById('virtualKeyboard').style.display = 'none';
                    document.body.classList.remove('keyboard-active');
                },
                toggle: toggleVirtualKeyboard,
                sendKey: sendKeyToEmulator
            };
        </script>

        <script>
        function startInline() {
            document.getElementById('run-inline').style.display = 'none';
            document.getElementById('loading').style.display = '';
            Config.isRunningInline = true;
            Config.urlParams = "p=dock";
            var script = document.createElement('script');
            script.src = "kernel.js";
            document.body.appendChild(script);
        }
        function addDefaultOnDemand(params) {
        	if(! params.includes("root=") &&  ! params.includes("ondemand=")) {
        		if(params.length >0) {
        			params = params + "&";
        		}
        		params = params + "ondemand=root&root=dlls&inline-default-ondemand-root-overlay=dlls";
        	}
        	return params;
        }
        </script>
        <script async type="text/javascript" src="kernel.js"></script>

  </body>
</html>